---
title: "Hypertension and brain volumes UKBB"
author: "Danielle Newby"
date: "20/05/2020"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Are brain volumes related to cogntive decline and neurodegeneration affected by hypertension?

Hypertension increases risk of cognitive decline and dementia. What we dont know is: 

  1) Are there differences between isolated systolic and diastolic blood pressure with brain volumes
  2) Are there differences between people who have high isolated systolic or diastolic blood pressure with people who have both high systolic and diastolic blood pressure
  3) Is this difference different between 1 and 2 also difference between those taking bp medications and those who do not?
  
In this analysis we will explore the differences between isolated blood pressure with brain volumes using the UKBB cohort.

**VERSION 1** Starting analysis for isolated hypertension
**VERSION 2** updating to include extra brain volumes (averaging L & R), including FA, MD variables
**VERSION 3** updating to include analysis with and without people with neurological conditions and only using second bp measurement

```{r packages, echo = FALSE, message = FALSE, warning = FALSE}

rm(list = ls())
library(data.table)
library(ggplot2)
library(RSQLite)
library(sqldf)
library(vroom)
library(tictoc)
library(forcats)
library(dplyr)
library(gtools)
library(devtools)
library(ukbtools)
library(lubridate)
library(twang)
library(tableone)
library(knitr)
library(kableExtra)
library(VennDiagram)
library(patchwork)
library(lmtest)
library(QuantPsyc)
library(compareGroups)
library(textutils)
library(lavaan)
library(tidyr)

#where to save data
saving_directory <- "C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/"


# Gets the populations of people with the diseases listed in codes_jD
findCases = function( codes_jD, epi_iSiC ) {
  
  # Build populations
  print( "Building populations for disease list A" );
  library( parallel )
  bCase_iSiD <- array( data = NA,
                       dim = c( dim( epi_iSiC )[1], length( codes_jD ) ),
                       dimnames = list( subject = dimnames( epi_iSiC )[[1]],
                                        disease = names( codes_jD ) ) );
  cl <- makeCluster( getOption( "cl.cores", 
                                4 ) );
  clusterExport( cl = cl,
                 varlist = c( "codes_jD" ),
                 envir = environment() );
  for( iD in 1:length( codes_jD ) ){
    # Select population
    print( "Extracting population with ", names( codes_jD )[iD]) #names( codes_jD )[iD] ) );
    clusterExport( cl = cl,
                   varlist = c( "iD" ),
                   envir = environment() );
    bCase_iS <- parApply( cl = cl,
                          X = epi_iSiC,
                          MARGIN = 1,
                          FUN = function( e_iC ){
                            any( !is.na( match( codes_jD[[iD]],
                                                e_iC ) ) );
                          } );
    bCase_iSiD[ ,iD] <- bCase_iS;
  }
  stopCluster( cl );
  
  # Return results
  return( bCase_iSiD );
  
}
 

# for analysis with 4 categories
model_IH <- function(
  outcome,
  exposure,
  data,
  brainvol,
  ref,
  exposurelevels
  ){
  
  model <- glm(outcome ~ exposure + 
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               f.25000_Volumetric_scaling_T1_head_space +
                Townsend_deciles +
               
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition` ,
  
  data = data , family = gaussian
)

model1 <- summary(model)$coefficients
model1_confint <- na.omit(confint(model))
model1 <- cbind(model1, model1_confint)
model1 <- as.data.frame(model1)

## add in FDR correction
model1$`Pr(>|t|)` <- p.adjust(model1$`Pr(>|t|)`, method = "fdr", n = nrow(model1) )
model1$n <- rep(nobs(model), nrow(model1))
model1$`t value` <- NULL
model1$`Std. Error` <- NULL
model1 <- model1[1:4,]
model1[1,] <- c(0, 1, 0, 0, model1$n[2])
model1[5,] <- NA

model1$Description <- c(ref, 
  exposurelevels,
  paste(brainvol, " (n =",model1$n[1],")", sep = "")
)

model1 <- model1[,c(6,1,3,4,2)]
model1 <- model1[c(5,1,3,2,4),]
model1$ref <- c(NA, "REF", NA, NA, NA)
rownames(model1) <- NULL

return(model1)
  
}



#for analysis with 6 categories normotensive, NIH and IH

model_IH_all <- function(
  outcome,
  exposure,
  data,
  brainvol,
  ref,
  exposurelevels
  ){
  
  model <- glm(outcome ~ exposure + 
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               f.25000_Volumetric_scaling_T1_head_space +
                 Townsend_deciles +
               
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition` ,
  
  data = data , family = gaussian
)

model1 <- summary(model)$coefficients
model1_confint <- na.omit(confint(model))
model1 <- cbind(model1, model1_confint)
model1 <- as.data.frame(model1)

## add in FDR correction
model1$`Pr(>|t|)` <- p.adjust(model1$`Pr(>|t|)`, method = "fdr", n = nrow(model1) )
model1$n <- rep(nobs(model), nrow(model1))
model1$`t value` <- NULL
model1$`Std. Error` <- NULL
model1 <- model1[1:6,]
model1[1,] <- c(0, 1, 0, 0, model1$n[2])
model1[7,] <- NA

model1$Description <- c(ref, 
  exposurelevels,
  paste(brainvol, " (n =",model1$n[1],")", sep = "")
)

model1 <- model1[,c(6,1,3,4,2)]
model1 <- model1[c(7,1,6,2,3,4,5),] #
model1$ref <- c(NA, "REF", NA, NA, NA, NA, NA)
rownames(model1) <- NULL

return(model1)
  
  }

```

### Pre processing the UKBiobank dataset

**STEP 1** Read in the MRI data from UKBB
```{r loadUKBB , echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

setDTthreads(0L)

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", header=TRUE, nrows = 0)

# get column names for imaging
bdtest <- bd[,grep("[0-9]{1,10}\\-[2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]

# we are interested in Category 110 Brain MRI imaging from T1 structural brain MRI
# no normalised to head size variables included

##########################################################################
# BRAIN IMAGING VARIABLES #
###########################################################################

colwewant <- c("eid",   ## id
               "^53\\-",
               "^25000\\-"   ,      #Volumetric scaling from T1 head image to standard space
               "^25010\\-"   ,      #Volume of brain, grey+white matter
               "^25009\\-" ,#Volume of brain, grey+white matter (normalised for head size)
               "^25008\\-"   ,      #Volume of white matter
               "^25007\\-"   ,      #Volume of white matter (normalised for head size)
               "^25006\\-"   ,      #Volume of grey matter
               "^25005\\-"   ,      #Volume of grey matter (normalised for head size)
               "^25002\\-"   ,      #Volume of peripheral cortical grey matter
               "^25001\\-"   ,      #Volume of peripheral cortical grey matter (normalised for head size)
               "^25004\\-"   ,      #Volume of ventricular cerebrospinal fluid
               "^25003\\-"   ,      #Volume of ventricular cerebrospinal fluid (normalised for head size)
               "^25886\\-"   ,      #Volume of grey matter in Hippocampus (left)
               "^25887\\-"   ,      #Volume of grey matter in Hippocampus (right)
               # "25781\\-"   ,      #white matter hyperintensitiy (dont have access to)
               "^25139\\-"   ,    #Mean MD in cingulum cingulate gyrus on FA skeleton L
               "^25138\\-"  ,   #Mean MD in cingulum cingulate gyrus on FA skeleton (right)
               "^25091\\-"   ,         #	Mean FA in cingulum cingulate gyrus on FA skeleton (left)
               "^25090\\-"    ,            # Mean FA in cingulum cingulate gyrus on FA skeleton (right)
               "^25093\\-"    ,        # Mean FA in cingulum hippocampus on FA skeleton (left)
               "^25092\\-"    ,           #Mean FA in cingulum hippocampus on FA skeleton (right)
               "^25141\\-"    ,   #	Mean MD in cingulum hippocampus on FA skeleton (left)
               "^25140\\-"    , #	Mean MD in cingulum hippocampus on FA skeleton (right)
               "^25023\\-"   ,      #Volume of accumbens (left)
               "^25024\\-"   ,      #Volume of accumbens (right)
               "^25021\\-"   ,      #Volume of amygdala (left)
               "^25022\\-"   ,      #Volume of amygdala (right)
               "^25013\\-"   ,      #Volume of caudate (left)
               "^25014\\-"   ,      #Volume of caudate (right)
               "^25019\\-"   ,      #Volume of hippocampus (left)
               "^25020\\-"   ,      #Volume of hippocampus (right)
               "^25017\\-"   ,      #Volume of pallidum (left)
               "^25018\\-"   ,      #Volume of pallidum (right)
               "^25015\\-"   ,      #Volume of putamen (left)
               "^25016\\-"   ,      #Volume of putamen (right)
               "^25011\\-"   ,      #Volume of thalamus (left)
               "^25012\\-"     ,  #Volume of thalamus (right)
               "^25738\\-"	,#Discrepancy between SWI brain image and T1 brain image
               "^25038\\-"	,#Median T2star in accumbens (left)
               "^25039\\-"	,#Median T2star in accumbens (right)
               "^25036\\-"	,#Median T2star in amygdala (left)
               "^25037\\-"	,#Median T2star in amygdala (right)
               "^25028\\-"	,#Median T2star in caudate (left)
               "^25029\\-"	,#Median T2star in caudate (right)
               "^25034\\-"	,#Median T2star in hippocampus (left)
               "^25035\\-"	,#Median T2star in hippocampus (right)
               "^25032\\-"	,#Median T2star in pallidum (left)
               "^25033\\-"	,#Median T2star in pallidum (right)
               "^25030\\-"	,#Median T2star in putamen (left)
               "^25031\\-"	,#Median T2star in putamen (right)
               "^25026\\-"	,#Median T2star in thalamus (left)
               "^25027\\-"	#Median T2star in thalamus (right)
               
)


               
bdtest3 <- unique(grep(paste(colwewant, collapse ="|"),
                                      bdtest, value = TRUE, fixed = FALSE ))
               
              
               
tic()
# read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
brain_imaging_rawdata <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               #fill = FALSE ,
                               #quote = "",
                               #nrows = 1000 ,
                               #nrows = 502507,
                               select = bdtest3)

toc()   


# subset to only include those with brain imgaging data

brain_imaging_rawdata1 <- subset(brain_imaging_rawdata, as.character(brain_imaging_rawdata$`53-2.0`) != "" & !is.na(brain_imaging_rawdata$`25000-2.0`) )

##############################################
# labelling the brain imaging data variables #
##############################################

names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25000-2.0"] <- "f.25000_Volumetric_scaling_T1_head_space"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25010-2.0"] <- "f.25010_Volbrain_grey+white matter"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25009-2.0"] <- "f.25009_Volbrain_grey+white matter_normalised"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25008-2.0"] <- "f.25008_Volwhite matter"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25007-2.0"] <- "f.25007_Volbrain_white_matter_normalised"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25006-2.0"] <- "f.25006_Volgrey matter"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25005-2.0"] <- "f.25005_Volbrain_grey_matter_normalised"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25002-2.0"] <- "f.25002_vol_peripheral_cortical_grey"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25001-2.0"] <- "f.25001_vol_peripheral_cortical_grey_normalised"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25004-2.0"] <- "f.25004_vol_ventricular_CSF"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25003-2.0"] <- "f.25003_vol_ventricular_CSF_normalised"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25886-2.0"] <- "f.25886_FAST_GM_Hippocampus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25887-2.0"] <- "f.25887_FAST_GM_Hippocampus_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25139-2.0"] <- "f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25138-2.0"] <- "f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R"   
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25091-2.0"] <- "f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25090-2.0"] <- "f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25093-2.0"] <- "f.25093_FA_Skeleton_hippocampus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25092-2.0"] <- "f.25092_FA_Skeleton_hippocampus_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25141-2.0"] <- "f.25141_MD_Skeleton_hippocampus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25140-2.0"] <- "f.25140_MD_Skeleton_hippocampus_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25023-2.0"] <- "f.25023_vol_accumbens_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25024-2.0"] <- "f.25024_vol_accumbens_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25021-2.0"] <- "f.25021_vol_amygdala_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25022-2.0"] <- "f.25022_vol_amygdala_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25019-2.0"] <- "f.25019_vol_hippocampus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25020-2.0"] <- "f.25020_vol_hippocampus_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25017-2.0"] <- "f.25017_vol_pallidum_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25018-2.0"] <- "f.25018_vol_pallidum_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25015-2.0"] <- "f.25015_vol_putamen_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25016-2.0"] <- "f.25016_vol_putamen_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25013-2.0"] <- "f.25013_vol_caudate_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25014-2.0"] <- "f.25014_vol_caudate_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25011-2.0"] <- "f.25011_vol_thalamus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25012-2.0"] <- "f.25012_vol_thalamus_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25738-2.0"] <- "f.25738_Discrepancy_SWI+T1_brain image"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25038-2.0"] <- "f.25038_MedianT2star_accumbens_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25039-2.0"] <- "f.25039_MedianT2star_accumbens_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25036-2.0"] <- "f.25036_MedianT2star_amygdala_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25037-2.0"] <- "f.25037_MedianT2star_amygdala_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25034-2.0"] <- "f.25034_MedianT2star_hippocampus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25035-2.0"] <- "f.25035_MedianT2star_hippocampus_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25032-2.0"] <- "f.25032_MedianT2star_pallidum_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25033-2.0"] <- "f.25033_MedianT2star_pallidum_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25030-2.0"] <- "f.25030_MedianT2star_putamen_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25031-2.0"] <- "f.25031_MedianT2star_putamen_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25028-2.0"] <- "f.25028_MedianT2star_caudate_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25029-2.0"] <- "f.25029_MedianT2star_caudate_R"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25026-2.0"] <- "f.25026_MedianT2star_thalamus_L"
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "25027-2.0"] <- "f.25027_MedianT2star_thalamus_R"

##########
# date of visit #
##########
names(brain_imaging_rawdata1)[names(brain_imaging_rawdata1) == "53-2.0"] <- "Date_of_visit"


##############################################################################
# extra brain imaging variables #
#############################################################################

setDTthreads(0L)

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41533.csv", header=TRUE, nrows = 0)


# get column names for imaging
bdtest <- bd[,grep("[0-9]{1,10}\\-[2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]

colwewant <- c("eid",   ## id
               "^54\\-", # assessment centre
               "^25756\\-"   ,      #Scanner lateral (X) brain position space
                "^25757\\-"   ,      #Scanner transverse (Y) brain position
                "^25758\\-"   ,      #Scanner longitudinal (Z) brain position
                "^25759\\-"        #Scanner table position
)

               
bdtest3 <- unique(grep(paste(colwewant, collapse ="|"),
                                      bdtest, value = TRUE, fixed = FALSE ))
               
               
tic()

scanner_position_brain_imaging <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41533.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               #fill = FALSE ,
                               #quote = "",
                               #nrows = 1000 ,
                               #nrows = 502507,
                               select = bdtest3)

toc()          


#rename the variables
names(scanner_position_brain_imaging)[names(scanner_position_brain_imaging) == "25756-2.0"] <- "25756-2_ScannerXposition"

names(scanner_position_brain_imaging)[names(scanner_position_brain_imaging) == "25757-2.0"] <- "25757-2.ScannerYposition"

names(scanner_position_brain_imaging)[names(scanner_position_brain_imaging) == "25758-2.0"] <- "25758-2_ScannerZposition"

names(scanner_position_brain_imaging)[names(scanner_position_brain_imaging) == "25759-2.0"] <- "25759-2_Scannerposition"

scanner_position_brain_imaging <- subset(scanner_position_brain_imaging, scanner_position_brain_imaging$eid %in% brain_imaging_rawdata1$eid)


###################################
### white matter hypertensities ###
###################################

###################################################################
# AND hippocampal free surfer whole, body, head and tail
##################################################################

setDTthreads(0L)

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41321.csv", header=TRUE, nrows = 0)


# get column names for imaging
bdtest <- bd[,grep("[0-9]{1,10}\\-[2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]

colwewant <- c("eid",   ## id
               "^25781\\-" , # white matter hyperintensity,
               
               "^26639\\-" ,	#Volume of Whole-hippocampal-body (left hemisphere)
"^26661\\-" ,	#Volume of Whole-hippocampal-body (right hemisphere)
"^26640\\-" ,	#Volume of Whole-hippocampal-head (left hemisphere)
"^26662\\-" ,	#Volume of Whole-hippocampal-head (right hemisphere)
"^26641\\-" ,	#Volume of Whole-hippocampus (left hemisphere)
"^26663\\-" ,	#Volume of Whole-hippocampus (right hemisphere)
"^26620\\-" ,	#Volume of Hippocampal-tail (left hemisphere)
"^26642\\-" 	#Volume of Hippocampal-tail (right hemisphere)
               

)

               
bdtest3 <- unique(grep(paste(colwewant, collapse ="|"),
                                      bdtest, value = TRUE, fixed = FALSE ))
               
               
tic()

brain_imaging_rawdata_WMH <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41321.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               select = bdtest3)

toc()          
     

brain_imaging_rawdata_WMH1 <- subset(brain_imaging_rawdata_WMH, brain_imaging_rawdata_WMH$eid %in% brain_imaging_rawdata1$eid)

names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "25781-2.0"] <- "f.25781_WMH"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26639-2.0"] <- "f.26639_body_hippo_L"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26661-2.0"] <- "f.26661_body_hippo_R"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26640-2.0"] <- "f.26640_head_hippo_L"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26662-2.0"] <- "f.26662_head_hippo_R"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26641-2.0"] <- "f.26641_whole_hippo_L"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26663-2.0"] <- "f.26663_whole_hippo_R"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26620-2.0"] <- "f.26620_tail_hippo_L"
names(brain_imaging_rawdata_WMH1)[names(brain_imaging_rawdata_WMH1) == "26642-2.0"] <- "f.26642_tail_hippo_R"



  

# merge brain imaging data together
Brain_imaging_subset <- merge(brain_imaging_rawdata1, brain_imaging_rawdata_WMH1,  by = "eid")
Brain_imaging_subset <- merge(Brain_imaging_subset, scanner_position_brain_imaging,  by = "eid")


save(Brain_imaging_subset, file = paste(saving_directory, "brain_imaging_compiled_13122020.Rdata", sep=""))





```

**STEP 2** Read in the cognitive and demographics data from UKBB
```{r loadUKBB1 , echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}
######################################################################################################
# demographics and cognition
#####################################################################################################

setDTthreads(0L)

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", header=TRUE, nrows = 0)


bdtest <- bd[,grep("[0-9]{1,10}\\-[0|2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]



colwewant1 <- c("eid",   ## id
                "^31\\-0",          ## sex
                "^21003\\-2",       ## age at assessment # BC glasgow recommends this
                "^399\\-2",         ## memory test pairs matching second round of 6 cards as with hagenaars et al
                ## we need 399.02 which is the second round using 6 cards
                "^400\\-2",         ## time to complete memory test we need 400.02 for 6 card test (need this to see if people completed the test)
                "^401\\-2",         ## index for card A in round
                "^402\\-2",         ## index for card B in round
                "^404\\-2",         ## duration to first press of snap button in each round
                "^398\\-2",         ## pairs matching Number of correct matches in round (need this to see who completed test)
                "^20016\\-2",       ## fluid intelligence score number of correct answers 0-13
                "^20128\\-2" ,      ## Number of fluid intelligence questions attempted within time limit ## we do not have this in our download
                "^4924\\-2" ,        ## attempted fluid intelligence test
                "^20023\\-2",       ## Mean reaction time
                "^189\\-" ,         # Townsend deprivation index at recruitment
                "^6138\\-2",        ## Qualifications
                "^20116\\-2",       ## smoking status
                "^1558\\-2",        ## alcohol intake frequency
                "^21000\\-2",       ## ethnic background imaging
                "^21000\\-0",       ## ethnic background baseline
                "^21001\\-2"   ,   ## BMI
                "^54\\-2"    ,     ## UK BB assessment centre
                  "^2090\\-2",       ## Seen doctor (GP) for nerves, anxiety, tension or depression
                "^2100\\-2"   ,   ## Seen psychaitrist for nerves, anxiety, tension or depression     
                "^2966\\-2"  ,# age high blood pressure diagnosed
                "^2976\\-2"  ,# Age diabetes diagnosed
                "^2443\\-2"  ,# Diabetes diagnosed by doctor
                "^4079\\-2"  ,# diastolic blood pressure automated reading
                "^4080\\-2", # systolic blood pressure automated reading
                                "^6177\\-2", # medication for cholesterol, blood pressure or diabetes
                "^6153\\-2", # medication for cholesterol, blood pressure or diabetes or exogenous hormones
                "^2966\\-2"  # age high blood pressure diagnosed
)



bdtest4 <- unique(grep(paste(colwewant1, collapse ="|"),
                       bdtest, value = TRUE, fixed = FALSE
))



tic()
# read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
demographics_cog_rawdata <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               #fill = FALSE ,
                               #quote = "",
                               #nrows = 1000 ,
                               #nrows = 502507,
                               select = bdtest4)

toc()



#subset to those that have imaging data
load(paste(saving_directory, "brain_imaging_compiled_13122020.Rdata", sep=""))


demographics_cog_rawdata1 <- subset(demographics_cog_rawdata, demographics_cog_rawdata$eid %in% Brain_imaging_subset$eid)


#####################################
# extra cognitive variables
######################################

# trail making, matrix and digits

 setDTthreads(0L)


bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb43218.csv", header=TRUE, nrows = 0)

# get column names for imaging
#
#  #get column names for imaging
bdtest2a <- bd[,grep("[0-9]{1,10}\\-[0|1|2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]
# #
# # # to select the columns we need
colwewant1 <- c("eid",   ## id
               "^6348\\-2",         ## Duration to complete numeric path (trail #1)
                 "^6350\\-2",         ## Duration to complete numeric path (trail #2)
               "^6373\\-2" ,      ## Number of puzzles correctly solved (Matrix pattern completion)
                                "^23324\\-2"         ## Number of symbol digit matches made correctly

 )


bdtest4a <- unique(grep(paste(colwewant1, collapse ="|"),
                       bdtest2a, value = TRUE, fixed = FALSE
 ))


 tic()
# # read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
 extra_cog_rawdata <- fread("C:/Users/dnewby/Desktop/UKBB/ukb43218.csv",
                              header=TRUE,
                                sep=",",
                               verbose = T,
                                #fill = FALSE ,
                                #quote = "",
                                #nrows = 1000 ,
                                #nrows = 502507,
                                select = bdtest4a)
 
 toc()
# 
# 
# 

 
 
 newcogtests_rawdata <- subset(extra_cog_rawdata, extra_cog_rawdata$eid %in% Brain_imaging_subset$eid)
 
 names(newcogtests_rawdata)[names(newcogtests_rawdata) == "6348-2.0" ] <- "f6348_Duration_trailA"

  names(newcogtests_rawdata)[names(newcogtests_rawdata) == "6350-2.0" ] <- "f6350_Duration_trailB" 
  
    names(newcogtests_rawdata)[names(newcogtests_rawdata) == "6373-2.0" ] <- "f6373_matrix_pattern_puzzles_solved" 
 
  names(newcogtests_rawdata)[names(newcogtests_rawdata) == "23324-2.0" ] <- "f23324_correct_symbol_digit_matches" 



#####################################
# tower rearranging
######################################

setDTthreads(0L)


bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb43579.csv", header=TRUE, nrows = 0)

# get column names for imaging
#
#  #get column names for imaging
bdtest2ab <- bd[,grep("[0-9]{1,10}\\-[0|1|2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]
# #
# # # to select the columns we need
colwewant8 <- c("eid",   ## id        ## Duration to complete numeric path (trail #1)
                 "21004\\-2"      ## Number of puzzles correctly solved (tower)


 )


bdtest4ab <- unique(grep(paste(colwewant8, collapse ="|"),
                       bdtest2ab, value = TRUE, fixed = FALSE
 ))


 tic()
# # read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
 extra_cog_tower_rawdata <- fread("C:/Users/dnewby/Desktop/UKBB/ukb43579.csv",
                              header=TRUE,
                                sep=",",
                               verbose = T,
                                #fill = FALSE ,
                                #quote = "",
                                #nrows = 1000 ,
                                #nrows = 502507,
                                select = bdtest4ab)
 
 toc()
# 
# 
# 

 
 
 newcogtests_tower_rawdata <- subset(extra_cog_tower_rawdata , extra_cog_tower_rawdata$eid %in% Brain_imaging_subset$eid)
 
 names(newcogtests_tower_rawdata)[names(newcogtests_tower_rawdata) == "21004-2.0" ] <- "21004_correct_tower_arranging"
# 


 
 
#
 #############################################################################################
# in this section we are extracting the number of people taking bp meds, diabetics etc
# subset the data you need 6177############################################################

demographics_cog_rawdata2 <- demographics_cog_rawdata1[,c("6177-2.0" ,
                                                          "6177-2.1" ,
                                                          "6177-2.2")]


diseases_UKBB <- unique(c(as.matrix(demographics_cog_rawdata2[,paste("6177-2.",c(0:2),sep="")])))
# 
diseases_UKBB <- diseases_UKBB[!is.na(diseases_UKBB)]
stopifnot(length(diseases_UKBB) == 6)
# 
# # this takes ages!!
# # Using function over disease columns create a boolean matrix for each cancer disease for each subject in UKBB
bCase_iSiD_diseases = findCases( diseases_UKBB , demographics_cog_rawdata2[,paste("6177-2.",c(0:2),sep="")])


colnames(bCase_iSiD_diseases) <- diseases_UKBB
dim(bCase_iSiD_diseases) # should be xx diseases
rownames(bCase_iSiD_diseases) <- demographics_cog_rawdata1$eid


# turn into a integer matrix
bCase_iSiD_diseases <- 1 * bCase_iSiD_diseases

# subset to only include the ones we need (BP, high chol, insulin etc)
bCase_iSiD_diseases <- bCase_iSiD_diseases[,c(2,3,6)]


# rename columns 
colnames(bCase_iSiD_diseases) <- c("High_chol_M",
                                   "BP_medications_M",
                                   "Insulin_M"
                                   )




#################################################################################################
#############################################################################################
# in this section we are extracting the number of people taking bp meds, diabetics etc
# subset the data you need 6177############################################################

demographics_cog_rawdata2a <- demographics_cog_rawdata1[,c("6153-2.0" ,
                                                          "6153-2.1" ,
                                                          "6153-2.2")]


diseases_UKBBa <- unique(c(as.matrix(demographics_cog_rawdata2a[,paste("6153-2.",c(0:2),sep="")])))
# 
diseases_UKBBa <- diseases_UKBBa[!is.na(diseases_UKBBa)]
stopifnot(length(diseases_UKBBa) == 8)
# 
# # this takes ages!!
# # Using function over disease columns create a boolean matrix for each cancer disease for each subject in UKBB
bCase_iSiD_diseasesa = findCases( diseases_UKBBa , demographics_cog_rawdata2a[,paste("6153-2.",c(0:2),sep="")])


colnames(bCase_iSiD_diseasesa) <- diseases_UKBBa
dim(bCase_iSiD_diseasesa) # should be xx diseases
rownames(bCase_iSiD_diseasesa) <- demographics_cog_rawdata1$eid


# turn into a integer matrix
bCase_iSiD_diseasesa <- 1 * bCase_iSiD_diseasesa

# subset to only include the ones we need (BP, high chol, insulin etc)
bCase_iSiD_diseasesa <- bCase_iSiD_diseasesa[,c(4,2,7)]


# rename columns 
colnames(bCase_iSiD_diseasesa) <- c("High_chol_F",
                                   "BP_medications_F",
                                   "Insulin_F"
                                   )



# join the two together

bCase_iSiD_diseases_both <- cbind(bCase_iSiD_diseases,
                                  bCase_iSiD_diseasesa)

bCase_iSiD_diseases_both <- as.data.frame(bCase_iSiD_diseases_both)


bCase_iSiD_diseases_both$BP_medications <- bCase_iSiD_diseases_both$BP_medications_M + bCase_iSiD_diseases_both$BP_medications_F
  
bCase_iSiD_diseases_both$Cholesterol_medications <- bCase_iSiD_diseases_both$High_chol_M + bCase_iSiD_diseases_both$High_chol_F
  
bCase_iSiD_diseases_both$Insulin_medications <- bCase_iSiD_diseases_both$Insulin_M + bCase_iSiD_diseases_both$Insulin_F

bCase_iSiD_diseases_both$eid <- rownames(bCase_iSiD_diseases_both)

#susbet this

bCase_iSiD_diseases_both <- bCase_iSiD_diseases_both[,7:10]

bCase_iSiD_diseases_both$eid <- as.integer(bCase_iSiD_diseases_both$eid)



#############################################################################
#merge back into cognitive tests and demographics 
Cognition_demographics_subset <- merge(newcogtests_tower_rawdata,  newcogtests_rawdata,  by = "eid")

Cognition_demographics_subset <- merge(Cognition_demographics_subset, demographics_cog_rawdata1,  by = "eid")

Cognition_demographics_subset <- merge(Cognition_demographics_subset,  bCase_iSiD_diseases_both,  by = "eid")


save(Cognition_demographics_subset, file = paste(saving_directory, "Cognition_demographics_subset_compiled_13122020.Rdata", sep=""))


```

**STEP 3** Read in the self reported diseases from UKBB
In this we will extract:
  1) the self reported measures that will be used for the confounders
  2) self reported measures for exclusion criteria for excluding people with neurological conditions at imaging visit
  3) merge this information into the main cognitive/demographic file
```{r loadUKBB2 , echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}
#####################################################################################################
## self reported diseases

# setDTthreads(0L)
# 
# bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", header=TRUE, nrows = 0)
# 
# 
# bdtest <- bd[,grep("[0-9]{1,10}\\-[0|2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]
# 
# # to select the columns we need
# colwewant2 <- c("eid",   ## id
#                   "20002\\-2"   # ,     ## non illness code self reported
# 
# 
# )
# #
# #
# #
# bdtest5 <- unique(grep(paste(colwewant2, collapse ="|"),
#                        bdtest, value = TRUE, fixed = FALSE
# ))
# #
# #
# #
# #
# tic()
# # read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
# self_reported_disease <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv",
#                                header=TRUE,
#                                sep=",",
#                               verbose = T,
#                                #fill = FALSE ,
#                                #quote = "",
#                                #nrows = 1000 ,
#                                #nrows = 502507,
#                                select = bdtest5)
# 
# toc()
# 
# 
# 
# #subset to those that have imaging data
# load(paste(saving_directory, "brain_imaging_compiled_22102020.Rdata", sep=""))
# 
# 
# self_reported_disease1 <- subset(self_reported_disease, self_reported_disease$eid %in% Brain_imaging_subset$eid)
# 
# 
# # ##################################################################################
# # # this next part of the code take the self diagnosed information and converts it into a single column for each disease saying y or n if a person has reported that diagnosis
# #
# self_reported_disease2 <- self_reported_disease1[,c(35, 34, 33, 32, 31, 30, 29, 28, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1)]
# #
# #
# # #
# diseases_UKBB <- unique(c(as.matrix(self_reported_disease2[,paste("20002-2.",c(0:33),sep="")])))
# # #
# diseases_UKBB <- diseases_UKBB[!is.na(diseases_UKBB)]
# stopifnot(length(diseases_UKBB) == 435 )
# 
# # # # this takes ages!!
# # # # Using function over disease columns create a boolean matrix for each cancer disease for each subject in UKBB
# bCase_iSiD_diseases = findCases( diseases_UKBB ,self_reported_disease2[,paste("20002-2.",c(0:33),sep="")])
# #
# #
# colnames(bCase_iSiD_diseases) <- diseases_UKBB
# dim(bCase_iSiD_diseases) # should be 435 diseases
# rownames(bCase_iSiD_diseases) <- self_reported_disease2$eid
# #
# # #save the matrix for all diseases for all subjects and save output (can use columns for certain diseases at a later date)
# save(bCase_iSiD_diseases, file = paste(saving_directory, "self_diagnosed_disease20002_for_imaging_visit_20102020.Rdata", sep=""))
med_directory <- "C:/Users/dnewby/Desktop/UKBB/Analysis/HPT_brain_volumes/"


load(paste(med_directory, "self_diagnosed_disease20002_for_imaging_visit_20102020.Rdata", sep=""))

#### create the self reported variables using disease dataframe

bCase_iSiD_diseases <- as.data.frame(bCase_iSiD_diseases)

bCase_iSiD_diseases1 <- 1 * bCase_iSiD_diseases # to turn from true/false to 0 and 1

rm(bCase_iSiD_diseases)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#

# variables for propensity score

# hypertension
hypertension <- bCase_iSiD_diseases1$`1065` + bCase_iSiD_diseases1$`1072`

hypertension[hypertension == 2 ] <- 1

# diabetes
diabetes <-  bCase_iSiD_diseases1$`1220` + bCase_iSiD_diseases1$`1222` + bCase_iSiD_diseases1$`1223` 

diabetes[diabetes == 2 ] <- 1
  
# renal disease
renal_disease <-   bCase_iSiD_diseases1$`1519` + bCase_iSiD_diseases1$`1192` + bCase_iSiD_diseases1$`1193` + bCase_iSiD_diseases1$`1194`

# history of coronary heart disease symptoms
his_coronary_heart_disease_symptoms <- bCase_iSiD_diseases1$`1075` + bCase_iSiD_diseases1$`1074` + 
bCase_iSiD_diseases1$`1076` 

his_coronary_heart_disease_symptoms[his_coronary_heart_disease_symptoms == 2 ] <- 1

# atrial fibulation/atrial flutter
Atrial_fibrillation <- bCase_iSiD_diseases1$`1483` + bCase_iSiD_diseases1$`1471`

Atrial_fibrillation[Atrial_fibrillation == 2 ] <- 1

# high cholesterol/ hypercholesterolemia
high_chol <- bCase_iSiD_diseases1$`1473`

#depression/depressive symptoms

depression <- bCase_iSiD_diseases1$`1286` + bCase_iSiD_diseases1$`1291`
depression[depression == 2 ] <- 1


# extract confounders and additional variables

self_reported_disease3 <- cbind(
  
  hypertension,
  diabetes,
  renal_disease,
  his_coronary_heart_disease_symptoms,
  Atrial_fibrillation,
  high_chol,
  depression
  
)

rownames(self_reported_disease3) <- rownames(bCase_iSiD_diseases1)
self_reported_disease3 <- as.data.frame(self_reported_disease3)
self_reported_disease3$eid <- rownames(self_reported_disease3)
self_reported_disease3$eid <- as.integer(self_reported_disease3$eid)


############################################################
# variables for exclusion criteria

#Dementia or Alzheimer’s disease	1263
Dementia   <- bCase_iSiD_diseases1$`1263`

#Parkinson’s disease	1262
PD<- bCase_iSiD_diseases1$`1262`

#Chronic degenerative neurological 	1258
Chronic_degenerative_neurological<- bCase_iSiD_diseases1$`1258`

#Guillain-Barré syndrome	1256
Guillain_Barre<- bCase_iSiD_diseases1$`1256`

#Multiple Sclerosis	1261
MS <- bCase_iSiD_diseases1$`1261`

#Other demyelinating disease	1397
Other_demyelinating_disease <- bCase_iSiD_diseases1$`1397`

#Stroke or ischaemic stroke	1081
stroke <- bCase_iSiD_diseases1$`1081`

#Brain cancer	1032
Brain_cancer <- bCase_iSiD_diseases1$`1032`

#Brain haemorrhage 	1491
Brain_haemorrhage <- bCase_iSiD_diseases1$`1491`

#Brain/intracranial abscess	1245
Brain_abscess<- bCase_iSiD_diseases1$`1245`

#Cerebral aneurysm	1425
Cerebral_aneurysm <- bCase_iSiD_diseases1$`1425`

#Cerebral palsy	1433
Cerebral_palsy <- bCase_iSiD_diseases1$`1433`

#Encephalitis	1246
Encephalitis <- bCase_iSiD_diseases1$`1246`

#Epilepsy	1264
Epilepsy <- bCase_iSiD_diseases1$`1264`

#Head injury	1266
Head_injury <- bCase_iSiD_diseases1$`1266`

#Infections of the nervous system	1244
Infections_nervous_system <- bCase_iSiD_diseases1$`1244`

#Ischaemic stroke	1583
Ischaemic_stroke <- bCase_iSiD_diseases1$`1583`

#Meningeal cancer	1031
Meningeal_cancer <- bCase_iSiD_diseases1$`1031`

#Meningioma (benign)	1659
Meningioma_benign <- bCase_iSiD_diseases1$`1659`

#Meningitis	1247
Meningitis <- bCase_iSiD_diseases1$`1247`

#Motor Neuron Disease	1259
Motor_Neuron_Disease <- bCase_iSiD_diseases1$`1259`

#Neurological injury/trauma	1240
Neurological_injury_trauma <- bCase_iSiD_diseases1$`1240`

#Spina bifida	1524
Spina_bifida <- bCase_iSiD_diseases1$`1524`

#Subdural haematoma	1083
Subdural_haematoma <- bCase_iSiD_diseases1$`1083`

#Subarachnoid haemorrhage	1086
Subarachnoid_haemorrhage <- bCase_iSiD_diseases1$`1086`

#Transient ischaemic attack	1082
Transient_ischaemic_attack <- bCase_iSiD_diseases1$`1082`


########################################
# put them into one dataframe
########################################
diseases_for_exclusion <- cbind(
  
  Dementia,
PD,
Chronic_degenerative_neurological,
Guillain_Barre,
MS ,
Other_demyelinating_disease ,
stroke,
Brain_cancer,
Brain_haemorrhage ,
Brain_abscess,
Cerebral_aneurysm ,
Cerebral_palsy ,
Encephalitis ,
Epilepsy ,
Head_injury ,
Infections_nervous_system ,
Ischaemic_stroke ,
Meningeal_cancer ,
Meningioma_benign ,
Meningitis ,
Motor_Neuron_Disease ,
Neurological_injury_trauma ,
Spina_bifida ,
Subdural_haematoma ,
Subarachnoid_haemorrhage ,
Transient_ischaemic_attack
  
)


rownames(diseases_for_exclusion) <- rownames(bCase_iSiD_diseases1)

diseases_for_exclusion <- as.data.frame(diseases_for_exclusion)

# create variable to exlucde
diseases_for_exclusion$people2exlcude <- rowSums(diseases_for_exclusion)

diseases_for_exclusion$people2exlcude[diseases_for_exclusion$people2exlcude > 1] <- 1

diseases_for_exclusion$eid <- rownames(diseases_for_exclusion)

diseases_for_exclusion$eid <- as.integer(diseases_for_exclusion$eid)

# merge back into cognition/demographic file
load(file = paste(saving_directory, "Cognition_demographics_subset_compiled_13122020.Rdata", sep=""))

Cognition_demographics_subset <- merge(Cognition_demographics_subset, diseases_for_exclusion,  by = "eid")

Cognition_demographics_subset <- merge(Cognition_demographics_subset,  self_reported_disease3,  by = "eid")


save(Cognition_demographics_subset, file = paste(saving_directory, "Cognition_demographics_subset_compiled_13122020.Rdata", sep=""))


```

**STEP 4** Read in the first occurrence variables for renal disease, depression, hypertension and diabetes
```{r loadUKBB3 , echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

setDTthreads(0L)

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41117.csv", header=TRUE, nrows = 0)

# get column names for imaging
bdtest <- bd[,grep("[0-9]{1,10}\\-[0]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]

##########################################################################
# first occurence for diabetes, MI, depression, CAD #
###########################################################################

colwewant <- c("eid",   ## id
               "^131286\\-", # DATE of I10 (essential (primary) hypertension)
               "^131287\\-", # Source of report of I10 (essential (primary) hypertension)
               "^131288\\-", #    # Date I11 first reported (hypertensive heart disease)
               "^131289\\-", #    # Source of report of I11 (hypertensive heart disease)
               "^131290\\-", #	Date I12 first reported (hypertensive renal disease)
               "^131291\\-", #	Source of report of I12 (hypertensive renal disease)
               "^131292\\-", #	Date I13 first reported (hypertensive heart and renal disease)
               "^131293\\-" , #	Source of report of I13 (hypertensive heart and renal disease)
               "^131294\\-", #	Date I15 first reported (secondary hypertension)
               "^131295\\-" ,#	Source of report of I15 (secondary hypertension)       
               "^131293\\-" , #	Source of report of I13 (hypertensive heart and renal disease)
               "^131294\\-", #	Date I15 first reported (secondary hypertension)
               "^130706\\-" ,	#Date E10 first reported (insulin-dependent diabetes mellitus)
               "^130707\\-" ,	#Source of report of E10 (insulin-dependent diabetes mellitus)
               "^130708\\-" ,	#Date E11 first reported (non-insulin-dependent diabetes mellitus)
               "^130709\\-" ,	#Source of report of E11 (non-insulin-dependent diabetes mellitus)
               "^130710\\-" ,	#Date E12 first reported (malnutrition-related diabetes mellitus)
               "^130711\\-" ,	#Source of report of E12 (malnutrition-related diabetes mellitus)
               "^130712\\-" ,	#Date E13 first reported (other specified diabetes mellitus)
               "^130713\\-" ,	#Source of report of E13 (other specified diabetes mellitus)
               "^130714\\-" ,	#Date E14 first reported (unspecified diabetes mellitus)
               "^130715\\-" ,	#Source of report of E14 (unspecified diabetes mellitus)
               "^131350\\-", # Date I48 first reported (atrial fibrillation and flutter)
               "^131351\\-", # Source of report of I48 (atrial fibrillation and flutter)
               "^131296\\-", # Date I20 first reported (angina pectoris)
               "^131297\\-", #Source of report of I20 (angina pectoris)
               "^131298\\-", # Date I21 first reported (acute myocardial infarction)
               "^131299\\-", # Source of report of I21 (acute myocardial infarction)
               "^131300\\-", # Date I22 first reported (subsequent myocardial infarction)
               "^131301\\-", # Source of report of I22 (subsequent myocardial infarction)
               "^131354\\-", # Date I50 first reported (heart failure)
               "^131355\\-", # Source of report of I50 (heart failure)
               "^131524\\-", # Date J81 first reported (pulmonary oedema)
               "^131525\\-", # Source of report of J81 (pulmonary oedema)
               "^130894\\-", # Date F32 first reported (depressive episode)
               "^130895\\-", # Source of report of F32 (depressive episode)
               "^130896\\-", # Date F33 first reported (recurrent depressive disorder)
               "^130897\\-"	#Source of report of F33 (recurrent depressive disorder)
               
               
)


               
bdtest3 <- unique(grep(paste(colwewant, collapse ="|"),
                                      bdtest, value = TRUE, fixed = FALSE ))
               
               
        
tic()

first_occurence_rawdata <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41117.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               #fill = FALSE ,
                               #quote = "",
                               #nrows = 1000 ,
                               #nrows = 502507,
                               select = bdtest3)

toc()   

load(paste(saving_directory, "brain_imaging_compiled_13122020.Rdata", sep=""))

first_occurence_rawdata <- subset(first_occurence_rawdata, first_occurence_rawdata$eid %in% Brain_imaging_subset$eid)


# remove dates that have these codes
# 1901-01-01	Code has event date before participant's date of birth
# 1902-02-02	Code has event date matching participant's date of birth
# 1903-03-03	Code has event date after participant's date of birth and falls in the same calendar year as date of birth
# 2037-07-07	Code has event date in the future and is presumed to be a place-holder or other system default

first_occurence_rawdata[first_occurence_rawdata == "1901-01-01"] <- NA
first_occurence_rawdata[first_occurence_rawdata == "1902-02-02"] <- NA
first_occurence_rawdata[first_occurence_rawdata == "1903-03-03"] <- NA
first_occurence_rawdata[first_occurence_rawdata == "2037-07-07"] <- NA
#first_occurence_rawdata[first_occurence_rawdata == ""] <- NA


#rename the variables

names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131286-0.0" ] <- "f131286-0-0_Date_primary_hypertension"
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131287-0.0" ] <- "f131287-0-0_source_primary_hypertension"

names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131288-0.0" ] <- "f131288-0-0_Date_hypertensive_heart_disease"
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131289-0.0" ] <- "f131289-0-0_source_hypertensive_heart_disease"

names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131290-0.0" ] <- "f131290-0-0_Date_hypertensive_renal_disease"
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131291-0.0" ] <- "f131291-0-0_source_hypertensive_renal_disease"

names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131292-0.0" ] <- "f131292-0-0_Date_hypertensive_renal_heart_disease"
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131293-0.0" ] <- "f131293-0-0_source_hypertensive_renal_heart_disease"

names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131294-0.0" ] <- "f131294-0-0_Date_secondary_hypertension"
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131295-0.0" ] <- "f131295-0-0_source_secondary_hypertension"

#Date E10 first reported (insulin-dependent diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130706-0.0" ] <- "f130706-0-0_Date_insulin_dependentDM"
#Source of report of E10 (insulin-dependent diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130707-0.0" ] <- "f130707-0-0_source__insulin_dependentDM"

#Date E11 first reported (non insulin-dependent diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130708-0.0" ] <- "f130708-0-0_Date_noninsulin_dependentDM"
#Source of report of E11 (non insulin-dependent diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130709-0.0" ] <- "f130709-0-0_source_noninsulin_dependentDM"

#Date E12 first reported (malnutrition-related diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130710-0.0" ] <- "f130710-0-0_Date_malnutrition_dependentDM"
#Source of report of E12 (malnutrition-related diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130711-0.0" ] <- "f130711-0-0_source_malnutrition_dependentDM"

#Date E13 first reported (other specified diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130712-0.0" ] <- "f130712-0-0_Date_other_specifiedDM"
#Source of report of E13 (other specified diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130713-0.0" ] <- "f130713-0-0_source_other_specifiedDM"

#Date E14 first reported (unspecified diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130714-0.0" ] <- "f130714-0-0_Date_unspecified_DM"
#Source of report of E14 (unspecified diabetes mellitus)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130715-0.0" ] <- "f130715-0-0_source_unspecified_DM"

# AF
#"^131350\\-", # Date I48 first reported (atrial fibrillation and flutter)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131350-0.0" ] <- "f130714-0-0_Date_atrial_fib"
# source Date I48 first reported (atrial fibrillation and flutter)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131351-0.0" ] <- "f130715-0-0_source_atrial_fib"

# angina
              # "^131296\\-", # Date I20 first reported (angina pectoris)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131296-0.0" ] <- "f131296-0-0_Date_angina"
              # "^131297\\-", #Source of report of I20 (angina pectoris)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131297-0.0" ] <- "f131297-0-0_source_angina"

# acute MI
# "^131298\\-", # Date I21 first reported (acute myocardial infarction)
               names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131298-0.0" ] <- "f131298-0-0_Date_acute_MI"
# "^131299\\-", # Source of report of I21 (acute myocardial infarction)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131299-0.0" ] <- "f131299-0-0_Source_acute_MI"

#subsequent MI
# "^131300\\-", # Date I22 first reported (subsequent myocardial infarction)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131300-0.0" ] <- "f131300-0-0_Date_sub_MI"
# "^131301\\-", # Source of report of I22 (subsequent myocardial infarction)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131301-0.0" ] <- "f131301-0-0_Source_sub_MI"

#heart failure     
# "^131354\\-", # Date I50 first reported (heart failure)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131354-0.0" ] <- "f131354-0-0_Date_heart_failure"
# "^131355\\-", # Source of report of I50 (heart failure)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131355-0.0" ] <- "f131355-0-0_Source_heart_failure"
    
# pulmonary_oedema          
# "^131524\\-", # Date J81 first reported (pulmonary oedema)
 names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131524-0.0" ] <- "f131524-0-0_Date_pulmonary_oedema"              
#   "^131525\\-", # Source of report of J81 (pulmonary oedema)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "131525-0.0" ] <- "f131525-0-0_source_pulmonary_oedema"
        
# depressive episode       
#  "^130894\\-", # Date F32 first reported (depressive episode)
 names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130894-0.0" ] <- "f130894-0-0_Date_depressive_episode"              
#   "^130895\\-", # Source of report of F32 (depressive episode)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130895-0.0" ] <- "f130895-0-0_Source_depressive_episode"

# recurrent_depressive_disorder             
#  "^130896\\-", # Date F33 first reported (recurrent depressive disorder)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130896-0.0" ] <- "f130896-0-0_Date_recurrent_depressive_disorder"               
# "^130897\\-"	#Source of report of F33 (recurrent depressive disorder)
names(first_occurence_rawdata)[names(first_occurence_rawdata) == "130897-0.0" ] <- "f130897-0-0_Source_recurrent_depressive_disorder"


################ renal disease #################################################

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41970.csv", header=TRUE, nrows = 0)

# get column names for imaging
bdtest <- bd[,grep("[0-9]{1,10}\\-[0]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]


colwewant <- c("eid",   ## id
"^132030\\-" ,	#	Date N17 first reported (acute renal failure)
"^132031\\-" ,	#	Source of report of N17 (acute renal failure)
"^132032\\-" ,	#	Date N18 first reported (chronic renal failure)
"^132033\\-" ,	#	Source of report of N18 (chronic renal failure)
"^132034\\-" ,	#	Date N19 first reported (unspecified renal failure)
"^132035\\-" 	#	Source of report of N19 (unspecified renal failure) 

         
)


               
bdtest3 <- unique(grep(paste(colwewant, collapse ="|"),
                                      bdtest, value = TRUE, fixed = FALSE ))
               
               
# find the column number for these in r
#colindex <- which(names(bd)%in%c(bdtest3))
               
               
               
               
tic()
# read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
first_occurence_rawdata1 <- fread("C:/Users/dnewby/Desktop/UKBB/ukb41970.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               #fill = FALSE ,
                               #quote = "",
                               #nrows = 1000 ,
                               #nrows = 502507,
                               select = bdtest3)

toc()  

first_occurence_renal_rawdata <- subset(first_occurence_rawdata1, first_occurence_rawdata1$eid %in% Brain_imaging_subset$eid)


# remove dates that have these codes
# 1901-01-01	Code has event date before participant's date of birth
# 1902-02-02	Code has event date matching participant's date of birth
# 1903-03-03	Code has event date after participant's date of birth and falls in the same calendar year as date of birth
# 2037-07-07	Code has event date in the future and is presumed to be a place-holder or other system default

first_occurence_renal_rawdata[first_occurence_renal_rawdata == "1901-01-01"] <- NA
first_occurence_renal_rawdata[first_occurence_renal_rawdata == "1902-02-02"] <- NA
first_occurence_renal_rawdata[first_occurence_renal_rawdata == "1903-03-03"] <- NA
first_occurence_renal_rawdata[first_occurence_renal_rawdata == "2037-07-07"] <- NA
#first_occurence_renal_rawdata[first_occurence_renal_rawdata == ""] <- NA

#	Date N17 first reported (acute renal failure)
names(first_occurence_renal_rawdata)[names(first_occurence_renal_rawdata) == "132030-0.0" ] <- "f132030-0-0_Date_acute_renal_failure"
#	Source of report of N17 (acute renal failure)
names(first_occurence_renal_rawdata)[names(first_occurence_renal_rawdata) == "132031-0.0" ] <- "f132030-0-0_source_acute_renal_failure"


#	Date N18 first reported (chronic renal failure)
names(first_occurence_renal_rawdata)[names(first_occurence_renal_rawdata) == "132032-0.0" ] <- "f132032-0-0_Date_chronic_renal_failure"
#Source of report of N18 (chronic renal failure)
names(first_occurence_renal_rawdata)[names(first_occurence_renal_rawdata) == "132033-0.0" ] <- "f132033-0-0_chronic_acute_renal_failure"


#	Date N19 first reported (unspecified renal failure)
names(first_occurence_renal_rawdata)[names(first_occurence_renal_rawdata) == "132034-0.0" ] <- "f132034-0-0_Date_chronic_renal_failure"
#	Source of report of N19 (unspecified renal failure)
names(first_occurence_renal_rawdata)[names(first_occurence_renal_rawdata) == "132035-0.0" ] <- "f132035-0-0_chronic_acute_renal_failure"
 
# save(first_occurence_renal_rawdata, file = "N:/Danielle/Projects/JnJ_CVD_MET_DEM/5 Analysis/5 Drugs and Brains UKBB/first_occurence_rawdata_renal_211020.Rdata")

##################################################
# merge first occurence data together


# merge brain imaging data and cogntive data
first_occurence_subset <- merge(first_occurence_rawdata, first_occurence_renal_rawdata,  by = "eid")

save(first_occurence_subset, file = paste(saving_directory, "first_occurence_subset_compiled_13122020.Rdata", sep=""))


```

**STEP 5** Clean the cognitive and demographics data
```{r loadUKBB4 , echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

load(file = paste(saving_directory, "Cognition_demographics_subset_compiled_13122020.Rdata", sep=""))

rawdata <- Cognition_demographics_subset

##########
# ID #
##########
rownames(rawdata) <- rawdata$eid


##########
# GENDER #
##########
rawdata$`31-0.0` <- ifelse(rawdata$`31-0.0` == 0, "Female", "Male")
names(rawdata)[names(rawdata) == "31-0.0"] <- "Gender"
rawdata$Gender <- as.factor(rawdata$Gender) # create a factor
stopifnot(is.factor(rawdata$Gender))


######################
# AGE OF ASSESSMENT # BC glasgow recommends this
######################
names(rawdata)[names(rawdata) == "21003-2.0"] <- "Age_at_assessment"


##########################
# UKBB ASSESSMENT CENTRE #
##########################
names(rawdata)[names(rawdata) == "54-2.0"] <- "UKBB_centre"
rawdata$UKBB_centre <- as.factor(rawdata$UKBB_centre)
stopifnot(is.factor(rawdata$UKBB_centre))

                     
###############################################
# smoking status                 ##############
###############################################
names(rawdata)[names(rawdata) == "20116-2.0"] <- "smoking_status"

rawdata$smoking_status[ rawdata$smoking_status == -3 ] = NA
rawdata$smoking_status[ rawdata$smoking_status == 2 ] = 1 # changes smoking status to never versus pervious and current categorical bin

rawdata$smoking_status <- factor(rawdata$smoking_status)


####################################################
# town and deprivation index
####################################################

names(rawdata)[names(rawdata) == "189-0.0"] <- "deprivation_index"

#greater the value the greater the deprivation # 

#split townsend into deciles

rawdata$Townsend_deciles <- quantcut(rawdata$deprivation_index , q = 10, na.rm=TRUE)

rawdata$Townsend_deciles <- as.numeric(rawdata$Townsend_deciles)


##########################
# educational attainment #
##########################

# As with publication Hagenaars et al 2016 converted education in a binary variable
# 0 = do not have college/uni degree OR 1 = those that have a uni degree
names(rawdata)[names(rawdata) == "6138-2.0"] <- "Education"

# there are multiple columns as people could specifiy multiple levels of education
rawdata$Education[ rawdata$Education == -3 ] = NA
rawdata$Education[ rawdata$Education == -7 ] = 7
rawdata$Education <- ifelse(rawdata$Education == 1, 1, 0)

#colnames(rawdata)



# remove other educational variables as we no longer need these

rawdata <- subset( rawdata, 
                           select = -c(`6138-2.1` , 
                                       `6138-2.2` , 
                                       `6138-2.3` ,
                                       `6138-2.4` , 
                                       `6138-2.5`
                           ) )



######################################
# age high bp diagnosed ############ 
####################################
# collected from participants who indicated they were told by a doctor that they have had high blood pressure

names(rawdata)[names(rawdata) == "2966-2.0"] <- "Age_highBP_diagnosed"
rawdata$Age_highBP_diagnosed[ rawdata$Age_highBP_diagnosed == -3 ] = NA


######################################
# age diabetes diagnosed ############ 
####################################
# collected from participants who indicated they were told by a doctor they had diabetes

names(rawdata)[names(rawdata) == "2976-2.0"] <- "Age_diabetes_diagnosed"
rawdata$Age_diabetes_diagnosed[ rawdata$Age_diabetes_diagnosed == -3 ] = NA


######################################
# diabetes diagnosed by a doctor ### 
####################################
# collected from participants who indicated they were told by a doctor that they have had high blood pressure

names(rawdata)[names(rawdata) == "2443-2.0"] <- "Diabetes_diagnosed_doctor"

rawdata$Diabetes_diagnosed_doctor[ rawdata$Diabetes_diagnosed_doctor == -3 ] = NA
rawdata$Diabetes_diagnosed_doctor[ rawdata$Diabetes_diagnosed_doctor == -1 ] = NA


######################################
# automated blood pressure ############ 
####################################
# The individal measures will be kept as well as the average dys and sys calculated
names(rawdata)[names(rawdata) == "4079-2.0"] <- "Diastolic_bp_1"
names(rawdata)[names(rawdata) == "4079-2.1"] <- "Diastolic_bp_2"

rawdata$Diastolic_bp_average <- rowMeans(rawdata[, c("Diastolic_bp_1","Diastolic_bp_2")
  ], na.rm = TRUE )
  
names(rawdata)[names(rawdata) == "4080-2.0"] <- "Systolic_bp_1"
names(rawdata)[names(rawdata) == "4080-2.1"] <- "Systolic_bp_2"


rawdata$Systolic_bp_average <- rowMeans(rawdata[, c("Systolic_bp_1", "Systolic_bp_2") ], na.rm = TRUE
                                         )

rawdata$Systolic_bp_average[rawdata$Systolic_bp_average == "NaN"] <- NA
rawdata$Diastolic_bp_average[rawdata$Diastolic_bp_average == "NaN"] <- NA


###########################################
# memory pairs matching round 2 - 6 pairs #
###########################################
names(rawdata)[names(rawdata) == "399-2.2"] <- "f.399.2.2_Memory_pm_6pairs"
# if any subject has > 30 errors this was capped at 30 as with Hagenaars et al 2016 paper
rawdata$f.399.2.2_Memory_pm_6pairs[rawdata$f.399.2.2_Memory_pm_6pairs > 30.99 ] <- 30
# check that there are no values > 30 for this variable
z <- rawdata$f.399.2.2_Memory_pm_6pairs > 30.99
stopifnot(sum(z, na.rm=TRUE) == 0)

#remove other memory scores variables from other rounds
rawdata <- subset( rawdata, 
                           select = -c(`399-2.1` , 
                                       `399-2.3`
                           ) )


############################################################
# TIME TO COMPLETE memory pairs matching round 2 - 6 pairs #
############################################################
names(rawdata)[names(rawdata) == "400-2.2"] <- "f.400.2.2_Memory_pm_6pairs_TIME"

#remove other memory scores variables from other rounds
rawdata <- subset( rawdata, 
                           select = -c(`400-2.1` , 
                                       `400-2.3`
                           ) )


##############################################################################
# Number of correct matches in round memory pairs matching round 2 - 6 pairs #
##############################################################################
# if this does not equal 6 then the person did not complete the test therefore replace with NA
names(rawdata)[names(rawdata) == "398-2.2"] <- "f.398.2.2_Memory_pm_6pairs_nMATCHES"

#remove other memory scores variables from other rounds
rawdata <- subset( rawdata,
                           select = -c(`398-2.1` ,
                                       `398-2.3`
                           ) )


#################################################################################################
# # replacing those who did not complete pairs matching due to time to complete test set at zero
#################################################################################################

# some ppts failed to complete test however this was set to 0 for pairs matching
# if time to undertake pairs matching was 0 we made the memory pairs matching results NA

# replace pairs matching with a zero value with NA
rawdata$f.400.2.2_Memory_pm_6pairs_TIME[rawdata$f.400.2.2_Memory_pm_6pairs_TIME == 0] <- NA

# replace where people did not get all 6 matches with NA
rawdata$f.398.2.2_Memory_pm_6pairs_nMATCHES[rawdata$f.398.2.2_Memory_pm_6pairs_nMATCHES < 6] <- NA

# number of people not completing all 6 matches 
#table(rawdata$f.398.2.2_Memory_pm_6pairs_nMATCHES == 6) ~1.75% didnt complete all 6

#replace pairs matching with NA where NA for TIME to take test was zero
rawdata$f.399.2.2_Memory_pm_6pairs = ifelse(is.na(rawdata$f.400.2.2_Memory_pm_6pairs_TIME), NA, rawdata$f.399.2.2_Memory_pm_6pairs)

#replace pairs matching with NA where NA for n matches <6 indicating they didnt complete the test
rawdata$f.399.2.2_Memory_pm_6pairs = ifelse(is.na(rawdata$f.398.2.2_Memory_pm_6pairs_nMATCHES), NA, rawdata$f.399.2.2_Memory_pm_6pairs)

###########################################
# Fluid intelligence #
###########################################
names(rawdata)[names(rawdata) == "20016-2.0"] <- "f.20016.2.0_fluid_intelligence"
stopifnot(is.numeric(rawdata$f.20016.2.0_fluid_intelligence))

names(rawdata)[names(rawdata) == "4924-2.0"] <- "f.4924_2fluid_intelligence_attempted"
stopifnot(is.numeric(rawdata$f.4924_2fluid_intelligence_attempted))

###########################################
# reaction time #
###########################################
names(rawdata)[names(rawdata) == "20023-2.0"] <- "f.20023.2.0_reaction_time"
stopifnot(is.numeric(rawdata$f.20023.2.0_reaction_time))

##########################################
# SD for Reaction time                   #
##########################################

# reaction time for each round
# only want to keep rounds 5+ for variables 401, 402 and 404

rawdata <- subset( rawdata,
                   select = -c(`401-2.0`,
                               `401-2.1` ,
                               `401-2.2` ,
                               `401-2.3` ,
                               `402-2.0` ,
                               `402-2.1` ,
                               `402-2.2` ,
                               `402-2.3` ,
                               `404-2.0` ,
                               `404-2.1` ,
                               `404-2.2` ,
                               `404-2.3`
                               
                   )
)

# create columns which tell you if cards matched for each round for RT
# for SD calcualtion we only want reaction time measures where the card indexes were the same
rawdata$RT_index_rnd4 <- rawdata$`401-2.4` == rawdata$`402-2.4`
rawdata$RT_index_rnd5 <- rawdata$`401-2.5` == rawdata$`402-2.5`
rawdata$RT_index_rnd6 <- rawdata$`401-2.6` == rawdata$`402-2.6`
rawdata$RT_index_rnd7 <- rawdata$`401-2.7` == rawdata$`402-2.7`
rawdata$RT_index_rnd8 <- rawdata$`401-2.8` == rawdata$`402-2.8`
rawdata$RT_index_rnd9 <- rawdata$`401-2.9` == rawdata$`402-2.9`
rawdata$RT_index_rnd10 <- rawdata$`401-2.10` == rawdata$`402-2.10`
rawdata$RT_index_rnd11 <- rawdata$`401-2.11` == rawdata$`402-2.11`

# for actual reaction time columns remove values that are < 50ms and > 2000ms

rawdataa <- rawdata

rawdata$`404-2.4`[ rawdata$`404-2.4` < 50 | rawdata$`404-2.4` > 2000 ] = NA
rawdata$`404-2.5`[ rawdata$`404-2.5` < 50 | rawdata$`404-2.5` > 2000 ] = NA
rawdata$`404-2.6`[ rawdata$`404-2.6` < 50 | rawdata$`404-2.6` > 2000 ] = NA
rawdata$`404-2.7`[ rawdata$`404-2.7` < 50 | rawdata$`404-2.7` > 2000 ] = NA
rawdata$`404-2.8`[ rawdata$`404-2.8` < 50 | rawdata$`404-2.8` > 2000 ] = NA
rawdata$`404-2.9`[ rawdata$`404-2.9` < 50 | rawdata$`404-2.9` > 2000 ] = NA
rawdata$`404-2.10`[ rawdata$`404-2.10` < 50 | rawdata$`404-2.10` > 2000 ] = NA
rawdata$`404-2.11`[ rawdata$`404-2.11` < 50 | rawdata$`404-2.11` > 2000 ] = NA


# for each column if another column equals false then turn to NA then do SD calculation

# for safety duplicate all of the RT variables 
rawdata$`404-2.4a` <- rawdata$`404-2.4`
rawdata$`404-2.5a` <- rawdata$`404-2.5`
rawdata$`404-2.6a` <- rawdata$`404-2.6`
rawdata$`404-2.7a` <- rawdata$`404-2.7`
rawdata$`404-2.8a` <- rawdata$`404-2.8`
rawdata$`404-2.9a` <- rawdata$`404-2.9`
rawdata$`404-2.10a` <- rawdata$`404-2.10`
rawdata$`404-2.11a` <- rawdata$`404-2.11`

# turn any one with FALSE for matching cards column into NA

rawdata$`404-2.4`[ rawdata$RT_index_rnd4 == FALSE ] = NA
rawdata$`404-2.5`[ rawdata$RT_index_rnd5 == FALSE ] = NA
rawdata$`404-2.6`[ rawdata$RT_index_rnd6 == FALSE ] = NA #now no one has answered for this as pairs for RT did not match
rawdata$`404-2.7`[ rawdata$RT_index_rnd7 == FALSE ] = NA
rawdata$`404-2.8`[ rawdata$RT_index_rnd8 == FALSE ] = NA #now no one has answered for this as pairs for RT did not match
rawdata$`404-2.9`[ rawdata$RT_index_rnd9 == FALSE ] = NA #now no one has answered for this as pairs for RT did not match
rawdata$`404-2.10`[ rawdata$RT_index_rnd10 == FALSE ] = NA
rawdata$`404-2.11`[ rawdata$RT_index_rnd11 == FALSE ] = NA

# now calculate SD for all rows ignoring NA values

rawdata$ReactionTime_SD <- apply(rawdata[,c("404-2.4",
                                   "404-2.5",
                                   "404-2.6",
                                   "404-2.7",
                                   "404-2.8",
                                   "404-2.9",
                                   "404-2.10",
                                   "404-2.11")]
                        , 1,sd, na.rm = TRUE)


rawdata <- subset( rawdata,
                   select = -c(`401-2.4` ,
                               `401-2.5` ,
                               `401-2.6` ,
                               `401-2.7` ,
                               `401-2.8` , 
                               `401-2.9` ,
                               `401-2.10` , 
                               `401-2.11` ,
                               `402-2.4` ,
                               `402-2.5` ,
                               `402-2.6` ,
                               `402-2.7` ,
                               `402-2.8` , 
                               `402-2.9` ,
                               `402-2.10` , 
                               `402-2.11` ,
                               `404-2.4` ,
                               `404-2.5` ,
                               `404-2.6` ,
                               `404-2.7` ,
                               `404-2.8` , 
                               `404-2.9` ,
                               `404-2.10` , 
                               `404-2.11`
                               
                   )
)

## remove the extra columns ##
rawdata <- subset( rawdata,
                   select = -c(RT_index_rnd4 ,
                               RT_index_rnd5,
                               RT_index_rnd6 ,
                               RT_index_rnd7 ,
                               RT_index_rnd8 , 
                               RT_index_rnd9 ,
                               RT_index_rnd10 , 
                               RT_index_rnd11 ,
                               `404-2.4a` ,
                               `404-2.5a` ,
                               `404-2.6a` ,
                               `404-2.7a` ,
                               `404-2.8a` , 
                               `404-2.9a` ,
                               `404-2.10a` , 
                               `404-2.11a`
                               
                   )
)


################################
# ethnicity ##
###################################
names(rawdata)[names(rawdata) == "21000-2.0"] <- "Ethnicity"

names(rawdata)[names(rawdata) == "21000-0.0"] <- "Ethnicity_baseline"

rawdata$Ethnicity[ rawdata$Ethnicity == -3 ] = NA
rawdata$Ethnicity[ rawdata$Ethnicity == -1 ] = NA

rawdata$Ethnicity[ rawdata$Ethnicity == 1001 ] = 1
rawdata$Ethnicity[ rawdata$Ethnicity == 1002 ] = 1
rawdata$Ethnicity[ rawdata$Ethnicity == 1003 ] = 1

rawdata$Ethnicity[ rawdata$Ethnicity > 1 ] = 0
#missing alot of ethnicity in imaging visit but as ethnicity is crystallised can use from baseline


rawdata$Ethnicity_baseline[ rawdata$Ethnicity_baseline == -3 ] = NA
rawdata$Ethnicity_baseline[ rawdata$Ethnicity_baseline == -1 ] = NA

rawdata$Ethnicity_baseline[ rawdata$Ethnicity_baseline == 1001 ] = 1
rawdata$Ethnicity_baseline[ rawdata$Ethnicity_baseline == 1002 ] = 1
rawdata$Ethnicity_baseline[ rawdata$Ethnicity_baseline == 1003 ] = 1

rawdata$Ethnicity_baseline[ rawdata$Ethnicity_baseline > 1 ] = 0

#replace ethnicity at wave 3 with baseline information (wont change over time and even if some misclassfication this will not effect the results greatly as majority of cohort is white)
rawdata$Ethnicity <- rawdata$Ethnicity_baseline

rawdata$Ethnicity[rawdata$Ethnicity_baseline == 1 & is.na(rawdata$Ethnicity)] <- 1
rawdata$Ethnicity[rawdata$Ethnicity_baseline == 0 & is.na(rawdata$Ethnicity)] <- 0


################################
# BMI ##
###################################
names(rawdata)[names(rawdata) == "21001-2.0"] <- "BMI"


################################
# alcohol intake ##
###################################
names(rawdata)[names(rawdata) == "1558-2.0"] <- "f1558_alcohol_intake"
rawdata$f1558_alcohol_intake[ rawdata$f1558_alcohol_intake == -3 ] = NA


###################################
#"2090-2.0" Seen doctor (GP) for nerves, anxiety, tension or depression
names(rawdata)[names(rawdata) == "2090-2.0"] <- "f2090_seenGP_anxiety_depression"
rawdata$f2090_seenGP_anxiety_depression[ rawdata$f2090_seenGP_anxiety_depression == -3 ] = NA
rawdata$f2090_seenGP_anxiety_depression[ rawdata$f2090_seenGP_anxiety_depression == -1 ] = NA

#####################################
# 2100-2.0 Seen psychaitrist for nerves, anxiety, tension or depression
names(rawdata)[names(rawdata) == "2100-2.0"] <- "f2100_seen_psychiatrist_anxiety_depression"
rawdata$f2100_seen_psychiatrist_anxiety_depression[ rawdata$f2100_seen_psychiatrist_anxiety_depression == -3 ] = NA
rawdata$f2100_seen_psychiatrist_anxiety_depression[ rawdata$f2100_seen_psychiatrist_anxiety_depression == -1 ] = NA

###########################################
# for trails makers A and B anyone with a value of 0 is set to missing i.e. NA
#Those with a score coded as 0 (denoting “Trail not completed”) had their score set to missing.

#table(rawdata$f6348_Duration_trailA == 0)
rawdata$f6348_Duration_trailA[ rawdata$f6348_Duration_trailA == 0 ] = NA

#table(rawdata$f6350_Duration_trailB == 0)
rawdata$f6350_Duration_trailB[ rawdata$f6350_Duration_trailB == 0 ] = NA

rawdata$f6350_Duration_trailB[ rawdata$f6350_Duration_trailB >= 2500 ] = NA

# table(newcogtests_rawdata$f6348_Duration_trailA)
# 
# table(newcogtests_rawdata$f6350_Duration_trailB)
#########################################
# creating a cogntive test measure which takes TMT from TMTa
rawdata$TMTB_MINUS_TMTA <- rawdata$f6350_Duration_trailB - rawdata$f6348_Duration_trailA

rawdata$TMTB_MINUS_TMTA[rawdata$TMTB_MINUS_TMTA < 0 ] <- NA

rawdata$TMTB_MINUS_TMTA[rawdata$TMTB_MINUS_TMTA > 1500 ] <- NA
  

#########################################
#remove columns we dont need

rawdata_cog <- subset( rawdata,
                       select = -c(Ethnicity_baseline,
                                   f.4924_2fluid_intelligence_attempted,
                                   f.398.2.2_Memory_pm_6pairs_nMATCHES,
                                   f.400.2.2_Memory_pm_6pairs_TIME,
                                  # Diastolic_bp_1,
                                   #Diastolic_bp_2,
                                   #Systolic_bp_1,
                                   #Systolic_bp_2,
                                   Ethnicity_baseline,
                                   `6153-2.0`,
                                   `6153-2.1`,                                  
                                   `6153-2.2` ,
                                   `6153-2.3`  ,                              
                                   `6177-2.0` ,
                                   `6177-2.1`  ,                               
                                   `6177-2.2`
                       )
)

Cognition_demographics_subset_CLEANED <- rawdata_cog


save(Cognition_demographics_subset_CLEANED, file = paste(saving_directory,"CLEANED_cog_demo_imaging_people_only_131220.Rdata", sep = ""))

```

**STEP 6** Read in the APOE genotype
```{r loadUKBB5, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE }
### read in genotyping for the dataset
# 0 no risk genes 1 = 1 risk gene and 2 = both risk genes

tic()

APOE_genotypes <-  fread("N:/UKB/CADIZ_Project_Data/APOE_Immuno_CADIZ_Bridgefile/APOE_Immuno_CADIZ_Bridgefile.txt",
                              header=TRUE,
                                sep=" ",
                               verbose = T)

toc()


# remove weird data from beginning

APOE_genotypes <- APOE_genotypes[c(12:487409),]

APOE_genotypes <- APOE_genotypes[,c(2,3)]

# rename columns

colnames(APOE_genotypes) <- c("eid", "APOE_genotype")

 
 #subset to those that have imaging data
load(paste(saving_directory, "brain_imaging_compiled_13122020.Rdata", sep=""))
 
APOE_genotypes <- subset(APOE_genotypes , APOE_genotypes$eid %in% Brain_imaging_subset$eid)


save(APOE_genotypes, file = paste(saving_directory,"APOE_genotypes_13dec20.Rdata", sep =""))

```

**STEP 7** merging demographics, first occurence, brain imaging, genotyping into one dataframe
```{r loadUKBB6, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE }


load(file = paste(saving_directory,"CLEANED_cog_demo_imaging_people_only_131220.Rdata", sep = ""))

#brain imaging
load(file = paste(saving_directory, "brain_imaging_compiled_13122020.Rdata", sep=""))

#first occurance
load(file = paste(saving_directory, "first_occurence_subset_compiled_13122020.Rdata", sep=""))

#genotyping
load(file = paste(saving_directory,"APOE_genotypes_13dec20.Rdata", sep =""))


# MERGE ALL THE DATASETS TOGETHER

Full_dataset_v1 <- merge(Brain_imaging_subset, Cognition_demographics_subset_CLEANED,  by = "eid")

Full_dataset_v1 <- merge(Full_dataset_v1, first_occurence_subset,  by = "eid", all = T)

Full_dataset_v1 <- merge(Full_dataset_v1, APOE_genotypes,  by = "eid", all = T)


# remove people with neurological conditions that could impact the results

#Full_dataset_v1 <- subset(Full_dataset_v1, Full_dataset_v1$people2exlcude == 0)

# only include people with blood pressure for second reading

Full_dataset_v1 <- subset(Full_dataset_v1, !is.na(Full_dataset_v1$Systolic_bp_2) & !is.na(Full_dataset_v1$Diastolic_bp_2))
# goes down to 31253

save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_1312020_v1.Rdata", sep =""))


```

**STEP 7a** Removing participants who have withdrawn
```{r withdrawn , echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

load(file = paste(saving_directory,"Full_dataset_1312020_v1.Rdata", sep =""))

# read in list of people who have withdrawn

withdrawnlist <- "N:/UKB/CADIZ_Project_Data/Withdrawn Participants/w43309_20210201.csv"

withdrawn <- read.table(withdrawnlist, sep = ",", header = FALSE)

withdrawn <- withdrawn$V1

#subset out of main database

Full_dataset_v1 <- subset(Full_dataset_v1, !(Full_dataset_v1$eid %in% withdrawn) )


save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))


```

**STEP 8** updating variables hypertension, diabetes, high cholesterol using self reported and medications and creating variables for analysis i.e undiagnosed hypertension
```{r loadUKBB7, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE }

load(file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))

#updating diabetes using first occurence data
Full_dataset_v1$diabetes[Full_dataset_v1$`f130707-0-0_source__insulin_dependentDM` > 1 & Full_dataset_v1$Date_of_visit >
                           Full_dataset_v1$`f130706-0-0_Date_insulin_dependentDM` 
                         
                         |
                           
                           Full_dataset_v1$`f130709-0-0_source_noninsulin_dependentDM` > 1 &
                           Full_dataset_v1$Date_of_visit >
                           Full_dataset_v1$`f130708-0-0_Date_noninsulin_dependentDM` 
                         
                         |
                           
                           Full_dataset_v1$`f130711-0-0_source_malnutrition_dependentDM` > 1 &
                           Full_dataset_v1$Date_of_visit >
                           Full_dataset_v1$`f130710-0-0_Date_malnutrition_dependentDM` 
                         
                         | 
                           Full_dataset_v1$`f130713-0-0_source_other_specifiedDM` > 1 &
                           Full_dataset_v1$Date_of_visit >
                           Full_dataset_v1$`f130712-0-0_Date_other_specifiedDM` 
                         
                         |
                           Full_dataset_v1$`f130715-0-0_source_unspecified_DM` > 1 &
                           Full_dataset_v1$Date_of_visit >
                           Full_dataset_v1$`f130714-0-0_Date_unspecified_DM` 
                         
] <- 1

# medications (insulin)
Full_dataset_v1$diabetes[Full_dataset_v1$Insulin_medications] <- 1

# age diabetes diagnosed
Full_dataset_v1$diabetes[!is.na(Full_dataset_v1$Age_diabetes_diagnosed)] <- 1

##############################
# updaing those with high cholesterol using self reported and taking medication for high cholesterol

Full_dataset_v1$high_chol[Full_dataset_v1$Cholesterol_medications == 1] <- 1

###################################
# updating hypertension to include those with self reported hypertension,

#self reported
table(Full_dataset_v1$hypertension)

#taking bp medications
Full_dataset_v1$hypertension[Full_dataset_v1$BP_medications == 1] <- 1

#age high bp diagnosed
Full_dataset_v1$hypertension[!is.na(Full_dataset_v1$Age_highBP_diagnosed)] <- 1

# change this to self_reported hypertension
Full_dataset_v1$hypertension_self_reported <- Full_dataset_v1$hypertension

table(Full_dataset_v1$hypertension_self_reported)

#####################################################################
# creating hypertension variable using blood pressure

Full_dataset_v1$hypertension <-  Full_dataset_v1$Systolic_bp_2 >= 140 | Full_dataset_v1$Diastolic_bp_2 >= 90

#update to also include people taking any bp meds as hypertensive
Full_dataset_v1$hypertension[Full_dataset_v1$BP_medications == 1] <- 1

Full_dataset_v1$hypertension[!is.na(Full_dataset_v1$Age_highBP_diagnosed)] <- 1


###################################################################################
# creating a multi-level bp level 0 = < 120/80 1 = 120/80 - 140/90, 2 = 140/90
# Blood pressure readings between 120/80mmHg and 140/90mmHg

Full_dataset_v1$hypertension_ML <-  Full_dataset_v1$Systolic_bp_2 >= 120 | Full_dataset_v1$Diastolic_bp_2 >= 80

Full_dataset_v1$hypertension_ML[Full_dataset_v1$hypertension == 1] <- 2


###########################################################
# creating length of hypertension based on self reported  #
###########################################################

# create a new variable how long has someone had hypertension using age that high bp was diagnosed and age of assessment >> THIS IS BASED ON THE SELF REPORTED

# removes those who said do not know to age high bp was diagnosed
Full_dataset_v1$Age_highBP_diagnosed[Full_dataset_v1$Age_highBP_diagnosed == -1 ] = NA

Full_dataset_v1$length_of_hypertension_self_reported <- 
Full_dataset_v1$Age_at_assessment - Full_dataset_v1$Age_highBP_diagnosed

#####################################################################
# creating undiagnosed hypertension variable
#####################################################################

# create a new column stating if BP sys and dia are above acceptable limits - we can then merge this with 
Full_dataset_v1$undiagnosed_hypertension <-  Full_dataset_v1$Systolic_bp_2 > 140 | Full_dataset_v1$Diastolic_bp_2 > 90
table(Full_dataset_v1$undiagnosed_hypertension)


# remove those people that are already have hypertension
Full_dataset_v1$undiagnosed_hypertension[Full_dataset_v1$hypertension == 1 
                                                        ] <- NA
table(Full_dataset_v1$undiagnosed_hypertension)


######################################################################################
#create a variable combining diagnosied and undiagnosed hypertension as 1 and 0 for controls ### hypertension (diagnosed/undiagnosed) == 1
#######################################################################################

Full_dataset_v1$diagnosed_undiagnosed_Hypertension <- Full_dataset_v1$hypertension
# replace with 1 those who have undiagnosed hypertension
Full_dataset_v1$diagnosed_undiagnosed_Hypertension[Full_dataset_v1$undiagnosed_hypertension == TRUE] <- 1

table(Full_dataset_v1$diagnosed_undiagnosed_Hypertension)
# healthy = 0 and 1 with hypertension(diagnosed/undiagnosed)
 

# for the normatensive people remove those with missing bp values as this might affect the results

Full_dataset_v1$diagnosed_undiagnosed_Hypertension[Full_dataset_v1$diagnosed_undiagnosed_Hypertension == 0 &

                                                               is.na(Full_dataset_v1$Systolic_bp_2)
                                                                               ] <- NA



Full_dataset_v1$diagnosed_undiagnosed_Hypertension[Full_dataset_v1$diagnosed_undiagnosed_Hypertension == 0 &

                                                               is.na(Full_dataset_v1$Diastolic_bp_2)
                                                                               ] <- NA


table(Full_dataset_v1$diagnosed_undiagnosed_Hypertension)
# healthy = 0 and 1 with hypertension(diagnosed/undiagnosed)


##########################################################################################
# create a variable with only diagnosed hypertension and undiagnosed only (want to see if there is a difference between pre hypertensive and current hpt) ## removing healthy people
#######################################################################################

Full_dataset_v1$hpt_diag_undiagnosed_only <- Full_dataset_v1$hypertension
# code in people with undiagnosed hypertension and then remove healthly people
Full_dataset_v1$hpt_diag_undiagnosed_only[Full_dataset_v1$undiagnosed_hypertension == TRUE] <- 2
Full_dataset_v1$hpt_diag_undiagnosed_only[Full_dataset_v1$hpt_diag_undiagnosed_only == 0] <- NA
Full_dataset_v1$hpt_diag_undiagnosed_only[Full_dataset_v1$hpt_diag_undiagnosed_only == 2] <- 0

table(Full_dataset_v1$hpt_diag_undiagnosed_only)
# 0 is undiagnosed hypertension, 1 = diagnosed hypertension


###################################################################################
#create a multi level variable with 0 healthy, 1 = undiagnosed and 2 = diagnosed
###################################################################################
Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension <- Full_dataset_v1$hypertension
Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension[Full_dataset_v1$undiagnosed_hypertension == TRUE] <- 3
Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension[Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension == 1] <- 2
Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension[Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension == 3] <- 1

table(Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension)

# removing people with no bp measures as these might be pre hypertensive but we dont know because bp is missing

Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension[Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension == 0 &

                                                               is.na(Full_dataset_v1$Systolic_bp_2)
                                                                               ] <- NA


Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension[Full_dataset_v1$multi_level_healthy_undiag_diag_hypertension == 0 &

                                                               is.na(Full_dataset_v1$Systolic_bp_2)
 ] <- NA
# the above removes people with no bp values for healthy people as this could be misclassifications


#########################################################################################
# create a healthy plus only diagnosed hpt group and removing those with undiagnosed hypertension
#########################################################################################
Full_dataset_v1$healthy_v_diagnosed_hpt_only <- Full_dataset_v1$hypertension

Full_dataset_v1$healthy_v_diagnosed_hpt_only[Full_dataset_v1$undiagnosed_hypertension == TRUE] <- NA

table(Full_dataset_v1$healthy_v_diagnosed_hpt_only) #

# remove those with no bp value as this could be classed a pre tensive but cant because the data is missing


Full_dataset_v1$healthy_v_diagnosed_hpt_only[Full_dataset_v1$healthy_v_diagnosed_hpt_only == 0 &

                                                               is.na(Full_dataset_v1$Systolic_bp_2)
                                                                               ] <- NA


Full_dataset_v1$healthy_v_diagnosed_hpt_only[Full_dataset_v1$healthy_v_diagnosed_hpt_only == 0 &

                                                               is.na(Full_dataset_v1$Diastolic_bp_2)
                                                                               ] <- NA

table(Full_dataset_v1$healthy_v_diagnosed_hpt_only) #



###################################################################################
# Isolated hypertension groups with medications COMBINED
###################################################################################
# in this variable we are creating a variable with four levels based on bp readings and using bp lowering medications

# this will create 4 groups
# hypertensive no drug
# hypertensive with bp lowering (uncontrolled hypertension)
# normotensive no drug (REF level)
# normotensive with bp lowering medication (controlled hypertension)


Full_dataset_v1$isolated_hpt_with_drugs <- Full_dataset_v1$Diastolic_bp_2 >= 90 | Full_dataset_v1$Systolic_bp_2 >= 140

Full_dataset_v1$isolated_hpt_with_drugs <- as.integer(Full_dataset_v1$isolated_hpt_with_drugs)

# high blood pressure and taking medications
Full_dataset_v1$isolated_hpt_with_drugs[Full_dataset_v1$isolated_hpt_with_drugs == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

#high blood pressure but not taking any medications
Full_dataset_v1$isolated_hpt_with_drugs[Full_dataset_v1$isolated_hpt_with_drugs == 1 & Full_dataset_v1$BP_medications == 0 ] <- 2

#low bp and taking any bp drugs (controlled hpt?)
Full_dataset_v1$isolated_hpt_with_drugs[Full_dataset_v1$isolated_hpt_with_drugs == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 3


#normotensive and not taking bp drugs
Full_dataset_v1$isolated_hpt_with_drugs[Full_dataset_v1$isolated_hpt_with_drugs == 0] <- 1

# turn into a factor
Full_dataset_v1$isolated_hpt_with_drugs <- as.factor(Full_dataset_v1$isolated_hpt_with_drugs)


###################################################################################
# Isolated hypertension groups SYSTOLIC with medications COMBINED
###################################################################################
# in this variable we are creating a variable with four levels based on bp readings and using bp lowering medications

# this will create 4 groups
# hypertensive no drug
# hypertensive with bp lowering (uncontrolled hypertension)
# normotensive no drug (REF level)
# normotensive with bp lowering medication (controlled hypertension)



# Isolated systolic hypertension. 140

Full_dataset_v1$isolated_sys_hpt_with_drugs <- Full_dataset_v1$Systolic_bp_2 >= 140 & Full_dataset_v1$Diastolic_bp_2 < 90

Full_dataset_v1$isolated_sys_hpt_with_drugs <- as.integer(Full_dataset_v1$isolated_sys_hpt_with_drugs)

# high blood pressure and taking medications
Full_dataset_v1$isolated_sys_hpt_with_drugs[Full_dataset_v1$isolated_sys_hpt_with_drugs == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

#high blood pressure but not taking any medications
Full_dataset_v1$isolated_sys_hpt_with_drugs[Full_dataset_v1$isolated_sys_hpt_with_drugs == 1 & Full_dataset_v1$BP_medications == 0 ] <- 2

#low bp and taking any bp drugs (controlled hpt?)
Full_dataset_v1$isolated_sys_hpt_with_drugs[Full_dataset_v1$isolated_sys_hpt_with_drugs == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 3


#normotensive and not taking bp drugs
Full_dataset_v1$isolated_sys_hpt_with_drugs[Full_dataset_v1$isolated_sys_hpt_with_drugs == 0] <- 1

# turn into a factor
Full_dataset_v1$isolated_sys_hpt_with_drugs <- as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs)

#     1     2     3     4 
# 17650  6794  3932  3137 

###################################################################################
# Isolated hypertension groups DIASTOLIC with medications COMBINED
###################################################################################
# in this variable we are creating a variable with four levels based on bp readings and using bp lowering medications

# this will create 4 groups
# hypertensive no drug
# hypertensive with bp lowering (uncontrolled hypertension)
# normotensive no drug (REF level)
# normotensive with bp lowering medication (controlled hypertension)

# Isolated diastolic hypertension. 90

Full_dataset_v1$isolated_dia_hpt_with_drugs <- Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Systolic_bp_2 < 140

Full_dataset_v1$isolated_dia_hpt_with_drugs <- as.integer(Full_dataset_v1$isolated_dia_hpt_with_drugs)

# high blood pressure and taking medications
Full_dataset_v1$isolated_dia_hpt_with_drugs[Full_dataset_v1$isolated_dia_hpt_with_drugs == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

#high blood pressure but not taking any medications
Full_dataset_v1$isolated_dia_hpt_with_drugs[Full_dataset_v1$isolated_dia_hpt_with_drugs == 1 & Full_dataset_v1$BP_medications == 0 ] <- 2

#low bp and taking any bp drugs (controlled hpt?)
Full_dataset_v1$isolated_dia_hpt_with_drugs[Full_dataset_v1$isolated_dia_hpt_with_drugs == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 3


#normotensive and not taking bp drugs
Full_dataset_v1$isolated_dia_hpt_with_drugs[Full_dataset_v1$isolated_dia_hpt_with_drugs == 0] <- 1

# turn into a factor
Full_dataset_v1$isolated_dia_hpt_with_drugs <- as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs)

#     1     2     3     4 
# 24121   323  6929   140 

###########################################################################################

###################################################################################
# Isolated hypertension groups SYSTOLIC with medications COMBINED using 130/80 instead
###################################################################################
# in this variable we are creating a variable with four levels based on bp readings and using bp lowering medications

# this will create 4 groups
# hypertensive no drug
# hypertensive with bp lowering (uncontrolled hypertension)
# normotensive no drug (REF level)
# normotensive with bp lowering medication (controlled hypertension)

# Isolated systolic hypertension. 130

Full_dataset_v1$isolated_sys_hpt_with_drugs13080 <- Full_dataset_v1$Systolic_bp_2 >= 130 & Full_dataset_v1$Diastolic_bp_2 < 80

Full_dataset_v1$isolated_sys_hpt_with_drugs13080 <- as.integer(Full_dataset_v1$isolated_sys_hpt_with_drugs13080)

# high blood pressure and taking medications
Full_dataset_v1$isolated_sys_hpt_with_drugs13080[Full_dataset_v1$isolated_sys_hpt_with_drugs13080 == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

#high blood pressure but not taking any medications
Full_dataset_v1$isolated_sys_hpt_with_drugs13080[Full_dataset_v1$isolated_sys_hpt_with_drugs13080 == 1 & Full_dataset_v1$BP_medications == 0 ] <- 2

#low bp and taking any bp drugs (controlled hpt?)
Full_dataset_v1$isolated_sys_hpt_with_drugs13080[Full_dataset_v1$isolated_sys_hpt_with_drugs13080 == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 3


#normotensive and not taking bp drugs
Full_dataset_v1$isolated_sys_hpt_with_drugs13080[Full_dataset_v1$isolated_sys_hpt_with_drugs13080 == 0] <- 1

# turn into a factor
Full_dataset_v1$isolated_sys_hpt_with_drugs13080 <- as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs13080)

#     1     2     3     4 
# 18579  5865  4763  2306 

###################################################################################
# Isolated hypertension groups DIASTOLIC with medications COMBINED 130/80
###################################################################################
# in this variable we are creating a variable with four levels based on bp readings and using bp lowering medications

# this will create 4 groups
# hypertensive no drug
# hypertensive with bp lowering (uncontrolled hypertension)
# normotensive no drug (REF level)
# normotensive with bp lowering medication (controlled hypertension)

# Isolated diastolic hypertension. 80

Full_dataset_v1$isolated_dia_hpt_with_drugs13080 <- Full_dataset_v1$Diastolic_bp_2 >= 80 & Full_dataset_v1$Systolic_bp_2 < 130

Full_dataset_v1$isolated_dia_hpt_with_drugs13080 <- as.integer(Full_dataset_v1$isolated_dia_hpt_with_drugs13080)

# high blood pressure and taking medications
Full_dataset_v1$isolated_dia_hpt_with_drugs13080[Full_dataset_v1$isolated_dia_hpt_with_drugs13080 == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

#high blood pressure but not taking any medications
Full_dataset_v1$isolated_dia_hpt_with_drugs13080[Full_dataset_v1$isolated_dia_hpt_with_drugs13080 == 1 & Full_dataset_v1$BP_medications == 0 ] <- 2

#low bp and taking any bp drugs (controlled hpt?)
Full_dataset_v1$isolated_dia_hpt_with_drugs13080[Full_dataset_v1$isolated_dia_hpt_with_drugs13080 == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 3


#normotensive and not taking bp drugs
Full_dataset_v1$isolated_dia_hpt_with_drugs13080[Full_dataset_v1$isolated_dia_hpt_with_drugs13080 == 0] <- 1

# turn into a factor
Full_dataset_v1$isolated_dia_hpt_with_drugs13080 <- as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs13080)

#     1     2     3     4 
# 23204  1240  6818   251 


#############################################################################
# quartile of length of hypertension
#########################################################

Full_dataset_v1$length_of_hypertension_QUARTILES <- quantcut(Full_dataset_v1$length_of_hypertension_self_reported , q = 4, na.rm=TRUE)

#cut offs at <5 years, 6-11 years, 12-17 years, > 18 years

q1 <- subset(Full_dataset_v1, Full_dataset_v1$length_of_hypertension_QUARTILES == "[0,5]")
table(q1$length_of_hypertension_self_reported)

q2 <- subset(Full_dataset_v1, Full_dataset_v1$length_of_hypertension_QUARTILES == "(5,11]")
table(q2$length_of_hypertension_self_reported)

q3 <- subset(Full_dataset_v1, Full_dataset_v1$length_of_hypertension_QUARTILES == "(11,17]")
table(q3$length_of_hypertension_self_reported)

q4 <- subset(Full_dataset_v1, Full_dataset_v1$length_of_hypertension_QUARTILES == "(17,55]")
table(q4$length_of_hypertension_self_reported)


Full_dataset_v1$length_of_hypertension_QUARTILES <- as.numeric(Full_dataset_v1$length_of_hypertension_QUARTILES)

### rename the quartiles with numbers

   
 
#############################################################################
# quartile of length of hypertension INCLUDING normotensive people
############################################################################

Full_dataset_v1$length_of_hypertension_QUARTILES_plushealthy <- Full_dataset_v1$length_of_hypertension_QUARTILES


# replace 0 for normatensive people

Full_dataset_v1$length_of_hypertension_QUARTILES_plushealthy[Full_dataset_v1$hypertension == 0 & is.na(Full_dataset_v1$length_of_hypertension_QUARTILES_plushealthy) ] <- 0

##################################################################################
# create APOE binary level 
####################################################################################

Full_dataset_v1$APOE_genotype_binary <- Full_dataset_v1$APOE_genotype


Full_dataset_v1$APOE_genotype_binary[Full_dataset_v1$APOE_genotype_binary == 2] <- 1

#######################################################################
# extra isolated hypertension with extra level 

# ISH # IDH for table 1
Full_dataset_v1$isolated_systolic_hypertension <- Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Systolic_bp_2 < 140

Full_dataset_v1$isolated_systolic_hypertension <- as.integer(Full_dataset_v1$isolated_systolic_hypertension)

Full_dataset_v1$isolated_systolic_hypertension[
  
  Full_dataset_v1$Systolic_bp_2 >= 140 & Full_dataset_v1$Diastolic_bp_2 < 90
  
] <- 2

#     0     1     2 
# 21119   463  9931 

# add in extra level of those with both high systolic and diastolic

Full_dataset_v1$isolated_systolic_hypertension[
  
  Full_dataset_v1$Systolic_bp_2 >= 140 & Full_dataset_v1$Diastolic_bp_2 >= 90
  
] <- 3



# DIASTOLIC 
# only including those with isolated sys or diastolic
# isolated high sys with no med
# isolated high sys with meds
# isolated low sys with no med
# isolated low sys with meds

# isolated high sys/dia with no med
# isolated low sys/dia with meds

#step 1 those with both systolic and diastolic high bp 


Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth <- Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Diastolic_bp_2 >= 140

Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth <- as.integer(Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth)


Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth[Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 2
# 1 = people with both high sys and high dia not taking bp meds
# 2 = people with both high sys ANS dia AND taking bp meds


Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth[Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth == 0 &
  
 Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Systolic_bp_2 < 140] <- 3

Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth[Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth == 3 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

# 3 high isolated diastolic bp not taking bp meds
# 4 high isolated diastolic bp taking bp meds


Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth[Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 5
# 5 low diastolic bp and taking bp meds
# 0 low diastolic bp and not taking bp meds



# 0 low diastolic bp and not taking bp meds
# 1 = people with both high sys and high dia not taking bp meds
# 2 = people with both high sys ANS dia AND taking bp meds
# 3 high isolated diastolic bp not taking bp meds
# 4 high isolated diastolic bp taking bp meds
# 5 low diastolic bp and taking bp meds




#######################################################################
# extra isolated hypertension with extra level 

# SYSTOLIC
# only including those with isolated sys or diastolic
# isolated high sys with no med
# isolated high sys with meds
# isolated low sys with no med
# isolated low sys with meds

# isolated high sys/dia with no med
# isolated low sys/dia with meds

#step 1 those with both systolic and diastolic high bp 


Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth <- Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Systolic_bp_2 >= 140

Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth <- as.integer(Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth)


Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth[Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 2
# 1 = people with both high sys and high dia not taking bp meds
# 2 = people with both high sys ANS dia AND taking bp meds


Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth[Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth == 0 &
  
 Full_dataset_v1$Diastolic_bp_2 < 90 & Full_dataset_v1$Systolic_bp_2 >= 140] <- 3

Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth[Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth == 3 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

# 3 high isolated systolic bp not taking bp meds
# 4 high isolated systolic bp taking bp meds


Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth[Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 5
# 5 low diastolic bp and taking bp meds
# 0 low diastolic bp and not taking bp meds



# 0 low diastolic bp and not taking bp meds
# 1 = people with both high sys and high dia not taking bp meds
# 2 = people with both high sys ANS dia AND taking bp meds
# 3 high isolated diastolic bp not taking bp meds
# 4 high isolated diastolic bp taking bp meds
# 5 low diastolic bp and taking bp meds


Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth <- Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Systolic_bp_2 >= 140

Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth <- as.integer(Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth)


Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth[Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth == 1 &
  
  Full_dataset_v1$BP_medications == 1] <- 2
# 1 = people with both high sys and high dia not taking bp meds
# 2 = people with both high sys ANS dia AND taking bp meds


Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth[Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth == 0 &
  
 Full_dataset_v1$Diastolic_bp_2 < 90 & Full_dataset_v1$Systolic_bp_2 >= 140] <- 3


Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth[Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth == 3 &
  
  Full_dataset_v1$BP_medications == 1] <- 4

# 3 high isolated systolic bp not taking bp meds
# 4 high isolated systolic bp taking bp meds


Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth[Full_dataset_v1$isolated_DIA_hpt_with_drugs_incboth == 0 &
  
  Full_dataset_v1$BP_medications == 1] <- 5





# for isoliated hypertension variables
# for systolic removing those with high disatolic bp in 
Full_dataset_v1$isolated_sys_hpt_with_drugs_1 <- Full_dataset_v1$isolated_sys_hpt_with_drugs

#remove those with high diastolic from groups 1 and 2

Full_dataset_v1$isolated_sys_hpt_with_drugs_1[Full_dataset_v1$Diastolic_bp_2 >= 90
                                              
                                              ] <- NA




#for systolic

Full_dataset_v1$isolated_dia_hpt_with_drugs_1 <- Full_dataset_v1$isolated_dia_hpt_with_drugs

Full_dataset_v1$isolated_dia_hpt_with_drugs_1[Full_dataset_v1$Systolic_bp_2 >= 140
                                              
                                              ] <- NA


#remove people with BMI < 18.5

Full_dataset_v1 <- subset(Full_dataset_v1, Full_dataset_v1$BMI >18.5)


Full_dataset_v1$Pulse_pressure <- Full_dataset_v1$Systolic_bp_2 - Full_dataset_v1$Diastolic_bp_2

# It represents the force that the heart generates each time it contracts.


save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))

# table(Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth)
# 
# table(Full_dataset_v1$isolated_dia_hpt_with_drugs_incboth)

```

**STEP 9** Removing brain volumes values that are greater than 4 x SD of the mean of the specific brain volumes (as specified in Cox et al 2019 paper) and mean centering the scanner variables (this helps with multicolinearity)
```{r brainvols , echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

load(file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))

# need to remove imaging values which are great than 4 X the Sd of the mean excluded cases wise (as via cox paper)

mean_brain_vols <- as.data.frame(sapply(Full_dataset_v1[,c(4:61)], mean, na.rm = T))

SD_brain_vols <- as.data.frame(sapply(Full_dataset_v1[,c(4:61)], sd, na.rm = T))

SD_brain_vols$SD_4times <-SD_brain_vols[,1] * 4 


Mean_SD_brain_vols <- cbind(mean_brain_vols, SD_brain_vols)
colnames(Mean_SD_brain_vols)[1] <- "mean"
colnames(Mean_SD_brain_vols)[2] <- "SD"

Mean_SD_brain_vols$MINBrainvolume <- Mean_SD_brain_vols$mean - Mean_SD_brain_vols$SD_4times

Mean_SD_brain_vols$MAXBrainvolume <- Mean_SD_brain_vols$mean + Mean_SD_brain_vols$SD_4times

# create a matrix if value is smaller than or greater than the 4X SD using brain volume data

#peripheral_cortical_grey_normalised
Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised_1 <- Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised < Mean_SD_brain_vols$MINBrainvolume[1] | Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised > Mean_SD_brain_vols$MAXBrainvolume[1]
# remove any values that were outside these limits
Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised[Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised_1 == TRUE] <- NA

#check before and after to see if missing values
table(is.na(Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised))
#38583 

# check how many are outside the SD cut off
table(Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised_1)
# 6 values outside of 4 x SD

# recheck the original values to make sure they have been removed
table(is.na(Full_dataset_v1$f.25001_vol_peripheral_cortical_grey_normalised)) # yes removed



 #"f.25002_vol_peripheral_cortical_grey"    
Full_dataset_v1$f.25002_vol_peripheral_cortical_grey_1 <- Full_dataset_v1$f.25002_vol_peripheral_cortical_grey < Mean_SD_brain_vols$MINBrainvolume[2] | Full_dataset_v1$f.25002_vol_peripheral_cortical_grey > Mean_SD_brain_vols$MAXBrainvolume[2]
# remove any values that were outside these limits
Full_dataset_v1$f.25002_vol_peripheral_cortical_grey[Full_dataset_v1$f.25002_vol_peripheral_cortical_grey_1 == TRUE] <- NA


  #"f.25003_vol_ventricular_CSF_normalised"  
Full_dataset_v1$f.25003_vol_ventricular_CSF_normalised_1 <- Full_dataset_v1$f.25003_vol_ventricular_CSF_normalised < Mean_SD_brain_vols$MINBrainvolume[3] | Full_dataset_v1$f.25003_vol_ventricular_CSF_normalised > Mean_SD_brain_vols$MAXBrainvolume[3]
# remove any values that were outside these limits
Full_dataset_v1$f.25003_vol_ventricular_CSF_normalised[Full_dataset_v1$f.25003_vol_ventricular_CSF_normalised_1 == TRUE] <- NA


  # "f.25004_vol_ventricular_CSF"    
Full_dataset_v1$f.25004_vol_ventricular_CSF_1 <- Full_dataset_v1$f.25004_vol_ventricular_CSF < Mean_SD_brain_vols$MINBrainvolume[4] | Full_dataset_v1$f.25004_vol_ventricular_CSF > Mean_SD_brain_vols$MAXBrainvolume[4]
# remove any values that were outside these limits
Full_dataset_v1$f.25004_vol_ventricular_CSF[Full_dataset_v1$f.25004_vol_ventricular_CSF_1 == TRUE] <- NA


  # "f.25005_Volbrain_grey_matter_normalised"   
Full_dataset_v1$f.25005_Volbrain_grey_matter_normalised_1 <- Full_dataset_v1$f.25005_Volbrain_grey_matter_normalised < Mean_SD_brain_vols$MINBrainvolume[5] | Full_dataset_v1$f.25005_Volbrain_grey_matter_normalised > Mean_SD_brain_vols$MAXBrainvolume[5]
# remove any values that were outside these limits
Full_dataset_v1$f.25005_Volbrain_grey_matter_normalised[Full_dataset_v1$f.25005_Volbrain_grey_matter_normalised_1 == TRUE] <- NA


  #"f.25006_Volgrey matter"          
Full_dataset_v1$`f.25006_Volgrey matter_1` <- Full_dataset_v1$`f.25006_Volgrey matter` < Mean_SD_brain_vols$MINBrainvolume[6] | Full_dataset_v1$`f.25006_Volgrey matter` > Mean_SD_brain_vols$MAXBrainvolume[6]
# remove any values that were outside these limits
Full_dataset_v1$`f.25006_Volgrey matter`[Full_dataset_v1$`f.25006_Volgrey matter_1` == TRUE] <- NA


  #]"f.25007_Volbrain_white_matter_normalised"    
Full_dataset_v1$f.25007_Volbrain_white_matter_normalised_1 <- Full_dataset_v1$f.25007_Volbrain_white_matter_normalised < Mean_SD_brain_vols$MINBrainvolume[7] | Full_dataset_v1$f.25007_Volbrain_white_matter_normalised > Mean_SD_brain_vols$MAXBrainvolume[7]
# remove any values that were outside these limits
Full_dataset_v1$f.25007_Volbrain_white_matter_normalised[Full_dataset_v1$f.25007_Volbrain_white_matter_normalised_1 == TRUE] <- NA


 #]"f.25008_Volwhite matter"              
Full_dataset_v1$`f.25008_Volwhite matter_1` <- Full_dataset_v1$`f.25008_Volwhite matter` < Mean_SD_brain_vols$MINBrainvolume[8] | Full_dataset_v1$`f.25008_Volwhite matter` > Mean_SD_brain_vols$MAXBrainvolume[8]
# remove any values that were outside these limits
Full_dataset_v1$`f.25008_Volwhite matter`[Full_dataset_v1$`f.25008_Volwhite matter_1` == TRUE] <- NA

# "f.25009_Volbrain_grey+white matter_normalised"  
Full_dataset_v1$`f.25009_Volbrain_grey+white matter_normalised_1` <- Full_dataset_v1$`f.25009_Volbrain_grey+white matter_normalised` < Mean_SD_brain_vols$MINBrainvolume[9] | Full_dataset_v1$`f.25009_Volbrain_grey+white matter_normalised` > Mean_SD_brain_vols$MAXBrainvolume[9]
# remove any values that were outside these limits
Full_dataset_v1$`f.25009_Volbrain_grey+white matter_normalised`[Full_dataset_v1$`f.25009_Volbrain_grey+white matter_normalised` == TRUE] <- NA


 #"f.25010_Volbrain_grey+white matter"   
Full_dataset_v1$`f.25010_Volbrain_grey+white matter_1` <- Full_dataset_v1$`f.25010_Volbrain_grey+white matter` < Mean_SD_brain_vols$MINBrainvolume[10] | Full_dataset_v1$`f.25010_Volbrain_grey+white matter` > Mean_SD_brain_vols$MAXBrainvolume[10]
# remove any values that were outside these limits
Full_dataset_v1$`f.25010_Volbrain_grey+white matter`[Full_dataset_v1$`f.25010_Volbrain_grey+white matter_1` == TRUE] <- NA



# "f.25011_vol_thalamus_L"        
Full_dataset_v1$f.25011_vol_thalamus_L_1 <- Full_dataset_v1$f.25011_vol_thalamus_L < Mean_SD_brain_vols$MINBrainvolume[11] | Full_dataset_v1$f.25011_vol_thalamus_L > Mean_SD_brain_vols$MAXBrainvolume[11]
# remove any values that were outside these limits
Full_dataset_v1$f.25011_vol_thalamus_L[Full_dataset_v1$f.25011_vol_thalamus_L_1 == TRUE] <- NA


# ]"f.25012_vol_thalamus_R"
Full_dataset_v1$f.25012_vol_thalamus_R_1 <- Full_dataset_v1$f.25012_vol_thalamus_R < Mean_SD_brain_vols$MINBrainvolume[12] | Full_dataset_v1$f.25012_vol_thalamus_R > Mean_SD_brain_vols$MAXBrainvolume[12]
# remove any values that were outside these limits
Full_dataset_v1$f.25012_vol_thalamus_R[Full_dataset_v1$f.25012_vol_thalamus_R_1 == TRUE] <- NA



# "f.25013_vol_caudate_L"     
Full_dataset_v1$f.25013_vol_caudate_L_1 <- Full_dataset_v1$f.25013_vol_caudate_L < Mean_SD_brain_vols$MINBrainvolume[13] | Full_dataset_v1$f.25013_vol_caudate_L > Mean_SD_brain_vols$MAXBrainvolume[13]
# remove any values that were outside these limits
Full_dataset_v1$f.25013_vol_caudate_L[Full_dataset_v1$f.25013_vol_caudate_L_1 == TRUE] <- NA



# "f.25014_vol_caudate_R"     
Full_dataset_v1$f.25014_vol_caudate_R_1 <- Full_dataset_v1$f.25014_vol_caudate_R < Mean_SD_brain_vols$MINBrainvolume[14] | Full_dataset_v1$f.25014_vol_caudate_R > Mean_SD_brain_vols$MAXBrainvolume[14]
# remove any values that were outside these limits
Full_dataset_v1$f.25014_vol_caudate_R[Full_dataset_v1$f.25014_vol_caudate_R_1 == TRUE] <- NA



# "f.25015_vol_putamen_L"   
Full_dataset_v1$f.25015_vol_putamen_L_1 <- Full_dataset_v1$f.25015_vol_putamen_L < Mean_SD_brain_vols$MINBrainvolume[15] | Full_dataset_v1$f.25015_vol_putamen_L > Mean_SD_brain_vols$MAXBrainvolume[15]
# remove any values that were outside these limits
Full_dataset_v1$f.25015_vol_putamen_L[Full_dataset_v1$f.25015_vol_putamen_L_1 == TRUE] <- NA


# "f.25016_vol_putamen_R"  
Full_dataset_v1$f.25016_vol_putamen_R_1 <- Full_dataset_v1$f.25016_vol_putamen_R < Mean_SD_brain_vols$MINBrainvolume[16] | Full_dataset_v1$f.25016_vol_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[16]
# remove any values that were outside these limits
Full_dataset_v1$f.25016_vol_putamen_R[Full_dataset_v1$f.25016_vol_putamen_R_1 == TRUE] <- NA


# "f.25017_vol_pallidum_L" 
Full_dataset_v1$f.25017_vol_pallidum_L_1 <- Full_dataset_v1$f.25017_vol_pallidum_L < Mean_SD_brain_vols$MINBrainvolume[17] | Full_dataset_v1$f.25017_vol_pallidum_L > Mean_SD_brain_vols$MAXBrainvolume[17]
# remove any values that were outside these limits
Full_dataset_v1$f.25017_vol_pallidum_L[Full_dataset_v1$f.25017_vol_pallidum_L_1 == TRUE] <- NA


# "f.25018_vol_pallidum_R" 
Full_dataset_v1$f.25018_vol_pallidum_R_1 <- Full_dataset_v1$f.25018_vol_pallidum_R < Mean_SD_brain_vols$MINBrainvolume[18] | Full_dataset_v1$f.25018_vol_pallidum_R > Mean_SD_brain_vols$MAXBrainvolume[18]
# remove any values that were outside these limits
Full_dataset_v1$f.25018_vol_pallidum_R[Full_dataset_v1$f.25018_vol_pallidum_R_1 == TRUE] <- NA


# "f.25019_vol_hippocampus_L"  
Full_dataset_v1$f.25019_vol_hippocampus_L_1 <- Full_dataset_v1$f.25019_vol_hippocampus_L < Mean_SD_brain_vols$MINBrainvolume[19] | Full_dataset_v1$f.25019_vol_hippocampus_L > Mean_SD_brain_vols$MAXBrainvolume[19]
# remove any values that were outside these limits
Full_dataset_v1$f.25019_vol_hippocampus_L[Full_dataset_v1$f.25019_vol_hippocampus_L_1 == TRUE] <- NA


# "f.25020_vol_hippocampus_R" 
Full_dataset_v1$f.25020_vol_hippocampus_R_1 <- Full_dataset_v1$f.25020_vol_hippocampus_R < Mean_SD_brain_vols$MINBrainvolume[20] | Full_dataset_v1$f.25020_vol_hippocampus_R > Mean_SD_brain_vols$MAXBrainvolume[20]
# remove any values that were outside these limits
Full_dataset_v1$f.25020_vol_hippocampus_R[Full_dataset_v1$f.25020_vol_hippocampus_R_1 == TRUE] <- NA


# "f.25021_vol_amygdala_L" 
Full_dataset_v1$f.25021_vol_amygdala_L_1 <- Full_dataset_v1$f.25021_vol_amygdala_L < Mean_SD_brain_vols$MINBrainvolume[21] | Full_dataset_v1$f.25021_vol_amygdala_L > Mean_SD_brain_vols$MAXBrainvolume[21]
# remove any values that were outside these limits
Full_dataset_v1$f.25021_vol_amygdala_L[Full_dataset_v1$f.25021_vol_amygdala_L_1 == TRUE] <- NA


# "f.25022_vol_amygdala_R"  
Full_dataset_v1$f.25022_vol_amygdala_R_1 <- Full_dataset_v1$f.25022_vol_amygdala_R < Mean_SD_brain_vols$MINBrainvolume[22] | Full_dataset_v1$f.25022_vol_amygdala_R > Mean_SD_brain_vols$MAXBrainvolume[22]
# remove any values that were outside these limits
Full_dataset_v1$f.25022_vol_amygdala_R[Full_dataset_v1$f.25022_vol_amygdala_R_1 == TRUE] <- NA


# "f.25023_vol_accumbens_L"  
Full_dataset_v1$f.25023_vol_accumbens_L_1 <- Full_dataset_v1$f.25023_vol_accumbens_L < Mean_SD_brain_vols$MINBrainvolume[23] | Full_dataset_v1$f.25023_vol_accumbens_L > Mean_SD_brain_vols$MAXBrainvolume[23]
# remove any values that were outside these limits
Full_dataset_v1$f.25023_vol_accumbens_L[Full_dataset_v1$f.25023_vol_accumbens_L_1 == TRUE] <- NA


# "f.25024_vol_accumbens_R"   
Full_dataset_v1$f.25024_vol_accumbens_R_1 <- Full_dataset_v1$f.25024_vol_accumbens_R < Mean_SD_brain_vols$MINBrainvolume[24] | Full_dataset_v1$f.25024_vol_accumbens_R > Mean_SD_brain_vols$MAXBrainvolume[24]
# remove any values that were outside these limits
Full_dataset_v1$f.25024_vol_accumbens_R[Full_dataset_v1$f.25024_vol_accumbens_R_1 == TRUE] <- NA


# "f.25026_MedianT2star_thalamus_L" 
Full_dataset_v1$f.25026_MedianT2star_thalamus_L_1 <- Full_dataset_v1$f.25026_MedianT2star_thalamus_L < Mean_SD_brain_vols$MINBrainvolume[25] | Full_dataset_v1$f.25026_MedianT2star_thalamus_L > Mean_SD_brain_vols$MAXBrainvolume[25]
# remove any values that were outside these limits
Full_dataset_v1$f.25026_MedianT2star_thalamus_L[Full_dataset_v1$f.25026_MedianT2star_thalamus_L_1 == TRUE] <- NA


# "f.25027_MedianT2star_thalamus_R"
Full_dataset_v1$f.25027_MedianT2star_thalamus_R_1 <- Full_dataset_v1$f.25027_MedianT2star_thalamus_R < Mean_SD_brain_vols$MINBrainvolume[26] | Full_dataset_v1$f.25027_MedianT2star_thalamus_R > Mean_SD_brain_vols$MAXBrainvolume[26]
# remove any values that were outside these limits
Full_dataset_v1$f.25027_MedianT2star_thalamus_R[Full_dataset_v1$f.25027_MedianT2star_thalamus_R_1 == TRUE] <- NA


# "f.25028_MedianT2star_caudate_L"   
Full_dataset_v1$f.25028_MedianT2star_caudate_L_1 <- Full_dataset_v1$f.25028_MedianT2star_caudate_L < Mean_SD_brain_vols$MINBrainvolume[27] | Full_dataset_v1$f.25028_MedianT2star_caudate_L > Mean_SD_brain_vols$MAXBrainvolume[27]
# remove any values that were outside these limits
Full_dataset_v1$f.25028_MedianT2star_caudate_L[Full_dataset_v1$f.25028_MedianT2star_caudate_L_1 == TRUE] <- NA


 #"f.25029_MedianT2star_caudate_R"   
Full_dataset_v1$f.25029_MedianT2star_caudate_R_1 <- Full_dataset_v1$f.25029_MedianT2star_caudate_R < Mean_SD_brain_vols$MINBrainvolume[28] | Full_dataset_v1$f.25029_MedianT2star_caudate_R > Mean_SD_brain_vols$MAXBrainvolume[28]
# remove any values that were outside these limits
Full_dataset_v1$f.25029_MedianT2star_caudate_R[Full_dataset_v1$f.25029_MedianT2star_caudate_R_1 == TRUE] <- NA


 #"f.25030_MedianT2star_putamen_L"   
Full_dataset_v1$f.25030_MedianT2star_putamen_L_1 <- Full_dataset_v1$f.25030_MedianT2star_putamen_L < Mean_SD_brain_vols$MINBrainvolume[29] | Full_dataset_v1$f.25030_MedianT2star_putamen_L > Mean_SD_brain_vols$MAXBrainvolume[29]
# remove any values that were outside these limits
Full_dataset_v1$f.25030_MedianT2star_putamen_L[Full_dataset_v1$f.25030_MedianT2star_putamen_L_1 == TRUE] <- NA


 #"f.25031_MedianT2star_putamen_R"  
Full_dataset_v1$f.25031_MedianT2star_putamen_R_1 <- Full_dataset_v1$f.25031_MedianT2star_putamen_R < Mean_SD_brain_vols$MINBrainvolume[30] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[30]
# remove any values that were outside these limits
Full_dataset_v1$f.25031_MedianT2star_putamen_R[Full_dataset_v1$f.25031_MedianT2star_putamen_R_1 == TRUE] <- NA


 # "f.25032_MedianT2star_pallidum_L"  
Full_dataset_v1$f.25032_MedianT2star_pallidum_L_1 <- Full_dataset_v1$f.25032_MedianT2star_pallidum_L < Mean_SD_brain_vols$MINBrainvolume[31] | Full_dataset_v1$f.25032_MedianT2star_pallidum_L > Mean_SD_brain_vols$MAXBrainvolume[31]
# remove any values that were outside these limits
Full_dataset_v1$f.25032_MedianT2star_pallidum_L[Full_dataset_v1$f.25032_MedianT2star_pallidum_L_1 == TRUE] <- NA


 #"f.25033_MedianT2star_pallidum_R"   
Full_dataset_v1$f.25033_MedianT2star_pallidum_R_1 <- Full_dataset_v1$f.25033_MedianT2star_pallidum_R < Mean_SD_brain_vols$MINBrainvolume[32] | Full_dataset_v1$f.25033_MedianT2star_pallidum_R > Mean_SD_brain_vols$MAXBrainvolume[32]
# remove any values that were outside these limits
Full_dataset_v1$f.25033_MedianT2star_pallidum_R[Full_dataset_v1$f.25033_MedianT2star_pallidum_R_1 == TRUE] <- NA


 #"f.25034_MedianT2star_hippocampus_L"   
Full_dataset_v1$f.25034_MedianT2star_hippocampus_L_1 <- Full_dataset_v1$f.25034_MedianT2star_hippocampus_L < Mean_SD_brain_vols$MINBrainvolume[33] | Full_dataset_v1$f.25034_MedianT2star_hippocampus_L > Mean_SD_brain_vols$MAXBrainvolume[33]
# remove any values that were outside these limits
Full_dataset_v1$f.25034_MedianT2star_hippocampus_L[Full_dataset_v1$f.25034_MedianT2star_hippocampus_L_1 == TRUE] <- NA


 #"f.25035_MedianT2star_hippocampus_R"  
Full_dataset_v1$f.25035_MedianT2star_hippocampus_R_1 <- Full_dataset_v1$f.25035_MedianT2star_hippocampus_R < Mean_SD_brain_vols$MINBrainvolume[34] | Full_dataset_v1$f.25035_MedianT2star_hippocampus_R > Mean_SD_brain_vols$MAXBrainvolume[34]
# remove any values that were outside these limits
Full_dataset_v1$f.25035_MedianT2star_hippocampus_R[Full_dataset_v1$f.25035_MedianT2star_hippocampus_R_1 == TRUE] <- NA


 #"f.25036_MedianT2star_amygdala_L"   
Full_dataset_v1$f.25036_MedianT2star_amygdala_L_1 <- Full_dataset_v1$f.25036_MedianT2star_amygdala_L < Mean_SD_brain_vols$MINBrainvolume[35] | Full_dataset_v1$f.25036_MedianT2star_amygdala_L > Mean_SD_brain_vols$MAXBrainvolume[35]
# remove any values that were outside these limits
Full_dataset_v1$f.25036_MedianT2star_amygdala_L[Full_dataset_v1$f.25036_MedianT2star_amygdala_L_1 == TRUE] <- NA


 #"f.25037_MedianT2star_amygdala_R"   
Full_dataset_v1$f.25037_MedianT2star_amygdala_R_1 <- Full_dataset_v1$f.25037_MedianT2star_amygdala_R < Mean_SD_brain_vols$MINBrainvolume[36] | Full_dataset_v1$f.25037_MedianT2star_amygdala_R > Mean_SD_brain_vols$MAXBrainvolume[36]
# remove any values that were outside these limits
Full_dataset_v1$f.25037_MedianT2star_amygdala_R[Full_dataset_v1$f.25037_MedianT2star_amygdala_R_1 == TRUE] <- NA


 #"f.25038_MedianT2star_accumbens_L"   
Full_dataset_v1$f.25038_MedianT2star_accumbens_L_1 <- Full_dataset_v1$f.25038_MedianT2star_accumbens_L < Mean_SD_brain_vols$MINBrainvolume[37] | Full_dataset_v1$f.25038_MedianT2star_accumbens_L > Mean_SD_brain_vols$MAXBrainvolume[37]
# remove any values that were outside these limits
Full_dataset_v1$f.25038_MedianT2star_accumbens_L[Full_dataset_v1$f.25038_MedianT2star_accumbens_L_1 == TRUE] <- NA


 #"f.25039_MedianT2star_accumbens_R"       
Full_dataset_v1$f.25039_MedianT2star_accumbens_R_1 <- Full_dataset_v1$f.25039_MedianT2star_accumbens_R < Mean_SD_brain_vols$MINBrainvolume[38] | Full_dataset_v1$f.25039_MedianT2star_accumbens_R > Mean_SD_brain_vols$MAXBrainvolume[38]
# remove any values that were outside these limits
Full_dataset_v1$f.25039_MedianT2star_accumbens_R[Full_dataset_v1$f.25039_MedianT2star_accumbens_R_1 == TRUE] <- NA


 #"f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R"   
Full_dataset_v1$f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R_1 <- Full_dataset_v1$f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R < Mean_SD_brain_vols$MINBrainvolume[39] | Full_dataset_v1$f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R > Mean_SD_brain_vols$MAXBrainvolume[39]
# remove any values that were outside these limits
Full_dataset_v1$f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R[Full_dataset_v1$f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R_1 == TRUE] <- NA


 #"f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L"   
Full_dataset_v1$f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L_1 <- Full_dataset_v1$f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L < Mean_SD_brain_vols$MINBrainvolume[40] | Full_dataset_v1$f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L > Mean_SD_brain_vols$MAXBrainvolume[40]
# remove any values that were outside these limits
Full_dataset_v1$f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L[Full_dataset_v1$f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L_1 == TRUE] <- NA

 #"f.25092_FA_Skeleton_hippocampus_R"       
Full_dataset_v1$f.25092_FA_Skeleton_hippocampus_R_1 <- Full_dataset_v1$f.25092_FA_Skeleton_hippocampus_R < Mean_SD_brain_vols$MINBrainvolume[41] | Full_dataset_v1$f.25092_FA_Skeleton_hippocampus_R > Mean_SD_brain_vols$MAXBrainvolume[41]
# remove any values that were outside these limits
Full_dataset_v1$f.25092_FA_Skeleton_hippocampus_R[Full_dataset_v1$f.25092_FA_Skeleton_hippocampus_R_1 == TRUE] <- NA


 #"f.25093_FA_Skeleton_hippocampus_L"        
Full_dataset_v1$f.25093_FA_Skeleton_hippocampus_L_1 <- Full_dataset_v1$f.25093_FA_Skeleton_hippocampus_L < Mean_SD_brain_vols$MINBrainvolume[42] | Full_dataset_v1$f.25093_FA_Skeleton_hippocampus_L > Mean_SD_brain_vols$MAXBrainvolume[42]
# remove any values that were outside these limits
Full_dataset_v1$f.25093_FA_Skeleton_hippocampus_L[Full_dataset_v1$f.25093_FA_Skeleton_hippocampus_L_1 == TRUE] <- NA



 #"f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R"  
Full_dataset_v1$f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R_1 <- Full_dataset_v1$f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R < Mean_SD_brain_vols$MINBrainvolume[43] | Full_dataset_v1$f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R > Mean_SD_brain_vols$MAXBrainvolume[43]
# remove any values that were outside these limits
Full_dataset_v1$f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R[Full_dataset_v1$f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R_1 == TRUE] <- NA


 #"f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L" 
Full_dataset_v1$f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L_1 <- Full_dataset_v1$f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L < Mean_SD_brain_vols$MINBrainvolume[44] | Full_dataset_v1$f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L > Mean_SD_brain_vols$MAXBrainvolume[44]
# remove any values that were outside these limits
Full_dataset_v1$f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L[Full_dataset_v1$f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L_1 == TRUE] <- NA


 #"f.25140_MD_Skeleton_hippocampus_R"      
Full_dataset_v1$f.25140_MD_Skeleton_hippocampus_R_1 <- Full_dataset_v1$f.25140_MD_Skeleton_hippocampus_R < Mean_SD_brain_vols$MINBrainvolume[45] | Full_dataset_v1$f.25140_MD_Skeleton_hippocampus_R > Mean_SD_brain_vols$MAXBrainvolume[45]
# remove any values that were outside these limits
Full_dataset_v1$f.25140_MD_Skeleton_hippocampus_R[Full_dataset_v1$f.25140_MD_Skeleton_hippocampus_R_1 == TRUE] <- NA


 #"f.25141_MD_Skeleton_hippocampus_L"    
Full_dataset_v1$f.25141_MD_Skeleton_hippocampus_L_1 <- Full_dataset_v1$f.25141_MD_Skeleton_hippocampus_L < Mean_SD_brain_vols$MINBrainvolume[46] | Full_dataset_v1$f.25141_MD_Skeleton_hippocampus_L > Mean_SD_brain_vols$MAXBrainvolume[46]
# remove any values that were outside these limits
Full_dataset_v1$f.25141_MD_Skeleton_hippocampus_L[Full_dataset_v1$f.25141_MD_Skeleton_hippocampus_L_1 == TRUE] <- NA



 #"f.25738_Discrepancy_SWI+T1_brain image"   
Full_dataset_v1$`f.25738_Discrepancy_SWI+T1_brain image_1` <- Full_dataset_v1$`f.25738_Discrepancy_SWI+T1_brain image` < Mean_SD_brain_vols$MINBrainvolume[47] | Full_dataset_v1$`f.25738_Discrepancy_SWI+T1_brain image` > Mean_SD_brain_vols$MAXBrainvolume[47]
# remove any values that were outside these limits
Full_dataset_v1$`f.25738_Discrepancy_SWI+T1_brain image`[Full_dataset_v1$`f.25738_Discrepancy_SWI+T1_brain image_1` == TRUE] <- NA



 #"f.25886_FAST_GM_Hippocampus_L"      
Full_dataset_v1$f.25886_FAST_GM_Hippocampus_L_1 <- Full_dataset_v1$f.25886_FAST_GM_Hippocampus_L < Mean_SD_brain_vols$MINBrainvolume[48] | Full_dataset_v1$f.25886_FAST_GM_Hippocampus_L > Mean_SD_brain_vols$MAXBrainvolume[48]
# remove any values that were outside these limits
Full_dataset_v1$f.25886_FAST_GM_Hippocampus_L[Full_dataset_v1$f.25886_FAST_GM_Hippocampus_L_1 == TRUE] <- NA



 # "f.25887_FAST_GM_Hippocampus_R" 
Full_dataset_v1$f.25887_FAST_GM_Hippocampus_R_1 <- Full_dataset_v1$f.25887_FAST_GM_Hippocampus_R < Mean_SD_brain_vols$MINBrainvolume[49] | Full_dataset_v1$f.25887_FAST_GM_Hippocampus_R > Mean_SD_brain_vols$MAXBrainvolume[49]
# remove any values that were outside these limits
Full_dataset_v1$f.25887_FAST_GM_Hippocampus_R[Full_dataset_v1$f.25887_FAST_GM_Hippocampus_R_1 == TRUE] <- NA

# need to sort this out
#WMH (not logged)
Full_dataset_v1$f.25781_WMH_1 <- Full_dataset_v1$f.25781_WMH < Mean_SD_brain_vols$MINBrainvolume[50] | Full_dataset_v1$f.25781_WMH > Mean_SD_brain_vols$MAXBrainvolume[50]
# remove any values that were outside these limits
Full_dataset_v1$f.25781_WMH[Full_dataset_v1$f.25781_WMH_1 == TRUE] <- NA

#check before and after to see if missing values
table(is.na(Full_dataset_v1$f.25781_WMH))
#FALSE  TRUE 
#37290  1293 

# check how many are outside the SD cut off
table(Full_dataset_v1$f.25781_WMH_1)
# 437  values outside of 4 x SD

# recheck the original values to make sure they have been removed
table(is.na(Full_dataset_v1$f.25781_WMH)) # yes removed
#1293 + 437 = 1730 total NA

# log the variable
Full_dataset_v1$f.25781_WMH_LOG <- log(Full_dataset_v1$f.25781_WMH)



##### add in hippo campal volumes here

#f.26620_tail_hippo_L
Full_dataset_v1$f.26620_tail_hippo_L_1 <- Full_dataset_v1$f.26620_tail_hippo_L < Mean_SD_brain_vols$MINBrainvolume[51] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[51]
# remove any values that were outside these limits
Full_dataset_v1$f.26620_tail_hippo_L[Full_dataset_v1$f.26620_tail_hippo_L_1 == TRUE] <- NA

#f.26639_body_hippo_L
Full_dataset_v1$f.26639_body_hippo_L_1 <- Full_dataset_v1$f.26639_body_hippo_L < Mean_SD_brain_vols$MINBrainvolume[52] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[52]
# remove any values that were outside these limits
Full_dataset_v1$f.26639_body_hippo_L[Full_dataset_v1$f.26639_body_hippo_L_1 == TRUE] <- NA

#f.26640_head_hippo_L
Full_dataset_v1$f.26640_head_hippo_L_1 <- Full_dataset_v1$f.26640_head_hippo_L < Mean_SD_brain_vols$MINBrainvolume[53] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[53]
# remove any values that were outside these limits
Full_dataset_v1$f.26640_head_hippo_L[Full_dataset_v1$f.26640_head_hippo_L_1 == TRUE] <- NA

#f.26641_whole_hippo_L
Full_dataset_v1$f.26641_whole_hippo_L_1 <- Full_dataset_v1$f.26641_whole_hippo_L < Mean_SD_brain_vols$MINBrainvolume[54] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[54]
# remove any values that were outside these limits
Full_dataset_v1$f.26641_whole_hippo_L[Full_dataset_v1$f.26641_whole_hippo_L_1 == TRUE] <- NA

#f.26642_tail_hippo_R
Full_dataset_v1$f.26642_tail_hippo_R_1 <- Full_dataset_v1$f.26642_tail_hippo_R < Mean_SD_brain_vols$MINBrainvolume[55] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[55]
# remove any values that were outside these limits
Full_dataset_v1$f.26642_tail_hippo_R[Full_dataset_v1$f.26642_tail_hippo_R_1 == TRUE] <- NA

#f.26661_body_hippo_R
Full_dataset_v1$f.26661_body_hippo_R_1 <- Full_dataset_v1$f.26661_body_hippo_R < Mean_SD_brain_vols$MINBrainvolume[56] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[56]
# remove any values that were outside these limits
Full_dataset_v1$f.26661_body_hippo_R[Full_dataset_v1$f.26661_body_hippo_R_1 == TRUE] <- NA

#f.26662_head_hippo_R
Full_dataset_v1$f.26662_head_hippo_R_1 <- Full_dataset_v1$f.26662_head_hippo_R < Mean_SD_brain_vols$MINBrainvolume[57] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[57]
# remove any values that were outside these limits
Full_dataset_v1$f.26662_head_hippo_R[Full_dataset_v1$f.26662_head_hippo_R_1 == TRUE] <- NA

#f.26663_whole_hippo_R
Full_dataset_v1$f.26663_whole_hippo_R_1 <- Full_dataset_v1$f.26663_whole_hippo_R < Mean_SD_brain_vols$MINBrainvolume[58] | Full_dataset_v1$f.25031_MedianT2star_putamen_R > Mean_SD_brain_vols$MAXBrainvolume[58]
# remove any values that were outside these limits
Full_dataset_v1$f.26663_whole_hippo_R[Full_dataset_v1$f.26663_whole_hippo_R_1 == TRUE] <- NA



#remove variables we do not need:

Full_dataset_v1 <- subset(Full_dataset_v1, 
                                          select = -c(        
                                            `f.25001_vol_peripheral_cortical_grey_normalised_1` ,   
                                            `f.25002_vol_peripheral_cortical_grey_1`  ,             
                                            `f.25003_vol_ventricular_CSF_normalised_1` ,   
                                            `f.25004_vol_ventricular_CSF_1`             ,           
                                            `f.25005_Volbrain_grey_matter_normalised_1`  ,          
                                            `f.25006_Volgrey matter_1`                    ,         
                                            `f.25007_Volbrain_white_matter_normalised_1`   ,        
                                            `f.25008_Volwhite matter_1`                     ,       
                                            `f.25009_Volbrain_grey+white matter_normalised_1`,      
                                            `f.25010_Volbrain_grey+white matter_1`            ,     
                                            `f.25011_vol_thalamus_L_1`                         ,    
                                            `f.25012_vol_thalamus_R_1`                          ,   
                                            `f.25013_vol_caudate_L_1`                            ,  
                                            `f.25014_vol_caudate_R_1`                             , 
                                            `f.25015_vol_putamen_L_1`                              ,
                                            `f.25016_vol_putamen_R_1`                              ,
                                            `f.25017_vol_pallidum_L_1`                             ,
                                            `f.25018_vol_pallidum_R_1`                             ,
                                            `f.25019_vol_hippocampus_L_1`                          ,
                                            `f.25020_vol_hippocampus_R_1`                          ,
                                            `f.25021_vol_amygdala_L_1`                             ,
                                            `f.25022_vol_amygdala_R_1`                             ,
                                            `f.25023_vol_accumbens_L_1`                            ,
                                            `f.25024_vol_accumbens_R_1`                            ,
                                            `f.25026_MedianT2star_thalamus_L_1`                    ,
                                            `f.25027_MedianT2star_thalamus_R_1`                    ,
                                            `f.25028_MedianT2star_caudate_L_1`                     ,
                                            `f.25029_MedianT2star_caudate_R_1`                     ,
                                            `f.25030_MedianT2star_putamen_L_1`                     ,
                                            `f.25031_MedianT2star_putamen_R_1`                     ,
                                            `f.25032_MedianT2star_pallidum_L_1`                    ,
                                            `f.25033_MedianT2star_pallidum_R_1`                    ,
                                            `f.25034_MedianT2star_hippocampus_L_1`                 ,
                                            `f.25035_MedianT2star_hippocampus_R_1`                 ,
                                            `f.25036_MedianT2star_amygdala_L_1`                    ,
                                            `f.25037_MedianT2star_amygdala_R_1`                    ,
                                            `f.25038_MedianT2star_accumbens_L_1`                   ,
                                            `f.25039_MedianT2star_accumbens_R_1`                   ,
                                            `f.25090_FA_Skeleton_cingulum_cingulate_gyrus_R_1`     ,
                                            `f.25091_FA_Skeleton_cingulum_cingulate_gyrus_L_1`     ,
                                            `f.25092_FA_Skeleton_hippocampus_R_1`                  ,
                                            `f.25093_FA_Skeleton_hippocampus_L_1`                  ,
                                            `f.25138_MD_Skeleton_cingulum_cingulate_gyrus_R_1`     ,
                                            `f.25139_MD_Skeleton_cingulum_cingulate_gyrus_L_1`     ,
                                            `f.25140_MD_Skeleton_hippocampus_R_1`                  ,
                                            `f.25141_MD_Skeleton_hippocampus_L_1`                  ,
                                            `f.25738_Discrepancy_SWI+T1_brain image_1`             ,
                                            `f.25886_FAST_GM_Hippocampus_L_1`                      ,
                                            `f.25781_WMH_1` ,
                                            `f.25887_FAST_GM_Hippocampus_R_1`  ,
                                            `f.26620_tail_hippo_L_1` ,
                                            `f.26639_body_hippo_L_1` ,
                                            `f.26640_head_hippo_L_1` ,
                                            `f.26641_whole_hippo_L_1` ,
                                            `f.26642_tail_hippo_R_1` ,
                                            `f.26661_body_hippo_R_1` ,
                                            `f.26662_head_hippo_R_1` ,
                                            `f.26663_whole_hippo_R_1`
                                            
                                            ))



# centre the scanner variables
center_scale <- function(x) {
    scale(x, scale = FALSE)
}

Full_dataset_v1$`25756-2_ScannerXposition` <- center_scale(Full_dataset_v1$`25756-2_ScannerXposition`)

Full_dataset_v1$`25757-2.ScannerYposition` <-
 center_scale(Full_dataset_v1$`25757-2.ScannerYposition` )
  
Full_dataset_v1$`25758-2_ScannerZposition` <-
 center_scale(Full_dataset_v1$`25758-2_ScannerZposition`)
  
Full_dataset_v1$`25759-2_Scannerposition` <- 
center_scale(Full_dataset_v1$`25759-2_Scannerposition`)

save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))


```

**STEP 9a** Averaging brain volumes left and right
```{r averagingbrains, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

#thalamus
Full_dataset_v1$thalamus <- rowMeans(Full_dataset_v1[, c("f.25011_vol_thalamus_L", "f.25012_vol_thalamus_R") ], na.rm = TRUE )

Full_dataset_v1$thalamus[Full_dataset_v1$thalamus == "NaN"] <- NA


# caudate
Full_dataset_v1$caudate <- rowMeans(Full_dataset_v1[, c("f.25013_vol_caudate_L", "f.25014_vol_caudate_R") ], na.rm = TRUE )

Full_dataset_v1$caudate[Full_dataset_v1$caudate == "NaN"] <- NA

# putamen

Full_dataset_v1$putamen <- rowMeans(Full_dataset_v1[, c("f.25015_vol_putamen_L", "f.25016_vol_putamen_R") ], na.rm = TRUE )

Full_dataset_v1$putamen[Full_dataset_v1$putamen == "NaN"] <- NA
 

# pallidium

Full_dataset_v1$pallidum <- rowMeans(Full_dataset_v1[, c("f.25017_vol_pallidum_L", "f.25018_vol_pallidum_R") ], na.rm = TRUE )

Full_dataset_v1$pallidum[Full_dataset_v1$pallidum == "NaN"] <- NA


# hippocampus

Full_dataset_v1$hippocampus <- rowMeans(Full_dataset_v1[, c("f.25019_vol_hippocampus_L", "f.25020_vol_hippocampus_R") ], na.rm = TRUE )

Full_dataset_v1$hippocampus[Full_dataset_v1$hippocampus == "NaN"] <- NA


# amygdala

Full_dataset_v1$amygdala <- rowMeans(Full_dataset_v1[, c("f.25021_vol_amygdala_L", "f.25022_vol_amygdala_R") ], na.rm = TRUE )

Full_dataset_v1$amygdala[Full_dataset_v1$amygdala == "NaN"] <- NA
 

# accumbens

Full_dataset_v1$accumbens <- rowMeans(Full_dataset_v1[, c("f.25023_vol_accumbens_L", "f.25024_vol_accumbens_R") ], na.rm = TRUE )

Full_dataset_v1$accumbens[Full_dataset_v1$accumbens == "NaN"] <- NA


# hippocampal whole
Full_dataset_v1$FS_hippocampal_whole <- rowMeans(Full_dataset_v1[, c("f.26641_whole_hippo_L", "f.26663_whole_hippo_R") ], na.rm = TRUE )

Full_dataset_v1$FS_hippocampal_whole[Full_dataset_v1$FS_hippocampal_whole == "NaN"] <- NA

# hippocampal head
Full_dataset_v1$FS_hippocampal_head <- rowMeans(Full_dataset_v1[, c("f.26640_head_hippo_L", "f.26662_head_hippo_R") ], na.rm = TRUE )

Full_dataset_v1$FS_hippocampal_head[Full_dataset_v1$FS_hippocampal_head == "NaN"] <- NA

# hippocampal body
Full_dataset_v1$FS_hippocampal_body <- rowMeans(Full_dataset_v1[, c("f.26639_body_hippo_L", "f.26661_body_hippo_R") ], na.rm = TRUE )

Full_dataset_v1$FS_hippocampal_body[Full_dataset_v1$FS_hippocampal_body == "NaN"] <- NA

# hippocampal tail
Full_dataset_v1$FS_hippocampal_tail <- rowMeans(Full_dataset_v1[, c("f.26620_tail_hippo_L", "f.26642_tail_hippo_R") ], na.rm = TRUE )

Full_dataset_v1$FS_hippocampal_tail[Full_dataset_v1$FS_hippocampal_tail == "NaN"] <- NA
                            


save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))

```

**STEP 9b** Latent variables of Brain MRI diffusion volumes
The diffusion properties of white matter tracts across the brain are correlated; for example, an individual with relatively high FA in one tract is likely to also have relatively high FA across other tracts in the brain. This means that a latent, general factor of white matter microstructure can be derived16,27. Analysis of latent factors allows a deeper understanding of the covariance structure of inter-individual differences in age-related brain changes; measuring global white matter diffusion is of great interest for investigating ageing trends that are general across white matter tracts (but specific to white matter tissue)10,11,14,21,28. Isolated, tract-specific enquiry cannot distinguish whether ageing patterns are unique to that tract or an outcome of a more systemic constellation of processes. Tract-specific enquiry is also susceptible to a large degree of noise in the diffusion signal29; this noise can be reduced by using multivariate, latent-variable analyses13: Taken from Ageing and brain white matter structure in 3,513 UK Biobank participants: Simon R. Cox, Stuart J. Ritchie, Elliot M. Tucker-Drob, David C. Liewald, Saskia P. Hagenaars, Gail Davies, Joanna M. Wardlaw, Catharine R. Gale, Mark E. Bastin & Ian J. Deary.

We conducted analyses across all five water diffusion measures discussed above (FA, MD, ICVF, ISOVF and OD). Tract-averaged values for MR diffusion parameters FA, MD, ICVF, ISOVF and OD

tract-averaged fractional anisotropy (FA) and mean diffusivity (MD) of the following white matter tracts: acoustic radiation, anterior thalamic, cingulum gyrus, and parahippocampal, corticospinal, forceps major and minor, inferior fronto-occipital, inferior longitudinal, middle cerebellar peduncle, medial lemniscus, posterior thalamic, superior longitudinal, superior thalamic, uncinate. Associations between vascular risk factors and brain MRI indices in UK Biobank. ‘cfa’ in the lavaan package.

Diffusion MRI weighted means: https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=135

Higher aggregate vascular risk was associated with lower FA and higher MD (Cox 2019)

# gfa
```{r readFA, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}


setDTthreads(0L)

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", header=TRUE, nrows = 0)

# get column names for imaging
bdtest <- bd[,grep("[0-9]{1,10}\\-[2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]

# we are interested in Category 110 Brain MRI imaging from T1 structural brain MRI
# no normalised to head size variables included

##########################################################################
# BRAIN IMAGING VARIABLES #
###########################################################################

colwewant <- c("eid",   ## id

               "^25488\\-"   ,      #Weighted-mean FA in tract acoustic radiation (left)
               "^25489\\-"   ,      #Weighted-mean FA in tract acoustic radiation (right)
               "^25490\\-"     ,	#Weighted-mean FA in tract anterior thalamic radiation (left)
"^25491\\-"   ,	#Weighted-mean FA in tract anterior thalamic radiation (right)
"^25492\\-"   ,	#Weighted-mean FA in tract cingulate gyrus part of cingulum (left)
"^25493\\-"   ,	#Weighted-mean FA in tract cingulate gyrus part of cingulum (right)
"^25494\\-"   ,	#Weighted-mean FA in tract parahippocampal part of cingulum (left)
"^25495\\-"   ,	#Weighted-mean FA in tract parahippocampal part of cingulum (right)
"^25496\\-"   ,	#Weighted-mean FA in tract corticospinal tract (left)
"^25497\\-"   ,	#Weighted-mean FA in tract corticospinal tract (right)
"^25498\\-"   ,	#Weighted-mean FA in tract forceps major
"^25499\\-"   ,	#Weighted-mean FA in tract forceps minor
"^25500\\-"   ,	#Weighted-mean FA in tract inferior fronto-occipital fasciculus (left)
"^25501\\-"   ,	#Weighted-mean FA in tract inferior fronto-occipital fasciculus (right)
"^25502\\-"   ,	#Weighted-mean FA in tract inferior longitudinal fasciculus (left)
"^25503\\-"   ,	#Weighted-mean FA in tract inferior longitudinal fasciculus (right)
"^25504\\-"   ,	#Weighted-mean FA in tract middle cerebellar peduncle
"^25505\\-"   ,	#Weighted-mean FA in tract medial lemniscus (left)
"^25506\\-"   ,	#Weighted-mean FA in tract medial lemniscus (right)
"^25507\\-"   ,	#Weighted-mean FA in tract posterior thalamic radiation (left)
"^25508\\-"   ,	#Weighted-mean FA in tract posterior thalamic radiation (right)
"^25509\\-"   ,	#Weighted-mean FA in tract superior longitudinal fasciculus (left)
"^25510\\-"   ,	#Weighted-mean FA in tract superior longitudinal fasciculus (right)
"^25511\\-"   ,	#Weighted-mean FA in tract superior thalamic radiation (left)
"^25512\\-"   ,	#Weighted-mean FA in tract superior thalamic radiation (right)
"^25513\\-"   ,	#Weighted-mean FA in tract uncinate fasciculus (left)
"^25514\\-"   	#Weighted-mean FA in tract uncinate fasciculus (right)

               
)


               
bdtest3 <- unique(grep(paste(colwewant, collapse ="|"),
                                      bdtest, value = TRUE, fixed = FALSE ))
               
              
               
tic()
# read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
FA_rawdata <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               #fill = FALSE ,
                               #quote = "",
                               #nrows = 1000 ,
                               #nrows = 502507,
                               select = bdtest3)

toc()   








#complete cases we did this as for the missing values the majority of values 28/30 were NA
FA_rawdata1 <- FA_rawdata[complete.cases(FA_rawdata[,c(2:28)]), ] 


#only use ones which are in our analysis of ISP

Full_dataset_v1_demo <- Full_dataset_v1

FA_rawdata1 <- subset(FA_rawdata1, FA_rawdata1$eid %in% Full_dataset_v1_demo$eid)


#remove values which are 0
FA_rawdata1[FA_rawdata1 == 0] <- NA

#only include complete cases
FA_rawdata1 <- FA_rawdata1[complete.cases(FA_rawdata1[,c(2:28)]), ] 
FA_rawdata2 <- FA_rawdata1



library(tidyr)
  

#plots the different volumes
# FA_volumes <- ggplot(test, aes(x=FA_term, y=volume, col = FA_term )) + geom_jitter() + 
#    xlab("Tract") + ylab("FA") +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")
# 
# FA_volumes


# indicates we need to remove outliers

# cfa pacakge

#scale the data i.e. make mean 1 and SD = 0
FA_rawdata2 <- scale(FA_rawdata1[,c(-1)] )
FA_rawdata2 <- as.data.frame(FA_rawdata2)
FA_rawdata2$eid <- FA_rawdata1$eid

FA_rawdata4 <- FA_rawdata2

colnames(FA_rawdata4) <- c("AR_L",
                           "AR_R",
                           "ATR_L",
                           "ATR_R",
                           "CG_L",
                           "CG_R",
                           "PHC_L",
                           "PHC_R",
                           "CT_L",
                           "CT_R",
                           "FMaj",
                           "FMin",
                           "IFOF_L",
                           "IFOF_R",
                           "ILF_L",
                           "ILF_R",
                           "MCP",
                           "ML_L",
                           "ML_R",
                           "TR_L",
                           "TR_R",
                           "SLF_L",
                           "SFL_R",
                           "STR_L",
                           "STR_R",
                           "UF_L",
                           "UF_R",
                           "eid"
                           
                           
                           
                           )



HS.model2 <- ' 
# measurement model
gFA  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + PHC_L + PHC_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + MCP + ML_L + ML_R + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
PHC_L ~~ PHC_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
ML_L ~~ ML_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R

'


# fit the model
fit2 <- cfa(HS.model2, data=FA_rawdata4)

#fit2 <- cfa(HS.model2, data=FA_rawdata3, std.lv=TRUE, orthogonal = TRUE)

#summary(fit2, fit.measures=TRUE, standardized=TRUE)

fitmeasures(fit2, c('cfi', 'tli',  'rmsea',  'srmr'))


gfa_loadings <- inspect(fit2,what="std")$lambda

gfa_loadings <- as.data.frame(gfa_loadings)

#put names into loadings




gfa_loadings$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"parahippocampal part of cingulum L" ,
"parahippocampal part of cingulum R" ,
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"middle cerebellar peduncle" ,
"medial lemniscus L" ,
"medial lemniscus R" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )




# remove low loadings <0.3

#from cox 2019 paper 
#all tract measures (left and right) were entered separately into this analysis, correlated residuals between the left and right of each tract and between some other tracts were allowed, and based on low loadings (<0.3) of the Medial Lemniscus, Middle Cerebellar Peduncle and bilateral Parahippocampal Cingulum on the first factor, these measures were not included in the factor analysis

#CFI (Comparative fit index): Measures whether the model fits the data better than a more restricted baseline model. Higher is better, with okay fit > .9.

#TLI (Tucker-Lewis index): Similar to CFI, but it penalizes overly complex models (making it more conservative than CFI). Measures whether the model fits the data better than a more restricted baseline model. Higher is better, with okay fit > .9.

# RMSEA (Root mean square error of approximation): The “error of approximation” refers to residuals. Instead of comparing to a baseline model, it measures how closely the model reproduces data patterns (i.e. the covariances among indicators). Lower is better.

# RMR/SRMR: the (Standardized) Root Mean Square Residual represents the square-root of the difference between the residuals of the sample covariance matrix and the hypothesized model. As the RMR can be sometimes hard to interpret, better to use SRMR. Should be < .08.


#################################
# remove the loadings less than 0.3 PHC and ML


HS.model3 <- ' 
# measurement model
gFA  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + MCP + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R

'


# fit the model
fit3 <- cfa(HS.model3, data=FA_rawdata4)

#fit2 <- cfa(HS.model2, data=FA_rawdata3, std.lv=TRUE, orthogonal = TRUE)

#summary(fit2, fit.measures=TRUE, standardized=TRUE)

fitmeasures(fit3, c('cfi', 'tli',  'rmsea',  'srmr'))


gfa_loadings3 <- inspect(fit3,what="std")$lambda

gfa_loadings3 <- as.data.frame(gfa_loadings3)


gfa_loadings3$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"middle cerebellar peduncle" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )



######################################################
# remove middle cerebellar peduncle as this is now < 0.3

HS.model4 <- ' 
# measurement model
gFA  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R

'


# fit the model
fit4 <- cfa(HS.model4, data=FA_rawdata4)

fitmeasures(fit4, c('cfi', 'tli',  'rmsea',  'srmr'))


gfa_loadings4 <- inspect(fit4,what="std")$lambda

gfa_loadings4 <- as.data.frame(gfa_loadings4)


gfa_loadings4$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )



####################################################
# add in correlations between regions of brain only add in those > 0.7 (high correlation)
##### trying to find which ones correlate so can include them in the model

FA_rawdata5 <- FA_rawdata4[,c(-28)]

library("ggcorrplot")

# corr <- round(cor(FA_rawdata5, use = "complete.obs"), 1)
# 
# p.mat <- cor_pmat(FA_rawdata5, use = "complete.obs")
# 
# ggcorrplot(corr)
# 
# ggcorrplot(corr,
#            hc.order = TRUE,
#            type = "lower",
#            outline.color = "white")



flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}


library(Hmisc)
res2<-rcorr(as.matrix(FA_rawdata5))
FA_correlations <- flattenCorrMatrix(res2$r, res2$P)

# only take those with correlation > 0.7 indicate a high correlation
FA_correlations_high <- subset(FA_correlations, FA_correlations$cor >= 0.7)



HS.model5 <- ' 
# measurement model
gFA  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R
ILF_L ~~ TR_R
IFOF_R ~~ SLF_L
ATR_L ~~ IFOF_L
ATR_L ~~ IFOF_R
ILF_R ~~ TR_L
IFOF_L ~~ SLF_L
IFOF_L ~~ TR_L
ATR_R ~~ IFOF_R
ILF_R ~~ SLF_L
IFOF_R ~~ SFL_R
ATR_R ~~ FMin
IFOF_R ~~TR_R
ILF_R ~~ SFL_R
ILF_L ~~ SLF_L
FMin ~~ IFOF_L
ATR_L ~~ FMin
FMin ~~ IFOF_R
ILF_L ~~ TR_L
ILF_R ~~ TR_R
IFOF_R ~~ ILF_L
IFOF_L ~~ ILF_R
IFOF_L ~~ ILF_L
IFOF_R ~~ ILF_R

'


# fit the model
fit5 <- cfa(HS.model5, data=FA_rawdata4)

fitmeasures(fit5, c('cfi', 'tli',  'rmsea',  'srmr'))

gfa_loadings5 <- inspect(fit5,what="std")$lambda

gfa_loadings5 <- as.data.frame(gfa_loadings5)



gfa_loadings5$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )


#extract the values from this
FA_rawdata6 <- as.data.frame(lavPredict(fit5, append.data = TRUE ))

FA_rawdata6 <- cbind(FA_rawdata1$eid, FA_rawdata6)

gFA <- FA_rawdata6[, c(1,2)]
colnames(gFA)[1] <- "eid"



save(gFA, file = paste(saving_directory, "Latent_gFA_brainimaging_31321.Rdata", sep=""))



## mean averages of gFA regions from left and right

FA_rawdata_mean_volumes <- FA_rawdata2


colnames(FA_rawdata_mean_volumes) <- c("AR_L",
                           "AR_R",
                           "ATR_L",
                           "ATR_R",
                           "CG_L",
                           "CG_R",
                           "PHC_L",
                           "PHC_R",
                           "CT_L",
                           "CT_R",
                           "FMaj",
                           "FMin",
                           "IFOF_L",
                           "IFOF_R",
                           "ILF_L",
                           "ILF_R",
                           "MCP",
                           "ML_L",
                           "ML_R",
                           "TR_L",
                           "TR_R",
                           "SLF_L",
                           "SFL_R",
                           "STR_L",
                           "STR_R",
                           "UF_L",
                           "UF_R",
                           "eid"
                           
                           
                           )


FA_rawdata_mean_volumes$AR <- rowMeans(FA_rawdata_mean_volumes[, c("AR_L", "AR_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$ATR <- rowMeans(FA_rawdata_mean_volumes[, c("ATR_L", "ATR_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$CG <- rowMeans(FA_rawdata_mean_volumes[, c("CG_L", "CG_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$PHC <- rowMeans(FA_rawdata_mean_volumes[, c("PHC_L", "PHC_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$CT <- rowMeans(FA_rawdata_mean_volumes[, c("CT_L", "CT_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$IFOF <- rowMeans(FA_rawdata_mean_volumes[, c("IFOF_L", "IFOF_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$ILF <- rowMeans(FA_rawdata_mean_volumes[, c("ILF_L", "ILF_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$ML <- rowMeans(FA_rawdata_mean_volumes[, c("ML_L", "ML_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$TR <- rowMeans(FA_rawdata_mean_volumes[, c("TR_L", "TR_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$SLF <- rowMeans(FA_rawdata_mean_volumes[, c("SLF_L", "SFL_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$STR <- rowMeans(FA_rawdata_mean_volumes[, c("STR_L", "STR_R") ], na.rm = TRUE )
FA_rawdata_mean_volumes$UF <- rowMeans(FA_rawdata_mean_volumes[, c("UF_L", "UF_R") ], na.rm = TRUE )



#scale all i.e. standardize and remove columes we do not need and add FA to all column names
FA_rawdata_mean_volumes <- scale(FA_rawdata_mean_volumes[,c(-1)] )
FA_rawdata_mean_volumes <- as.data.frame(FA_rawdata_mean_volumes)
FA_rawdata_mean_volumes$eid <- FA_rawdata2$eid

#only include volumes that were used in creation of the cfa latent factor


FA_rawdata_mean_volumes1 <- FA_rawdata_mean_volumes[,c( "eid",
  "AR",
  "ATR",
  "CG",
  "CT",
  "FMaj",
  "FMin",
  "IFOF",
  "ILF",
  "TR",
  "SLF",
  "STR",
  "UF"
  
  
)]

colnames(FA_rawdata_mean_volumes1) <- c("eid",
                                          "AR_FA",
  "ATR_FA",
  "CG_FA",
  "CT_FA",
  "FMaj_FA",
  "FMin_FA",
  "IFOF_FA",
  "ILF_FA",
  "TR_FA",
  "SLF_FA",
  "STR_FA",
  "UF_FA"
                                        
                                        
                                        
                                        )


save(FA_rawdata_mean_volumes1, file = paste(saving_directory, "Individual_gFA_brainimaging_19421.Rdata", sep=""))


```

# gMD
```{r readMD, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}


setDTthreads(0L)

bd <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", header=TRUE, nrows = 0)

# get column names for imaging
bdtest <- bd[,grep("[0-9]{1,10}\\-[2]\\.[0-9]|[a-z]{1,3}", colnames(bd), value = TRUE ), ]

# we are interested in Category 110 Brain MRI imaging from T1 structural brain MRI
# no normalised to head size variables included

##########################################################################
# BRAIN IMAGING VARIABLES #
###########################################################################

colwewant <- c("eid",   ## id

               "^25515\\-"   ,      #Weighted-mean MD in tract acoustic radiation (left)
               "^25516\\-"   ,      #Weighted-mean MD in tract acoustic radiation (right)
               "^25517\\-"     ,	#Weighted-mean MD in tract anterior thalamic radiation (left)
"^25518\\-"   ,	#Weighted-mean MD in tract anterior thalamic radiation (right)
"^25519\\-"   ,	#Weighted-mean MD in tract cingulate gyrus part of cingulum (left)
"^25520\\-"   ,	#Weighted-mean MD in tract cingulate gyrus part of cingulum (right)
"^25521\\-"   ,	#Weighted-mean FA in tract parahippocampal part of cingulum (left)
"^25522\\-"   ,	#Weighted-mean FA in tract parahippocampal part of cingulum (right)
"^25523\\-"   ,	#Weighted-mean MD in tract corticospinal tract (left)
"^25524\\-"   ,	#Weighted-mean MD in tract corticospinal tract (right)

"^25525\\-"   ,	#Weighted-mean MD in tract forceps major
"^25526\\-"   ,	#Weighted-mean MD in tract forceps minor
"^25527\\-"   ,	#Weighted-mean MD in tract inferior fronto-occipital MDsciculus (left)
"^25528\\-"   ,	#Weighted-mean MD in tract inferior fronto-occipital fasciculus (right)
"^25529\\-"   ,	#Weighted-mean MD in tract inferior longitudinal fasciculus (left)
"^25530\\-"   ,	#Weighted-mean MD in tract inferior longitudinal fasciculus (right)
"^25531\\-"   ,	#Weighted-mean MD in tract middle cerebellar peduncle
"^25532\\-"   ,	#Weighted-mean MD in tract medial lemniscus (left)
"^25533\\-"   ,	#Weighted-mean MD in tract medial lemniscus (right)
"^25534\\-"   ,	#Weighted-mean MD in tract posterior thalamic radiation (left)
"^25535\\-"   ,	#Weighted-mean MD in tract posterior thalamic radiation (right)
"^25536\\-"   ,	#Weighted-mean MD in tract superior longitudinal fasciculus (left)
"^25537\\-"   ,	#Weighted-mean MD in tract superior longitudinal fasciculus (right)
"^25538\\-"   ,	#Weighted-mean MD in tract superior thalamic radiation (left)
"^25539\\-"   ,	#Weighted-mean MD in tract superior thalamic radiation (right)
"^25540\\-"   ,	#Weighted-mean MD in tract uncinate fasciculus (left)
"^25541\\-"   	#Weighted-mean MD in tract uncinate fasciculus (right)


)


               
bdtest3 <- unique(grep(paste(colwewant, collapse ="|"),
                                      bdtest, value = TRUE, fixed = FALSE ))
               
              
               
tic()
# read in dataset takes nearly 1 hour (might be less now removed columns we dont need)
MD_rawdata <- fread("C:/Users/dnewby/Desktop/UKBB/ukb40537.csv", 
                               header=TRUE, 
                               sep=",", 
                              verbose = T,
                               #fill = FALSE ,
                               #quote = "",
                               #nrows = 1000 ,
                               #nrows = 502507,
                               select = bdtest3)

toc()   








#complete cases we did this as for the missing values the majority of values 28/30 were NA
MD_rawdata1 <- MD_rawdata[complete.cases(MD_rawdata[,c(2:28)]), ] 


#only use ones which are in our analysis of ISP

MD_rawdata1 <- subset(MD_rawdata1, MD_rawdata1$eid %in% Full_dataset_v1_demo$eid)


#remove values which are 0
MD_rawdata1[MD_rawdata1 == 0] <- NA

#only include complete cases
MD_rawdata1 <- MD_rawdata1[complete.cases(MD_rawdata1[,c(2:28)]), ] 
MD_rawdata2 <- MD_rawdata1



library(tidyr)

# test <- MD_rawdata2 %>%
#   pivot_longer(cols = c(
#     `25488-2.0`, `25489-2.0`, `25490-2.0`, `25491-2.0` , `25492-2.0` , `25493-2.0` , `25494-2.0` , `25495-2.0`, `25496-2.0`, `25497-2.0`, `25498-2.0` , `25499-2.0`, `25500-2.0`,`25501-2.0` ,`25502-2.0`, `25503-2.0` ,`25504-2.0`, `25505-2.0`, `25506-2.0`, `25507-2.0` ,`25508-2.0`,`25509-2.0` ,`25510-2.0` ,`25511-2.0` , `25512-2.0` , `25513-2.0` ,`25514-2.0`
#     
#     
#                         
#                         ), names_to = "FA_term", values_to = "volume") 
  

#plots the different volumes
# FA_volumes <- ggplot(test, aes(x=FA_term, y=volume, col = FA_term )) + geom_jitter() + 
#    xlab("Tract") + ylab("FA") +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")
# 
# FA_volumes


# indicates we need to remove outliers

# cfa pacakge

#scale the data i.e. make mean 1 and SD = 0
MD_rawdata2 <- scale(MD_rawdata1[,c(-1)] )
MD_rawdata2 <- as.data.frame(MD_rawdata2)
MD_rawdata2$eid <- MD_rawdata1$eid

MD_rawdata4 <- MD_rawdata2

colnames(MD_rawdata4) <- c("AR_L",
                           "AR_R",
                           "ATR_L",
                           "ATR_R",
                           "CG_L",
                           "CG_R",
                           "PHC_L",
                           "PHC_R",
                           "CT_L",
                           "CT_R",
                           "FMaj",
                           "FMin",
                           "IFOF_L",
                           "IFOF_R",
                           "ILF_L",
                           "ILF_R",
                           "MCP",
                           "ML_L",
                           "ML_R",
                           "TR_L",
                           "TR_R",
                           "SLF_L",
                           "SFL_R",
                           "STR_L",
                           "STR_R",
                           "UF_L",
                           "UF_R",
                           "eid"
                           
                           
                           
                           )



HS.model2 <- ' 
# measurement model
gMD  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + PHC_L + PHC_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + MCP + ML_L + ML_R + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
PHC_L ~~ PHC_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
ML_L ~~ ML_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R

'


# fit the model
fit2 <- cfa(HS.model2, data=MD_rawdata4)

#fit2 <- cfa(HS.model2, data=MD_rawdata3, std.lv=TRUE, orthogonal = TRUE)

#summary(fit2, fit.measures=TRUE, standardized=TRUE)

fitmeasures(fit2, c('cfi', 'tli',  'rmsea',  'srmr'))


gmd_loadings <- inspect(fit2,what="std")$lambda

gmd_loadings <- as.data.frame(gmd_loadings)

#put names into loadings


gmd_loadings$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"parahippocampal part of cingulum L" ,
"parahippocampal part of cingulum R" ,
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"middle cerebellar peduncle" ,
"medial lemniscus L" ,
"medial lemniscus R" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )




# remove low loadings <0.3

#from cox 2019 paper 
#all tract measures (left and right) were entered separately into this analysis, correlated residuals between the left and right of each tract and between some other tracts were allowed, and based on low loadings (<0.3) of the Medial Lemniscus, Middle Cerebellar Peduncle and bilateral Parahippocampal Cingulum on the first factor, these measures were not included in the factor analysis

#CFI (Comparative fit index): Measures whether the model fits the data better than a more restricted baseline model. Higher is better, with okay fit > .9.

#TLI (Tucker-Lewis index): Similar to CFI, but it penalizes overly complex models (making it more conservative than CFI). Measures whether the model fits the data better than a more restricted baseline model. Higher is better, with okay fit > .9.

# RMSEA (Root mean square error of approximation): The “error of approximation” refers to residuals. Instead of comparing to a baseline model, it measures how closely the model reproduces data patterns (i.e. the covariances among indicators). Lower is better.

# RMR/SRMR: the (Standardized) Root Mean Square Residual represents the square-root of the difference between the residuals of the sample covariance matrix and the hypothesized model. As the RMR can be sometimes hard to interpret, better to use SRMR. Should be < .08.


#################################
# remove the loadings less than 0.3 PHC and ML


HS.model3 <- ' 
# measurement model
gMD  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + MCP + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R

'


# fit the model
fit3 <- cfa(HS.model3, data=MD_rawdata4)

#fit2 <- cfa(HS.model2, data=MD_rawdata3, std.lv=TRUE, orthogonal = TRUE)

#summary(fit2, fit.measures=TRUE, standardized=TRUE)

fitmeasures(fit3, c('cfi', 'tli',  'rmsea',  'srmr'))


gmd_loadings3 <- inspect(fit3,what="std")$lambda

gmd_loadings3 <- as.data.frame(gmd_loadings3)


gmd_loadings3$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"middle cerebellar peduncle" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )



######################################################
# remove middle cerebellar peduncle as this is now < 0.3

HS.model4 <- ' 
# measurement model
gMD  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R

'


# fit the model
fit4 <- cfa(HS.model4, data=MD_rawdata4)

fitmeasures(fit4, c('cfi', 'tli',  'rmsea',  'srmr'))


gmd_loadings4 <- inspect(fit4,what="std")$lambda

gmd_loadings4 <- as.data.frame(gmd_loadings4)


gmd_loadings4$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )



####################################################
# add in correlations between regions of brain only add in those > 0.7 (high correlation)
##### trying to find which ones correlate so can include them in the model

MD_rawdata5 <- MD_rawdata4[,c(-28)]

# library("ggcorrplot")
# 
# corr <- round(cor(MD_rawdata5, use = "complete.obs"), 1)
# 
# p.mat <- cor_pmat(MD_rawdata5, use = "complete.obs")
# 
# ggcorrplot(corr)
# 
# ggcorrplot(corr,
#            hc.order = TRUE,
#            type = "lower",
#            outline.color = "white")



flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}


library(Hmisc)
res2<-rcorr(as.matrix(MD_rawdata5))
FA_correlations <- flattenCorrMatrix(res2$r, res2$P)

# only take those with correlation > 0.7 indicate a high correlation
FA_correlations_high <- subset(FA_correlations, FA_correlations$cor >= 0.7)



HS.model5 <- ' 
# measurement model
gMD  =~ AR_L + AR_R + ATR_L + ATR_R + CG_L + CG_R + CT_L + CT_R + FMaj + FMin + IFOF_L + IFOF_R + ILF_L + ILF_R + TR_L + TR_R + SLF_L + SFL_R + STR_L + STR_R + UF_L + UF_R
# residual correlations
AR_L ~~ AR_R 
ATR_L ~~ ATR_R
CG_L ~~ CG_R
CT_L ~~ CT_R
IFOF_L ~~ IFOF_R
ILF_L ~~ ILF_R
TR_L ~~ TR_R
SLF_L ~~ SFL_R
STR_L ~~ STR_R
UF_L ~~ UF_R
ATR_L ~~ IFOF_L
ATR_R ~~ IFOF_L
FMin ~~ IFOF_L
ATR_L ~~ IFOF_R
ATR_R ~~ IFOF_R
FMin ~~ IFOF_R
IFOF_L ~~ ILF_L
IFOF_R ~~ ILF_L
IFOF_L ~~ ILF_R
IFOF_R ~~ ILF_R
IFOF_L ~~ TR_L
ILF_L ~~ TR_L
IFOF_R ~~TR_R
ILF_R ~~ TR_R
ATR_L ~~ SLF_L
ATR_R ~~ SLF_L
FMin ~~ SLF_L
IFOF_L ~~ SLF_L
IFOF_R ~~ SLF_L
ILF_L ~~ SLF_L
ILF_R ~~ SLF_L
ATR_L ~~ SFL_R
ATR_R ~~ SFL_R
FMin ~~ SFL_R
IFOF_L ~~ SFL_R
IFOF_R ~~ SFL_R
ILF_L ~~ SFL_R
ILF_R ~~ SFL_R
SLF_L ~~ SFL_R
ATR_L ~~ STR_L
ATR_R ~~ STR_L
SLF_L ~~ STR_L
SFL_R ~~ STR_L
ATR_L ~~ STR_R
ATR_R ~~ STR_R
SLF_L ~~ STR_R
SFL_R ~~ STR_R
IFOF_R ~~ UF_R
ILF_R ~~ UF_R

'


# fit the model
fit5 <- cfa(HS.model5, data=MD_rawdata4)

fitmeasures(fit5, c('cfi', 'tli',  'rmsea',  'srmr'))

gmd_loadings5 <- inspect(fit5,what="std")$lambda

gmd_loadings5 <- as.data.frame(gmd_loadings5)



gmd_loadings5$name <-
  c(
                   "Acoustic radiation L" ,
               "Acoustic radiation R" ,
               "Anterior thalamic radiation L" ,
"Anterior thalamic radiation R",
"Cingulate gyrus part of cingulum L",
"Cingulate gyrus part of cingulum R",
"corticospinal tract L",
"corticospinal tract R",
"forceps major",
"forceps minor",
"inferior fronto-occipital fasciculus L" ,
"inferior fronto-occipital fasciculus R" ,
"inferior longitudinal fasciculus L" ,
"inferior longitudinal fasciculus R" ,
"thalamic radiation L" ,
"thalamic radiation R" ,
"Superior longitudinal fasciculus L" ,
"Superior longitudinal fasciculus R" ,
"superior thalamic radiation L" ,
"superior thalamic radiation R" ,
"uncinate fasciculus L" ,
"uncinate fasciculus R"
    
  )


#extract the values from this
MD_rawdata6 <- as.data.frame(lavPredict(fit5, append.data = TRUE ))

MD_rawdata6 <- cbind(MD_rawdata1$eid, MD_rawdata6)

gMD <- MD_rawdata6[, c(1,2)]
colnames(gMD)[1] <- "eid"



save(gMD, file = paste(saving_directory, "Latent_gMD_brainimaging_31321.Rdata", sep=""))



## mean averages of gMD regions from left and right

MD_rawdata_mean_volumes <- MD_rawdata2


colnames(MD_rawdata_mean_volumes) <- c("AR_L",
                           "AR_R",
                           "ATR_L",
                           "ATR_R",
                           "CG_L",
                           "CG_R",
                           "PHC_L",
                           "PHC_R",
                           "CT_L",
                           "CT_R",
                           "FMaj",
                           "FMin",
                           "IFOF_L",
                           "IFOF_R",
                           "ILF_L",
                           "ILF_R",
                           "MCP",
                           "ML_L",
                           "ML_R",
                           "TR_L",
                           "TR_R",
                           "SLF_L",
                           "SFL_R",
                           "STR_L",
                           "STR_R",
                           "UF_L",
                           "UF_R",
                           "eid"
                           
                           
                           )


MD_rawdata_mean_volumes$AR <- rowMeans(MD_rawdata_mean_volumes[, c("AR_L", "AR_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$ATR <- rowMeans(MD_rawdata_mean_volumes[, c("ATR_L", "ATR_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$CG <- rowMeans(MD_rawdata_mean_volumes[, c("CG_L", "CG_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$PHC <- rowMeans(MD_rawdata_mean_volumes[, c("PHC_L", "PHC_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$CT <- rowMeans(MD_rawdata_mean_volumes[, c("CT_L", "CT_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$IFOF <- rowMeans(MD_rawdata_mean_volumes[, c("IFOF_L", "IFOF_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$ILF <- rowMeans(MD_rawdata_mean_volumes[, c("ILF_L", "ILF_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$ML <- rowMeans(MD_rawdata_mean_volumes[, c("ML_L", "ML_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$TR <- rowMeans(MD_rawdata_mean_volumes[, c("TR_L", "TR_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$SLF <- rowMeans(MD_rawdata_mean_volumes[, c("SLF_L", "SFL_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$STR <- rowMeans(MD_rawdata_mean_volumes[, c("STR_L", "STR_R") ], na.rm = TRUE )
MD_rawdata_mean_volumes$UF <- rowMeans(MD_rawdata_mean_volumes[, c("UF_L", "UF_R") ], na.rm = TRUE )



#scale all i.e. standardize and remove columes we do not need and add MD to all column names
MD_rawdata_mean_volumes <- scale(MD_rawdata_mean_volumes[,c(-1)] )
MD_rawdata_mean_volumes <- as.data.frame(MD_rawdata_mean_volumes)
MD_rawdata_mean_volumes$eid <- MD_rawdata2$eid

#only include volumes that were used in creation of the cMD latent factor


MD_rawdata_mean_volumes1 <- MD_rawdata_mean_volumes[,c( "eid",
  "AR",
  "ATR",
  "CG",
  "CT",
  "FMaj",
  "FMin",
  "IFOF",
  "ILF",
  "TR",
  "SLF",
  "STR",
  "UF"
  
  
)]

colnames(MD_rawdata_mean_volumes1) <- c("eid",
                                          "AR_MD",
  "ATR_MD",
  "CG_MD",
  "CT_MD",
  "FMaj_MD",
  "FMin_MD",
  "IFOF_MD",
  "ILF_MD",
  "TR_MD",
  "SLF_MD",
  "STR_MD",
  "UF_MD"
                                        
                                        
                                        
                                        )


save(MD_rawdata_mean_volumes1, file = paste(saving_directory, "Individual_gMD_brainimaging_19421.Rdata", sep=""))




```

**STEP 9c** Embedding Latent variables of Brain MRI diffusion volumes into main dataset
```{r embedding, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

#full dataset
load(file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))


#embed latent factors into main dataset

#fa
load(file = paste(saving_directory, "Latent_gFA_brainimaging_31321.Rdata", sep=""))

Full_dataset_v1 <- merge(Full_dataset_v1, gFA,  by = "eid", all.x  = T)



#md
load(file = paste(saving_directory, "Latent_gMD_brainimaging_31321.Rdata", sep=""))

Full_dataset_v1 <- merge(Full_dataset_v1, gMD,  by = "eid", all.x = T)


#fa individual measures

load(file = paste(saving_directory, "Individual_gFA_brainimaging_19421.Rdata", sep=""))
Full_dataset_v1 <- merge(Full_dataset_v1, FA_rawdata_mean_volumes1,  by = "eid", all.x = T)


#md individual measures
load(file = paste(saving_directory, "Individual_gMD_brainimaging_19421.Rdata", sep=""))
Full_dataset_v1 <- merge(Full_dataset_v1, MD_rawdata_mean_volumes1,  by = "eid", all.x = T)


Full_dataset_v1_demo <- Full_dataset_v1

save(Full_dataset_v1_demo, file = paste(saving_directory,"Full_dataset_4demographics_v1.Rdata", sep =""))

save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))



```

**STEP 10** Demographics for brain imaging cohort in UKBiobank
```{r Demographics, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

load(file = paste(saving_directory,"Full_dataset_4demographics_v1.Rdata", sep =""))

Full_dataset_v1_demo <- subset(Full_dataset_v1_demo, Full_dataset_v1_demo$people2exlcude == 0)

Full_dataset_v1_demo$Ethnicity <- as.factor(Full_dataset_v1_demo$Ethnicity)
Full_dataset_v1_demo$Education <- as.factor(Full_dataset_v1_demo$Education)
Full_dataset_v1_demo$high_chol <- as.factor(Full_dataset_v1_demo$high_chol)
Full_dataset_v1_demo$diabetes <- as.factor(Full_dataset_v1_demo$diabetes)
Full_dataset_v1_demo$BP_medications <- as.factor(Full_dataset_v1_demo$BP_medications)


table <- compareGroups(isolated_systolic_hypertension ~ Age_at_assessment  +
  Education +
  UKBB_centre +
  Gender +
  BMI +
  Ethnicity +
  smoking_status +
  Diastolic_bp_2 +
  Systolic_bp_2 +
  high_chol +
  diabetes +
  `f.25010_Volbrain_grey+white matter`+
  `f.25006_Volgrey matter` +
  f.25781_WMH +
  f.25004_vol_ventricular_CSF +
  hippocampus +
  accumbens +                           
  amygdala +  
  pallidum +
  putamen +
  caudate +
  thalamus +
BP_medications +
gFA +
  gMD +
  Townsend_deciles,

byrow = FALSE,
                       
 data = Full_dataset_v1_demo)


pvals <- getResults(table, "p.overall")

fdr <- p.adjust(pvals, method = "fdr")

export_table <- createTable(table, show.n = TRUE)

#export_table

output <- as.data.frame(export_table$descr) #get output

output$FDR <- NA

output$FDR[1] <- fdr[1]
output$FDR[2] <- fdr[2]
output$FDR[4] <- fdr[3]
output$FDR[7] <- fdr[4]
output$FDR[9] <- fdr[5]
output$FDR[10] <- fdr[6]
output$FDR[12] <- fdr[7]
output$FDR[14] <- fdr[8]
output$FDR[15] <- fdr[9]
output$FDR[16] <- fdr[10]
output$FDR[18] <- fdr[11]
output$FDR[20] <- fdr[12]
output$FDR[21] <- fdr[13]
output$FDR[22] <- fdr[14]
output$FDR[23] <- fdr[15]
output$FDR[24] <- fdr[16]
output$FDR[25] <- fdr[17]
output$FDR[26] <- fdr[18]
output$FDR[27] <- fdr[19]
output$FDR[28] <- fdr[20]
output$FDR[29] <- fdr[21]
output$FDR[30] <- fdr[22]
output$FDR[31] <- fdr[23]
output$FDR[33] <- fdr[24]
output$FDR[34] <- fdr[25]
output$FDR[35] <- fdr[26]


output$Description <-


  c(
    
  "Age at assessment" ,
  "Education: No degree" ,
   "Education: Degree" ,
  "UKBB centre:chedle" ,
    "UKBB centre:reading" ,
    "UKBB centre:Newcastle" ,
  "Gender: Female" ,
  "Gender: male" ,
  "BMI" ,
"Ethnicity: Non White" , 
"Ethnicity: White" , 
  "Smoking Status: Non Smoker" ,
"Smoking Status: current/previous" ,
  "Diastolic BP" ,
  "Systolic BP" ,
  "High Cholesterol:No" ,
"High Cholesterol:Yes" ,
  "Diabetes: No" ,
 "Diabetes: Yes" ,
  "Total Brain Volume",
  "Total Grey Volume" ,
  "WMH" ,
  "Ventricular CSF" ,
  "hippocampus" ,
  "accumbens"      ,                    
  "amygdala"  ,
  "pallidum" ,
  "putamen" ,
  "caudate" ,
  "thalamus" ,
"BP_medications:No" ,
"BP_medications:Yes",
"gFA",
"gMD",
"Townsend Deprivation"
 )


colnames(output)[1] <- "Normotensive (n=17488) "
colnames(output)[2] <- "IDH (n = 648)"
colnames(output)[3] <- "ISH (n = 8174)"
colnames(output)[4] <- "Essential (n = 3465)"




output$FDR <- round(output$FDR, 5)

output <- output[,c(8,1,2,3,4,7,6)]

rownames(output) <- NULL

### export table one for the paper

write.csv(output, paste(saving_directory,"Brainvolumes_Demographics.csv", sep =""), row.names = TRUE)

save(Full_dataset_v1_demo, file = paste(saving_directory,"Full_dataset_4demographics_v1.Rdata", sep =""))






#repeat the same but split each category by medication use

Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med <- Full_dataset_v1_demo$isolated_systolic_hypertension

#     0     1     2     3 
# 17488   648  8174  3465 

# 0 = normotensive  4 = norm + BP
# 
# 1 = IDH 5 = IDH + BP
# 
# 2 = ISH 6 = ISH + BP
# 
# 3 = SDH 7 = SDH + BP



Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med[Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med == 0 & Full_dataset_v1_demo$BP_medications == 1] <- 4

Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med[Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med == 1 & Full_dataset_v1_demo$BP_medications == 1] <- 5

Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med[Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med == 2 & Full_dataset_v1_demo$BP_medications == 1] <- 6

Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med[Full_dataset_v1_demo$isolated_systolic_hypertension_strat_med == 3 & Full_dataset_v1_demo$BP_medications == 1] <- 7

#repeat table 1 demographics

table <- compareGroups(isolated_systolic_hypertension_strat_med ~ Age_at_assessment  +
  Education +
  UKBB_centre +
  Gender +
  BMI +
  Ethnicity +
  smoking_status +
  Diastolic_bp_2 +
  Systolic_bp_2 +
  high_chol +
  diabetes +
  `f.25010_Volbrain_grey+white matter`+
  `f.25006_Volgrey matter` +
  f.25781_WMH +
  f.25004_vol_ventricular_CSF +
  hippocampus +
  accumbens +                           
  amygdala +  
  pallidum +
  putamen +
  caudate +
  thalamus +
BP_medications +
gFA +
  gMD +
  Townsend_deciles,

byrow = FALSE,
max.ylev = 8 ,
                       
 data = Full_dataset_v1_demo)


pvals <- getResults(table, "p.overall")

fdr <- p.adjust(pvals, method = "fdr")

export_table <- createTable(table, show.n = TRUE)

#export_table

output <- as.data.frame(export_table$descr) #get output

output$FDR <- NA

output$FDR[1] <- fdr[1]
output$FDR[2] <- fdr[2]
output$FDR[4] <- fdr[3]
output$FDR[7] <- fdr[4]
output$FDR[9] <- fdr[5]
output$FDR[10] <- fdr[6]
output$FDR[12] <- fdr[7]
output$FDR[14] <- fdr[8]
output$FDR[15] <- fdr[9]
output$FDR[16] <- fdr[10]
output$FDR[18] <- fdr[11]
output$FDR[20] <- fdr[12]
output$FDR[21] <- fdr[13]
output$FDR[22] <- fdr[14]
output$FDR[23] <- fdr[15]
output$FDR[24] <- fdr[16]
output$FDR[25] <- fdr[17]
output$FDR[26] <- fdr[18]
output$FDR[27] <- fdr[19]
output$FDR[28] <- fdr[20]
output$FDR[29] <- fdr[21]
output$FDR[30] <- fdr[22]
output$FDR[31] <- fdr[23]
output$FDR[33] <- fdr[24]
output$FDR[34] <- fdr[25]
output$FDR[35] <- fdr[26]


output$Description <-


  c(
    
  "Age at assessment" ,
  "Education: No degree" ,
   "Education: Degree" ,
  "UKBB centre:chedle" ,
    "UKBB centre:reading" ,
    "UKBB centre:Newcastle" ,
  "Gender: Female" ,
  "Gender: male" ,
  "BMI" ,
"Ethnicity: Non White" , 
"Ethnicity: White" , 
  "Smoking Status: Non Smoker" ,
"Smoking Status: current/previous" ,
  "Diastolic BP" ,
  "Systolic BP" ,
  "High Cholesterol:No" ,
"High Cholesterol:Yes" ,
  "Diabetes: No" ,
 "Diabetes: Yes" ,
  "Total Brain Volume",
  "Total Grey Volume" ,
  "WMH" ,
  "Ventricular CSF" ,
  "hippocampus" ,
  "accumbens"      ,                    
  "amygdala"  ,
  "pallidum" ,
  "putamen" ,
  "caudate" ,
  "thalamus" ,
"BP_medications:No" ,
"BP_medications:Yes",
"gFA",
"gMD",
"Townsend Deprivation"
 )


colnames(output)[1] <- "Normotensive - BP Meds (n=14584) "
colnames(output)[2] <- "IDH - BP Meds (n = 457)"
colnames(output)[3] <- "ISH - BP Meds (n = 5558)"
colnames(output)[4] <- "Essential - BP Meds (n = 2464)"
colnames(output)[5] <- "Normotensive + BP Meds (n=2904) "
colnames(output)[6] <- "IDH + BP Meds (n = 191)"
colnames(output)[7] <- "ISH + BP Meds (n = 2616)"
colnames(output)[8] <- "Essential + BP Meds (n = 1001)"

output$FDR <- round(output$FDR, 5)

output <- output[,c(12, 1, 5,
                    2, 6,
                    3, 7,
                    4, 8,
                    11, 10)]

rownames(output) <- NULL

### export table one for the paper

write.csv(output, paste(saving_directory,"Brainvolumes_stratBP_Demographics.csv", sep =""), row.names = TRUE)

save(Full_dataset_v1_demo, file = paste(saving_directory,"Full_dataset_4demographics_v2.Rdata", sep =""))





```

**STEP 11a** Standardising variables. 
```{r standardizing, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

load(file = paste(saving_directory,"Full_dataset_13122020_v1.Rdata", sep =""))


# total brain volume = standardized volume
# total brain volume_unstandardized = unstandardized volume

# create a copy of all outcome measures
# brain volumes

Full_dataset_v1$`f.25010_Volbrain_grey+white matter_unstandardized`<-
Full_dataset_v1$`f.25010_Volbrain_grey+white matter`

Full_dataset_v1$f.25781_WMH_LOG_unstandardized <- Full_dataset_v1$f.25781_WMH_LOG

Full_dataset_v1$f.25019_vol_hippocampus_L_unstandardized <-
Full_dataset_v1$f.25019_vol_hippocampus_L

Full_dataset_v1$f.25020_vol_hippocampus_R_unstandardized <-
Full_dataset_v1$f.25020_vol_hippocampus_R

Full_dataset_v1$hippocampus_unstandardized <-
Full_dataset_v1$hippocampus

Full_dataset_v1$f.25013_vol_caudate_L_unstandardized <-
Full_dataset_v1$f.25013_vol_caudate_L

Full_dataset_v1$f.25014_vol_caudate_R_unstandardized <-
Full_dataset_v1$f.25014_vol_caudate_R

Full_dataset_v1$caudate_unstandardized <-
Full_dataset_v1$caudate

Full_dataset_v1$f.25015_vol_putamen_L_unstandardized <-
Full_dataset_v1$f.25015_vol_putamen_L

Full_dataset_v1$f.25016_vol_putamen_R_unstandardized <-
Full_dataset_v1$f.25016_vol_putamen_R

Full_dataset_v1$putamen_unstandardized <-
Full_dataset_v1$putamen

Full_dataset_v1$f.25011_vol_thalamus_L_unstandardized <-
Full_dataset_v1$f.25011_vol_thalamus_L

Full_dataset_v1$f.25012_vol_thalamus_R_unstandardized <-
Full_dataset_v1$f.25012_vol_thalamus_R

Full_dataset_v1$thalamus_unstandardized <-
Full_dataset_v1$thalamus

Full_dataset_v1$f.25017_vol_pallidum_L_unstandardized <-
Full_dataset_v1$f.25017_vol_pallidum_L

Full_dataset_v1$f.25018_vol_pallidum_R_unstandardized <-
Full_dataset_v1$f.25018_vol_pallidum_R

Full_dataset_v1$pallidum_unstandardized <-
Full_dataset_v1$pallidum

Full_dataset_v1$f.25021_vol_amygdala_L_unstandardized <-
Full_dataset_v1$f.25021_vol_amygdala_L

Full_dataset_v1$f.25022_vol_amygdala_R_unstandardized <-
Full_dataset_v1$f.25022_vol_amygdala_R

Full_dataset_v1$amygdala_unstandardized <-
Full_dataset_v1$amygdala

Full_dataset_v1$f.25023_vol_accumbens_L_unstandardized <-
Full_dataset_v1$f.25023_vol_accumbens_L 

Full_dataset_v1$f.25024_vol_accumbens_R_unstandardized <-
Full_dataset_v1$f.25024_vol_accumbens_R

Full_dataset_v1$accumbens_unstandardized <-
Full_dataset_v1$accumbens

Full_dataset_v1$f.25004_vol_ventricular_CSF_unstandardized <-
Full_dataset_v1$f.25004_vol_ventricular_CSF

Full_dataset_v1$`f.25006_Volgrey matter_unstandardized` <-
Full_dataset_v1$`f.25006_Volgrey matter`

Full_dataset_v1$f6348_Duration_trailA_unstandardized <-
Full_dataset_v1$f6348_Duration_trailA

Full_dataset_v1$f6350_Duration_trailB_unstandardized <-
Full_dataset_v1$f6350_Duration_trailB

Full_dataset_v1$f6373_matrix_pattern_puzzles_solved_unstandardized <-
Full_dataset_v1$f6373_matrix_pattern_puzzles_solved

Full_dataset_v1$f23324_correct_symbol_digit_matches_unstandardized  <-
Full_dataset_v1$f23324_correct_symbol_digit_matches

Full_dataset_v1$f.399.2.2_Memory_pm_6pairs_unstandardized <-
Full_dataset_v1$f.399.2.2_Memory_pm_6pairs

Full_dataset_v1$f.20016.2.0_fluid_intelligence_unstandardized  <-
Full_dataset_v1$f.20016.2.0_fluid_intelligence

Full_dataset_v1$f.20023.2.0_reaction_time_unstandardized <-
Full_dataset_v1$f.20023.2.0_reaction_time

Full_dataset_v1$`21004_correct_tower_arranging_unstandardized` <-
Full_dataset_v1$`21004_correct_tower_arranging`

Full_dataset_v1$TMTB_MINUS_TMTA_unstandardized <- Full_dataset_v1$TMTB_MINUS_TMTA

#hipp head
Full_dataset_v1$f.26640_head_hippo_L_unstandardized <- Full_dataset_v1$f.26640_head_hippo_L
Full_dataset_v1$f.26662_head_hippo_R_unstandardized <- Full_dataset_v1$f.26662_head_hippo_R
Full_dataset_v1$FS_hippocampal_head_unstandardized <- Full_dataset_v1$FS_hippocampal_head


#hipp whole
Full_dataset_v1$f.26641_whole_hippo_L_unstandardized <- Full_dataset_v1$f.26641_whole_hippo_L
Full_dataset_v1$f.26663_whole_hippo_R_unstandardized <- Full_dataset_v1$f.26663_whole_hippo_R
Full_dataset_v1$FS_hippocampal_whole_unstandardized <- Full_dataset_v1$FS_hippocampal_whole

#hipp tail
Full_dataset_v1$f.26620_tail_hippo_L_unstandardized <- Full_dataset_v1$f.26620_tail_hippo_L
Full_dataset_v1$f.26642_tail_hippo_R_unstandardized <- Full_dataset_v1$f.26642_tail_hippo_R
Full_dataset_v1$FS_hippocampal_tail_unstandardized <- Full_dataset_v1$FS_hippocampal_tail
  
#hipp body
Full_dataset_v1$f.26639_body_hippo_L_unstandardized <- Full_dataset_v1$f.26639_body_hippo_L
Full_dataset_v1$f.26661_body_hippo_R_unstandardized <- Full_dataset_v1$f.26661_body_hippo_R
Full_dataset_v1$FS_hippocampal_body_unstandardized <- Full_dataset_v1$FS_hippocampal_body


# log the variables that need to be transformed
# pairs matching needs log(var + 1)
Full_dataset_v1$f.399.2.2_Memory_pm_6pairs <- log(Full_dataset_v1$f.399.2.2_Memory_pm_6pairs + 1)

#log reaction time
Full_dataset_v1$f.20023.2.0_reaction_time <- log(Full_dataset_v1$f.20023.2.0_reaction_time)

#log TMTA
Full_dataset_v1$f6348_Duration_trailA <- log(Full_dataset_v1$f6348_Duration_trailA)

#log TMTB
Full_dataset_v1$f6350_Duration_trailB <- log(Full_dataset_v1$f6350_Duration_trailB)

#log TMTB-A not going to log transform as it contains both positive and negative values
Full_dataset_v1$TMTB_MINUS_TMTA <- sqrt(Full_dataset_v1$TMTB_MINUS_TMTA)





# 
# ###################################################################
# 
# # apply the standardized method to the variables
# 
# 
Full_dataset_v1$`f.25010_Volbrain_grey+white matter` <- (Full_dataset_v1$`f.25010_Volbrain_grey+white matter` - mean(Full_dataset_v1$`f.25010_Volbrain_grey+white matter`, na.rm = TRUE)) / sd(Full_dataset_v1$`f.25010_Volbrain_grey+white matter`, na.rm = TRUE)

 Full_dataset_v1$f.25781_WMH_LOG <- (Full_dataset_v1$f.25781_WMH_LOG - mean(Full_dataset_v1$f.25781_WMH_LOG, na.rm = TRUE)) / sd(Full_dataset_v1$f.25781_WMH_LOG, na.rm = TRUE)

Full_dataset_v1$f.25019_vol_hippocampus_L <-
  (Full_dataset_v1$f.25019_vol_hippocampus_L - mean(Full_dataset_v1$f.25019_vol_hippocampus_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25019_vol_hippocampus_L, na.rm = TRUE)

Full_dataset_v1$f.25020_vol_hippocampus_R <-
  (Full_dataset_v1$f.25020_vol_hippocampus_R - mean(Full_dataset_v1$f.25020_vol_hippocampus_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25020_vol_hippocampus_R, na.rm = TRUE)

Full_dataset_v1$f.25004_vol_ventricular_CSF <-
  (Full_dataset_v1$f.25004_vol_ventricular_CSF - mean(Full_dataset_v1$f.25004_vol_ventricular_CSF, na.rm = TRUE)) / sd(Full_dataset_v1$f.25004_vol_ventricular_CSF, na.rm = TRUE)

Full_dataset_v1$`f.25006_Volgrey matter` <- (Full_dataset_v1$`f.25006_Volgrey matter` - mean(Full_dataset_v1$`f.25006_Volgrey matter`, na.rm = TRUE)) / sd(Full_dataset_v1$`f.25006_Volgrey matter`, na.rm = TRUE)

Full_dataset_v1$f.25011_vol_thalamus_L <-
  (Full_dataset_v1$f.25011_vol_thalamus_L - mean(Full_dataset_v1$f.25011_vol_thalamus_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25011_vol_thalamus_L, na.rm = TRUE)

Full_dataset_v1$f.25012_vol_thalamus_R <-
  (Full_dataset_v1$f.25012_vol_thalamus_R - mean(Full_dataset_v1$f.25012_vol_thalamus_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25012_vol_thalamus_R, na.rm = TRUE)

Full_dataset_v1$thalamus <-
  (Full_dataset_v1$thalamus - mean(Full_dataset_v1$thalamus, na.rm = TRUE)) / sd(Full_dataset_v1$thalamus, na.rm = TRUE)


Full_dataset_v1$f.25013_vol_caudate_L <-
  (Full_dataset_v1$f.25013_vol_caudate_L - mean(Full_dataset_v1$f.25013_vol_caudate_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25013_vol_caudate_L, na.rm = TRUE)

Full_dataset_v1$f.25014_vol_caudate_R <-
  (Full_dataset_v1$f.25014_vol_caudate_R - mean(Full_dataset_v1$f.25014_vol_caudate_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25014_vol_caudate_R, na.rm = TRUE)

Full_dataset_v1$caudate <-
  (Full_dataset_v1$caudate - mean(Full_dataset_v1$caudate, na.rm = TRUE)) / sd(Full_dataset_v1$caudate, na.rm = TRUE)

Full_dataset_v1$f.25015_vol_putamen_L <-
  (Full_dataset_v1$f.25015_vol_putamen_L - mean(Full_dataset_v1$f.25015_vol_putamen_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25015_vol_putamen_L, na.rm = TRUE)

Full_dataset_v1$f.25016_vol_putamen_R <-
  (Full_dataset_v1$f.25016_vol_putamen_R - mean(Full_dataset_v1$f.25016_vol_putamen_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25016_vol_putamen_R, na.rm = TRUE)

Full_dataset_v1$putamen <-
  (Full_dataset_v1$putamen - mean(Full_dataset_v1$putamen, na.rm = TRUE)) / sd(Full_dataset_v1$putamen, na.rm = TRUE)

Full_dataset_v1$f.25017_vol_pallidum_L <-
  (Full_dataset_v1$f.25017_vol_pallidum_L - mean(Full_dataset_v1$f.25017_vol_pallidum_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25017_vol_pallidum_L, na.rm = TRUE)

Full_dataset_v1$f.25018_vol_pallidum_R <-
  (Full_dataset_v1$f.25018_vol_pallidum_R - mean(Full_dataset_v1$f.25018_vol_pallidum_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25018_vol_pallidum_R, na.rm = TRUE)

Full_dataset_v1$pallidum <-
  (Full_dataset_v1$pallidum - mean(Full_dataset_v1$pallidum, na.rm = TRUE)) / sd(Full_dataset_v1$pallidum, na.rm = TRUE)

Full_dataset_v1$hippocampus <-
  (Full_dataset_v1$hippocampus - mean(Full_dataset_v1$hippocampus, na.rm = TRUE)) / sd(Full_dataset_v1$hippocampus, na.rm = TRUE)

Full_dataset_v1$f.25021_vol_amygdala_L <-
  (Full_dataset_v1$f.25021_vol_amygdala_L - mean(Full_dataset_v1$f.25021_vol_amygdala_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25021_vol_amygdala_L, na.rm = TRUE)

Full_dataset_v1$f.25022_vol_amygdala_R <-
  (Full_dataset_v1$f.25022_vol_amygdala_R - mean(Full_dataset_v1$f.25022_vol_amygdala_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25022_vol_amygdala_R, na.rm = TRUE)

Full_dataset_v1$amygdala <-
  (Full_dataset_v1$amygdala - mean(Full_dataset_v1$amygdala, na.rm = TRUE)) / sd(Full_dataset_v1$amygdala, na.rm = TRUE)

Full_dataset_v1$f.25023_vol_accumbens_L <-
  (Full_dataset_v1$f.25023_vol_accumbens_L - mean(Full_dataset_v1$f.25023_vol_accumbens_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25023_vol_accumbens_L, na.rm = TRUE)

Full_dataset_v1$f.25024_vol_accumbens_R <-
  (Full_dataset_v1$f.25024_vol_accumbens_R - mean(Full_dataset_v1$f.25024_vol_accumbens_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25024_vol_accumbens_R, na.rm = TRUE)

Full_dataset_v1$accumbens <-
  (Full_dataset_v1$accumbens - mean(Full_dataset_v1$accumbens, na.rm = TRUE)) / sd(Full_dataset_v1$accumbens, na.rm = TRUE)

#log transformed
Full_dataset_v1$f6348_Duration_trailA   <-  (Full_dataset_v1$f6348_Duration_trailA - mean(Full_dataset_v1$f6348_Duration_trailA, na.rm = TRUE)) / sd(Full_dataset_v1$f6348_Duration_trailA, na.rm = TRUE)

#log transformed
Full_dataset_v1$f6350_Duration_trailB <- (Full_dataset_v1$f6350_Duration_trailB - mean(Full_dataset_v1$f6350_Duration_trailB, na.rm = TRUE)) / sd(Full_dataset_v1$f6350_Duration_trailB, na.rm = TRUE)

Full_dataset_v1$TMTB_MINUS_TMTA <- (Full_dataset_v1$TMTB_MINUS_TMTA - mean(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)) / sd(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)

Full_dataset_v1$f6373_matrix_pattern_puzzles_solved   <- (Full_dataset_v1$f6373_matrix_pattern_puzzles_solved - mean(Full_dataset_v1$f6373_matrix_pattern_puzzles_solved, na.rm = TRUE)) / sd(Full_dataset_v1$f6373_matrix_pattern_puzzles_solved, na.rm = TRUE)

Full_dataset_v1$f23324_correct_symbol_digit_matches <- (Full_dataset_v1$f23324_correct_symbol_digit_matches - mean(Full_dataset_v1$f23324_correct_symbol_digit_matches, na.rm = TRUE)) / sd(Full_dataset_v1$f23324_correct_symbol_digit_matches, na.rm = TRUE)

#log + 1
Full_dataset_v1$f.399.2.2_Memory_pm_6pairs <- (Full_dataset_v1$f.399.2.2_Memory_pm_6pairs - mean(Full_dataset_v1$f.399.2.2_Memory_pm_6pairs, na.rm = TRUE)) / sd(Full_dataset_v1$f.399.2.2_Memory_pm_6pairs, na.rm = TRUE)

Full_dataset_v1$f.20016.2.0_fluid_intelligence    <- (Full_dataset_v1$f.20016.2.0_fluid_intelligence - mean(Full_dataset_v1$f.20016.2.0_fluid_intelligence, na.rm = TRUE)) / sd(Full_dataset_v1$f.20016.2.0_fluid_intelligence, na.rm = TRUE)

#log
Full_dataset_v1$f.20023.2.0_reaction_time <- (Full_dataset_v1$f.20023.2.0_reaction_time - mean(Full_dataset_v1$f.20023.2.0_reaction_time, na.rm = TRUE)) / sd(Full_dataset_v1$f.20023.2.0_reaction_time, na.rm = TRUE)

# tower rearranging

Full_dataset_v1$`21004_correct_tower_arranging` <- (Full_dataset_v1$`21004_correct_tower_arranging` - mean(Full_dataset_v1$`21004_correct_tower_arranging`, na.rm = TRUE)) / sd(Full_dataset_v1$`21004_correct_tower_arranging`, na.rm = TRUE)

# Full_dataset_v1$TMTB_MINUS_TMTA
Full_dataset_v1$TMTB_MINUS_TMTA <- (Full_dataset_v1$TMTB_MINUS_TMTA - mean(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)) / sd(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)

# continuous predictors

#age at assessment
Full_dataset_v1$Age_at_assessment_unstadardized <- Full_dataset_v1$Age_at_assessment  
Full_dataset_v1$Age_at_assessment <- (Full_dataset_v1$Age_at_assessment - mean(Full_dataset_v1$Age_at_assessment, na.rm = TRUE)) / sd(Full_dataset_v1$Age_at_assessment, na.rm = TRUE)

#length of hypertension
Full_dataset_v1$length_of_hypertension_self_reported_unstandardized <- Full_dataset_v1$length_of_hypertension_self_reported

Full_dataset_v1$length_of_hypertension_self_reported <- (Full_dataset_v1$length_of_hypertension_self_reported - mean(Full_dataset_v1$length_of_hypertension_self_reported, na.rm = TRUE)) / sd(Full_dataset_v1$length_of_hypertension_self_reported, na.rm = TRUE)


#length of hypertension including those those with not 
Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive <- Full_dataset_v1$length_of_hypertension_self_reported 

# there are 342 people with length of hypertension set to 0 we need to readjust these so they dont get lost in the normatensive group - set them to 0.5 (6 months)
Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive[
  Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive == 0 ] <- 0.5
# replace those who are normatensive with a zero
Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive[
  Full_dataset_v1$hypertension != 1 ] <- 0


# head size scaling variable
Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space_unstandardized <- 
Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space

Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space <- (Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space - mean(Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space, na.rm = TRUE)) / sd(Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space, na.rm = TRUE)

# BMI
Full_dataset_v1$BMI_unstandardized <- 
Full_dataset_v1$BMI

Full_dataset_v1$BMI <- (Full_dataset_v1$BMI - mean(Full_dataset_v1$BMI, na.rm = TRUE)) / sd(Full_dataset_v1$BMI, na.rm = TRUE)


# hippo whole

Full_dataset_v1$FS_hippocampal_whole <-
  (Full_dataset_v1$FS_hippocampal_whole - mean(Full_dataset_v1$FS_hippocampal_whole, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_whole, na.rm = TRUE)

Full_dataset_v1$f.26641_whole_hippo_L <-
  (Full_dataset_v1$f.26641_whole_hippo_L - mean(Full_dataset_v1$f.26641_whole_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26641_whole_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26663_whole_hippo_R <-
  (Full_dataset_v1$f.26663_whole_hippo_R - mean(Full_dataset_v1$f.26663_whole_hippo_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.26663_whole_hippo_R, na.rm = TRUE)

# hippo head

Full_dataset_v1$FS_hippocampal_head <-
  (Full_dataset_v1$FS_hippocampal_head - mean(Full_dataset_v1$FS_hippocampal_head, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_head, na.rm = TRUE)

Full_dataset_v1$f.26640_head_hippo_L <-
  (Full_dataset_v1$f.26640_head_hippo_L - mean(Full_dataset_v1$f.26640_head_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26640_head_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26662_head_hippo_R <-
  (Full_dataset_v1$f.26662_head_hippo_R  - mean(Full_dataset_v1$f.26662_head_hippo_R , na.rm = TRUE)) / sd(Full_dataset_v1$f.26662_head_hippo_R , na.rm = TRUE)

# hippo tail

Full_dataset_v1$FS_hippocampal_tail <-
  (Full_dataset_v1$FS_hippocampal_tail - mean(Full_dataset_v1$FS_hippocampal_tail, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_tail, na.rm = TRUE)

Full_dataset_v1$f.26620_tail_hippo_L <-
  (Full_dataset_v1$f.26620_tail_hippo_L - mean(Full_dataset_v1$f.26620_tail_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26620_tail_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26642_tail_hippo_R <-
  (Full_dataset_v1$f.26642_tail_hippo_R - mean(Full_dataset_v1$f.26642_tail_hippo_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.26642_tail_hippo_R, na.rm = TRUE)

# hippo body

Full_dataset_v1$FS_hippocampal_body <-
  (Full_dataset_v1$FS_hippocampal_body - mean(Full_dataset_v1$FS_hippocampal_body, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_body, na.rm = TRUE)

Full_dataset_v1$f.26639_body_hippo_L <-
  (Full_dataset_v1$f.26639_body_hippo_L - mean(Full_dataset_v1$f.26639_body_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26639_body_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26661_body_hippo_R <-
  (Full_dataset_v1$f.26661_body_hippo_R - mean(Full_dataset_v1$f.26661_body_hippo_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.26661_body_hippo_R, na.rm = TRUE)


save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_ALL27721_v1.Rdata", sep =""))


```

**STEP 11** Standardising variables. The majority of publications are standardsing their beta to allow comparisons across the different outcome variables. All outcome and continuous predictors will be standardised with mean of zero and SD of 1. (Latent variables have already been standardized). Removed those with neurological conditions
```{r standardizing, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

load(file = paste(saving_directory,"Full_dataset_4demographics_v1.Rdata", sep =""))

#remove people with nurological condition
Full_dataset_v1 <- Full_dataset_v1_demo

# total brain volume = standardized volume
# total brain volume_unstandardized = unstandardized volume

# create a copy of all outcome measures
# brain volumes

Full_dataset_v1$`f.25010_Volbrain_grey+white matter_unstandardized`<-
Full_dataset_v1$`f.25010_Volbrain_grey+white matter`

Full_dataset_v1$f.25781_WMH_LOG_unstandardized <- Full_dataset_v1$f.25781_WMH_LOG

Full_dataset_v1$f.25019_vol_hippocampus_L_unstandardized <-
Full_dataset_v1$f.25019_vol_hippocampus_L

Full_dataset_v1$f.25020_vol_hippocampus_R_unstandardized <-
Full_dataset_v1$f.25020_vol_hippocampus_R

Full_dataset_v1$hippocampus_unstandardized <-
Full_dataset_v1$hippocampus

Full_dataset_v1$f.25013_vol_caudate_L_unstandardized <-
Full_dataset_v1$f.25013_vol_caudate_L

Full_dataset_v1$f.25014_vol_caudate_R_unstandardized <-
Full_dataset_v1$f.25014_vol_caudate_R

Full_dataset_v1$caudate_unstandardized <-
Full_dataset_v1$caudate

Full_dataset_v1$f.25015_vol_putamen_L_unstandardized <-
Full_dataset_v1$f.25015_vol_putamen_L

Full_dataset_v1$f.25016_vol_putamen_R_unstandardized <-
Full_dataset_v1$f.25016_vol_putamen_R

Full_dataset_v1$putamen_unstandardized <-
Full_dataset_v1$putamen

Full_dataset_v1$f.25011_vol_thalamus_L_unstandardized <-
Full_dataset_v1$f.25011_vol_thalamus_L

Full_dataset_v1$f.25012_vol_thalamus_R_unstandardized <-
Full_dataset_v1$f.25012_vol_thalamus_R

Full_dataset_v1$thalamus_unstandardized <-
Full_dataset_v1$thalamus

Full_dataset_v1$f.25017_vol_pallidum_L_unstandardized <-
Full_dataset_v1$f.25017_vol_pallidum_L

Full_dataset_v1$f.25018_vol_pallidum_R_unstandardized <-
Full_dataset_v1$f.25018_vol_pallidum_R

Full_dataset_v1$pallidum_unstandardized <-
Full_dataset_v1$pallidum

Full_dataset_v1$f.25021_vol_amygdala_L_unstandardized <-
Full_dataset_v1$f.25021_vol_amygdala_L

Full_dataset_v1$f.25022_vol_amygdala_R_unstandardized <-
Full_dataset_v1$f.25022_vol_amygdala_R

Full_dataset_v1$amygdala_unstandardized <-
Full_dataset_v1$amygdala

Full_dataset_v1$f.25023_vol_accumbens_L_unstandardized <-
Full_dataset_v1$f.25023_vol_accumbens_L 

Full_dataset_v1$f.25024_vol_accumbens_R_unstandardized <-
Full_dataset_v1$f.25024_vol_accumbens_R

Full_dataset_v1$accumbens_unstandardized <-
Full_dataset_v1$accumbens

Full_dataset_v1$f.25004_vol_ventricular_CSF_unstandardized <-
Full_dataset_v1$f.25004_vol_ventricular_CSF

Full_dataset_v1$`f.25006_Volgrey matter_unstandardized` <-
Full_dataset_v1$`f.25006_Volgrey matter`

Full_dataset_v1$f6348_Duration_trailA_unstandardized <-
Full_dataset_v1$f6348_Duration_trailA

Full_dataset_v1$f6350_Duration_trailB_unstandardized <-
Full_dataset_v1$f6350_Duration_trailB

Full_dataset_v1$f6373_matrix_pattern_puzzles_solved_unstandardized <-
Full_dataset_v1$f6373_matrix_pattern_puzzles_solved

Full_dataset_v1$f23324_correct_symbol_digit_matches_unstandardized  <-
Full_dataset_v1$f23324_correct_symbol_digit_matches

Full_dataset_v1$f.399.2.2_Memory_pm_6pairs_unstandardized <-
Full_dataset_v1$f.399.2.2_Memory_pm_6pairs

Full_dataset_v1$f.20016.2.0_fluid_intelligence_unstandardized  <-
Full_dataset_v1$f.20016.2.0_fluid_intelligence

Full_dataset_v1$f.20023.2.0_reaction_time_unstandardized <-
Full_dataset_v1$f.20023.2.0_reaction_time

Full_dataset_v1$`21004_correct_tower_arranging_unstandardized` <-
Full_dataset_v1$`21004_correct_tower_arranging`

Full_dataset_v1$TMTB_MINUS_TMTA_unstandardized <- Full_dataset_v1$TMTB_MINUS_TMTA

#hipp head
Full_dataset_v1$f.26640_head_hippo_L_unstandardized <- Full_dataset_v1$f.26640_head_hippo_L
Full_dataset_v1$f.26662_head_hippo_R_unstandardized <- Full_dataset_v1$f.26662_head_hippo_R
Full_dataset_v1$FS_hippocampal_head_unstandardized <- Full_dataset_v1$FS_hippocampal_head


#hipp whole
Full_dataset_v1$f.26641_whole_hippo_L_unstandardized <- Full_dataset_v1$f.26641_whole_hippo_L
Full_dataset_v1$f.26663_whole_hippo_R_unstandardized <- Full_dataset_v1$f.26663_whole_hippo_R
Full_dataset_v1$FS_hippocampal_whole_unstandardized <- Full_dataset_v1$FS_hippocampal_whole

#hipp tail
Full_dataset_v1$f.26620_tail_hippo_L_unstandardized <- Full_dataset_v1$f.26620_tail_hippo_L
Full_dataset_v1$f.26642_tail_hippo_R_unstandardized <- Full_dataset_v1$f.26642_tail_hippo_R
Full_dataset_v1$FS_hippocampal_tail_unstandardized <- Full_dataset_v1$FS_hippocampal_tail
  
#hipp body
Full_dataset_v1$f.26639_body_hippo_L_unstandardized <- Full_dataset_v1$f.26639_body_hippo_L
Full_dataset_v1$f.26661_body_hippo_R_unstandardized <- Full_dataset_v1$f.26661_body_hippo_R
Full_dataset_v1$FS_hippocampal_body_unstandardized <- Full_dataset_v1$FS_hippocampal_body


# log the variables that need to be transformed
# pairs matching needs log(var + 1)
Full_dataset_v1$f.399.2.2_Memory_pm_6pairs <- log(Full_dataset_v1$f.399.2.2_Memory_pm_6pairs + 1)

#log reaction time
Full_dataset_v1$f.20023.2.0_reaction_time <- log(Full_dataset_v1$f.20023.2.0_reaction_time)

#log TMTA
Full_dataset_v1$f6348_Duration_trailA <- log(Full_dataset_v1$f6348_Duration_trailA)

#log TMTB
Full_dataset_v1$f6350_Duration_trailB <- log(Full_dataset_v1$f6350_Duration_trailB)

#log TMTB-A not going to log transform as it contains both positive and negative values
Full_dataset_v1$TMTB_MINUS_TMTA <- sqrt(Full_dataset_v1$TMTB_MINUS_TMTA)





# 
# ###################################################################
# 
# # apply the standardized method to the variables
# 
# 
Full_dataset_v1$`f.25010_Volbrain_grey+white matter` <- (Full_dataset_v1$`f.25010_Volbrain_grey+white matter` - mean(Full_dataset_v1$`f.25010_Volbrain_grey+white matter`, na.rm = TRUE)) / sd(Full_dataset_v1$`f.25010_Volbrain_grey+white matter`, na.rm = TRUE)

 Full_dataset_v1$f.25781_WMH_LOG <- (Full_dataset_v1$f.25781_WMH_LOG - mean(Full_dataset_v1$f.25781_WMH_LOG, na.rm = TRUE)) / sd(Full_dataset_v1$f.25781_WMH_LOG, na.rm = TRUE)

Full_dataset_v1$f.25019_vol_hippocampus_L <-
  (Full_dataset_v1$f.25019_vol_hippocampus_L - mean(Full_dataset_v1$f.25019_vol_hippocampus_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25019_vol_hippocampus_L, na.rm = TRUE)

Full_dataset_v1$f.25020_vol_hippocampus_R <-
  (Full_dataset_v1$f.25020_vol_hippocampus_R - mean(Full_dataset_v1$f.25020_vol_hippocampus_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25020_vol_hippocampus_R, na.rm = TRUE)

Full_dataset_v1$f.25004_vol_ventricular_CSF <-
  (Full_dataset_v1$f.25004_vol_ventricular_CSF - mean(Full_dataset_v1$f.25004_vol_ventricular_CSF, na.rm = TRUE)) / sd(Full_dataset_v1$f.25004_vol_ventricular_CSF, na.rm = TRUE)

Full_dataset_v1$`f.25006_Volgrey matter` <- (Full_dataset_v1$`f.25006_Volgrey matter` - mean(Full_dataset_v1$`f.25006_Volgrey matter`, na.rm = TRUE)) / sd(Full_dataset_v1$`f.25006_Volgrey matter`, na.rm = TRUE)

Full_dataset_v1$f.25011_vol_thalamus_L <-
  (Full_dataset_v1$f.25011_vol_thalamus_L - mean(Full_dataset_v1$f.25011_vol_thalamus_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25011_vol_thalamus_L, na.rm = TRUE)

Full_dataset_v1$f.25012_vol_thalamus_R <-
  (Full_dataset_v1$f.25012_vol_thalamus_R - mean(Full_dataset_v1$f.25012_vol_thalamus_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25012_vol_thalamus_R, na.rm = TRUE)

Full_dataset_v1$thalamus <-
  (Full_dataset_v1$thalamus - mean(Full_dataset_v1$thalamus, na.rm = TRUE)) / sd(Full_dataset_v1$thalamus, na.rm = TRUE)


Full_dataset_v1$f.25013_vol_caudate_L <-
  (Full_dataset_v1$f.25013_vol_caudate_L - mean(Full_dataset_v1$f.25013_vol_caudate_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25013_vol_caudate_L, na.rm = TRUE)

Full_dataset_v1$f.25014_vol_caudate_R <-
  (Full_dataset_v1$f.25014_vol_caudate_R - mean(Full_dataset_v1$f.25014_vol_caudate_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25014_vol_caudate_R, na.rm = TRUE)

Full_dataset_v1$caudate <-
  (Full_dataset_v1$caudate - mean(Full_dataset_v1$caudate, na.rm = TRUE)) / sd(Full_dataset_v1$caudate, na.rm = TRUE)

Full_dataset_v1$f.25015_vol_putamen_L <-
  (Full_dataset_v1$f.25015_vol_putamen_L - mean(Full_dataset_v1$f.25015_vol_putamen_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25015_vol_putamen_L, na.rm = TRUE)

Full_dataset_v1$f.25016_vol_putamen_R <-
  (Full_dataset_v1$f.25016_vol_putamen_R - mean(Full_dataset_v1$f.25016_vol_putamen_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25016_vol_putamen_R, na.rm = TRUE)

Full_dataset_v1$putamen <-
  (Full_dataset_v1$putamen - mean(Full_dataset_v1$putamen, na.rm = TRUE)) / sd(Full_dataset_v1$putamen, na.rm = TRUE)

Full_dataset_v1$f.25017_vol_pallidum_L <-
  (Full_dataset_v1$f.25017_vol_pallidum_L - mean(Full_dataset_v1$f.25017_vol_pallidum_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25017_vol_pallidum_L, na.rm = TRUE)

Full_dataset_v1$f.25018_vol_pallidum_R <-
  (Full_dataset_v1$f.25018_vol_pallidum_R - mean(Full_dataset_v1$f.25018_vol_pallidum_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25018_vol_pallidum_R, na.rm = TRUE)

Full_dataset_v1$pallidum <-
  (Full_dataset_v1$pallidum - mean(Full_dataset_v1$pallidum, na.rm = TRUE)) / sd(Full_dataset_v1$pallidum, na.rm = TRUE)

Full_dataset_v1$hippocampus <-
  (Full_dataset_v1$hippocampus - mean(Full_dataset_v1$hippocampus, na.rm = TRUE)) / sd(Full_dataset_v1$hippocampus, na.rm = TRUE)

Full_dataset_v1$f.25021_vol_amygdala_L <-
  (Full_dataset_v1$f.25021_vol_amygdala_L - mean(Full_dataset_v1$f.25021_vol_amygdala_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25021_vol_amygdala_L, na.rm = TRUE)

Full_dataset_v1$f.25022_vol_amygdala_R <-
  (Full_dataset_v1$f.25022_vol_amygdala_R - mean(Full_dataset_v1$f.25022_vol_amygdala_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25022_vol_amygdala_R, na.rm = TRUE)

Full_dataset_v1$amygdala <-
  (Full_dataset_v1$amygdala - mean(Full_dataset_v1$amygdala, na.rm = TRUE)) / sd(Full_dataset_v1$amygdala, na.rm = TRUE)

Full_dataset_v1$f.25023_vol_accumbens_L <-
  (Full_dataset_v1$f.25023_vol_accumbens_L - mean(Full_dataset_v1$f.25023_vol_accumbens_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.25023_vol_accumbens_L, na.rm = TRUE)

Full_dataset_v1$f.25024_vol_accumbens_R <-
  (Full_dataset_v1$f.25024_vol_accumbens_R - mean(Full_dataset_v1$f.25024_vol_accumbens_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.25024_vol_accumbens_R, na.rm = TRUE)

Full_dataset_v1$accumbens <-
  (Full_dataset_v1$accumbens - mean(Full_dataset_v1$accumbens, na.rm = TRUE)) / sd(Full_dataset_v1$accumbens, na.rm = TRUE)

#log transformed
Full_dataset_v1$f6348_Duration_trailA   <-  (Full_dataset_v1$f6348_Duration_trailA - mean(Full_dataset_v1$f6348_Duration_trailA, na.rm = TRUE)) / sd(Full_dataset_v1$f6348_Duration_trailA, na.rm = TRUE)

#log transformed
Full_dataset_v1$f6350_Duration_trailB <- (Full_dataset_v1$f6350_Duration_trailB - mean(Full_dataset_v1$f6350_Duration_trailB, na.rm = TRUE)) / sd(Full_dataset_v1$f6350_Duration_trailB, na.rm = TRUE)

Full_dataset_v1$TMTB_MINUS_TMTA <- (Full_dataset_v1$TMTB_MINUS_TMTA - mean(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)) / sd(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)

Full_dataset_v1$f6373_matrix_pattern_puzzles_solved   <- (Full_dataset_v1$f6373_matrix_pattern_puzzles_solved - mean(Full_dataset_v1$f6373_matrix_pattern_puzzles_solved, na.rm = TRUE)) / sd(Full_dataset_v1$f6373_matrix_pattern_puzzles_solved, na.rm = TRUE)

Full_dataset_v1$f23324_correct_symbol_digit_matches <- (Full_dataset_v1$f23324_correct_symbol_digit_matches - mean(Full_dataset_v1$f23324_correct_symbol_digit_matches, na.rm = TRUE)) / sd(Full_dataset_v1$f23324_correct_symbol_digit_matches, na.rm = TRUE)

#log + 1
Full_dataset_v1$f.399.2.2_Memory_pm_6pairs <- (Full_dataset_v1$f.399.2.2_Memory_pm_6pairs - mean(Full_dataset_v1$f.399.2.2_Memory_pm_6pairs, na.rm = TRUE)) / sd(Full_dataset_v1$f.399.2.2_Memory_pm_6pairs, na.rm = TRUE)

Full_dataset_v1$f.20016.2.0_fluid_intelligence    <- (Full_dataset_v1$f.20016.2.0_fluid_intelligence - mean(Full_dataset_v1$f.20016.2.0_fluid_intelligence, na.rm = TRUE)) / sd(Full_dataset_v1$f.20016.2.0_fluid_intelligence, na.rm = TRUE)

#log
Full_dataset_v1$f.20023.2.0_reaction_time <- (Full_dataset_v1$f.20023.2.0_reaction_time - mean(Full_dataset_v1$f.20023.2.0_reaction_time, na.rm = TRUE)) / sd(Full_dataset_v1$f.20023.2.0_reaction_time, na.rm = TRUE)

# tower rearranging

Full_dataset_v1$`21004_correct_tower_arranging` <- (Full_dataset_v1$`21004_correct_tower_arranging` - mean(Full_dataset_v1$`21004_correct_tower_arranging`, na.rm = TRUE)) / sd(Full_dataset_v1$`21004_correct_tower_arranging`, na.rm = TRUE)

# Full_dataset_v1$TMTB_MINUS_TMTA
Full_dataset_v1$TMTB_MINUS_TMTA <- (Full_dataset_v1$TMTB_MINUS_TMTA - mean(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)) / sd(Full_dataset_v1$TMTB_MINUS_TMTA, na.rm = TRUE)

# continuous predictors

#age at assessment
Full_dataset_v1$Age_at_assessment_unstadardized <- Full_dataset_v1$Age_at_assessment  
Full_dataset_v1$Age_at_assessment <- (Full_dataset_v1$Age_at_assessment - mean(Full_dataset_v1$Age_at_assessment, na.rm = TRUE)) / sd(Full_dataset_v1$Age_at_assessment, na.rm = TRUE)

#length of hypertension
Full_dataset_v1$length_of_hypertension_self_reported_unstandardized <- Full_dataset_v1$length_of_hypertension_self_reported

Full_dataset_v1$length_of_hypertension_self_reported <- (Full_dataset_v1$length_of_hypertension_self_reported - mean(Full_dataset_v1$length_of_hypertension_self_reported, na.rm = TRUE)) / sd(Full_dataset_v1$length_of_hypertension_self_reported, na.rm = TRUE)


#length of hypertension including those those with not 
Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive <- Full_dataset_v1$length_of_hypertension_self_reported 

# there are 342 people with length of hypertension set to 0 we need to readjust these so they dont get lost in the normatensive group - set them to 0.5 (6 months)
Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive[
  Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive == 0 ] <- 0.5
# replace those who are normatensive with a zero
Full_dataset_v1$length_of_hypertension_self_reported_with_normatensive[
  Full_dataset_v1$hypertension != 1 ] <- 0


# head size scaling variable
Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space_unstandardized <- 
Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space

Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space <- (Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space - mean(Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space, na.rm = TRUE)) / sd(Full_dataset_v1$f.25000_Volumetric_scaling_T1_head_space, na.rm = TRUE)

# BMI
Full_dataset_v1$BMI_unstandardized <- 
Full_dataset_v1$BMI

Full_dataset_v1$BMI <- (Full_dataset_v1$BMI - mean(Full_dataset_v1$BMI, na.rm = TRUE)) / sd(Full_dataset_v1$BMI, na.rm = TRUE)


# hippo whole

Full_dataset_v1$FS_hippocampal_whole <-
  (Full_dataset_v1$FS_hippocampal_whole - mean(Full_dataset_v1$FS_hippocampal_whole, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_whole, na.rm = TRUE)

Full_dataset_v1$f.26641_whole_hippo_L <-
  (Full_dataset_v1$f.26641_whole_hippo_L - mean(Full_dataset_v1$f.26641_whole_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26641_whole_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26663_whole_hippo_R <-
  (Full_dataset_v1$f.26663_whole_hippo_R - mean(Full_dataset_v1$f.26663_whole_hippo_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.26663_whole_hippo_R, na.rm = TRUE)

# hippo head

Full_dataset_v1$FS_hippocampal_head <-
  (Full_dataset_v1$FS_hippocampal_head - mean(Full_dataset_v1$FS_hippocampal_head, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_head, na.rm = TRUE)

Full_dataset_v1$f.26640_head_hippo_L <-
  (Full_dataset_v1$f.26640_head_hippo_L - mean(Full_dataset_v1$f.26640_head_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26640_head_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26662_head_hippo_R <-
  (Full_dataset_v1$f.26662_head_hippo_R  - mean(Full_dataset_v1$f.26662_head_hippo_R , na.rm = TRUE)) / sd(Full_dataset_v1$f.26662_head_hippo_R , na.rm = TRUE)

# hippo tail

Full_dataset_v1$FS_hippocampal_tail <-
  (Full_dataset_v1$FS_hippocampal_tail - mean(Full_dataset_v1$FS_hippocampal_tail, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_tail, na.rm = TRUE)

Full_dataset_v1$f.26620_tail_hippo_L <-
  (Full_dataset_v1$f.26620_tail_hippo_L - mean(Full_dataset_v1$f.26620_tail_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26620_tail_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26642_tail_hippo_R <-
  (Full_dataset_v1$f.26642_tail_hippo_R - mean(Full_dataset_v1$f.26642_tail_hippo_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.26642_tail_hippo_R, na.rm = TRUE)

# hippo body

Full_dataset_v1$FS_hippocampal_body <-
  (Full_dataset_v1$FS_hippocampal_body - mean(Full_dataset_v1$FS_hippocampal_body, na.rm = TRUE)) / sd(Full_dataset_v1$FS_hippocampal_body, na.rm = TRUE)

Full_dataset_v1$f.26639_body_hippo_L <-
  (Full_dataset_v1$f.26639_body_hippo_L - mean(Full_dataset_v1$f.26639_body_hippo_L, na.rm = TRUE)) / sd(Full_dataset_v1$f.26639_body_hippo_L, na.rm = TRUE)

Full_dataset_v1$f.26661_body_hippo_R <-
  (Full_dataset_v1$f.26661_body_hippo_R - mean(Full_dataset_v1$f.26661_body_hippo_R, na.rm = TRUE)) / sd(Full_dataset_v1$f.26661_body_hippo_R, na.rm = TRUE)


save(Full_dataset_v1, file = paste(saving_directory,"Full_dataset_02032021_v1.Rdata", sep =""))


```





### Associations between isolated blood pressure and brain volumes

#relationship between blood pressure and age
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

load(file = paste(saving_directory,"Full_dataset_02032021_v1.Rdata", sep =""))

b <- ggplot(Full_dataset_v1, aes(x = Age_at_assessment_unstadardized, y = Systolic_bp_2)) + geom_point() +
  geom_smooth(method = "loess") +
 # ylim(120, 160) +
  #xlim(45, 85) +
  ggtitle("Relationship between Systolic blood pressure and Age in UKBiobank (n= 31,513)") +
  ylab("Average Systolic BP (mmHg)") + xlab("Age (Years)")



c <- ggplot(Full_dataset_v1, aes(x = Age_at_assessment_unstadardized, y = Diastolic_bp_2)) + geom_point() +
  geom_smooth(method = "loess") + 
  # ylim(70, 90) +
  # xlim(45, 85) +
  ggtitle("Relationship between Diastolic blood pressure\nand Age in UKBiobank (n= 31,513)") +
  ylab("Average Diastolic BP (mmHg)") + xlab("Age (Years)")


```


# Comparing normotensive, ISH, IDH and essential hypertension with brain volumes not split by medication use
Plot shows the importance of splitting by medication use which is effecting the results and also remove systematic error from the results

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}


# TOTAL BRAIN VOLUME
# removing undiagnosed hypertension from analysis
model <- glm(`f.25010_Volbrain_grey+white matter` ~ as.factor(isolated_systolic_hypertension) + 
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               BP_medications +
               f.25000_Volumetric_scaling_T1_head_space +
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition` 
             ,
  
  data = Full_dataset_v1 , family = gaussian
)

model1 <- summary(model)$coefficients
model1_confint <- na.omit(confint(model))
model1 <- cbind(model1, model1_confint)
model1 <- as.data.frame(model1)
model1$n <- rep(nobs(model), nrow(model1))

## add in FDR correction
model1$`Pr(>|t|)` <- p.adjust(model1$`Pr(>|t|)`, method = "fdr", n = nrow(model1) )


# WMH 
### results indicate that larger WMH in those with hypertension
#removing people with undiagnised hypertension
model <- glm(f.25781_WMH_LOG ~  as.factor(isolated_systolic_hypertension) +
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               f.25000_Volumetric_scaling_T1_head_space +
               BP_medications +
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition`  ,
             
  
  data = Full_dataset_v1 , family = gaussian
)

model2 <- summary(model)$coefficients
model2_confint <- na.omit(confint(model))
model2 <- cbind(model2, model2_confint)
model2 <- as.data.frame(model2)

## add in FDR correction
model2$`Pr(>|t|)` <- p.adjust(model2$`Pr(>|t|)`, method = "fdr", n = nrow(model2) )
model2$n <- rep(nobs(model), nrow(model2))

##################
# L hippocampus ##
##################
model <- glm(f.25019_vol_hippocampus_L ~  as.factor(isolated_systolic_hypertension) +
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               f.25000_Volumetric_scaling_T1_head_space +
               BP_medications +
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition`  ,
             
  data = Full_dataset_v1 , family = gaussian
)

model3 <- summary(model)$coefficients
model3_confint <- na.omit(confint(model))
model3 <- cbind(model3, model3_confint)
model3 <- as.data.frame(model3)

## add in FDR correction
model3$`Pr(>|t|)` <- p.adjust(model3$`Pr(>|t|)`, method = "fdr", n = nrow(model3) )
model3$n <- rep(nobs(model), nrow(model3))



model <- glm(f.25020_vol_hippocampus_R ~  as.factor(isolated_systolic_hypertension) +
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               f.25000_Volumetric_scaling_T1_head_space +
               BP_medications +
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition` ,
             
  
  data = Full_dataset_v1 , family = gaussian
)

model4 <- summary(model)$coefficients
model4_confint <- na.omit(confint(model))
model4 <- cbind(model4, model4_confint)
model4 <- as.data.frame(model4)

## add in FDR correction
model4$`Pr(>|t|)` <- p.adjust(model4$`Pr(>|t|)`, method = "fdr", n = nrow(model4) )
model4$n <- rep(nobs(model), nrow(model4))



########################################
# VENTRICULAR CSF
############################################
model <- glm(f.25004_vol_ventricular_CSF ~   as.factor(isolated_systolic_hypertension) +
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               f.25000_Volumetric_scaling_T1_head_space +
               BP_medications +
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition` ,
  
  data = Full_dataset_v1 , family = gaussian
)

model5 <- summary(model)$coefficients
model5_confint <- na.omit(confint(model))
model5 <- cbind(model5, model5_confint)
model5 <- as.data.frame(model5)

## add in FDR correction
model5$`Pr(>|t|)` <- p.adjust(model5$`Pr(>|t|)`, method = "fdr", n = nrow(model5) )
model5$n <- rep(nobs(model), nrow(model5))


########################################
#GREY MATTER
#######################################

model <- glm(`f.25006_Volgrey matter` ~   as.factor(isolated_systolic_hypertension) +
               Age_at_assessment +
               as.factor(Education) +
               as.factor(smoking_status) +
               as.factor(Gender)*Age_at_assessment +
               as.factor(Gender)*poly(Age_at_assessment, 2) +
               as.factor(UKBB_centre) +
               BMI +
               as.factor(Ethnicity) +
               as.factor(diabetes) +
               as.factor(high_chol) +
               f.25000_Volumetric_scaling_T1_head_space +
               BP_medications +
               `25756-2_ScannerXposition`      +                    
               `25757-2.ScannerYposition`            +               
               `25758-2_ScannerZposition`     +                      
               `25759-2_Scannerposition` ,
             
  data = Full_dataset_v1 , family = gaussian
)

model6 <- summary(model)$coefficients
model6_confint <- na.omit(confint(model))
model6 <- cbind(model6, model6_confint)
model6 <- as.data.frame(model6)

## add in FDR correction
model6$`Pr(>|t|)` <- p.adjust(model6$`Pr(>|t|)`, method = "fdr", n = nrow(model6) )
model6$n <- rep(nobs(model), nrow(model6))



##########################################
## put the results together
##########################################

final_results <- rbind(model1, model2, model3, model4, model5, model6)

final_results2 <- final_results[c(2:4, 
                                  25:27, 
                                  48:50, 
                                  71:73, 
                                  94:96, 
                                  117:119 ),c(1,5,6,4,7)]

rownames(final_results2) <- c("Total Brain Volume: IDH",
                              "Total Brain Volume: ISH",
                              "Total Brain Volume: Essential",
                              "WMH: IDH",
                              "WMH: ISH",
                              "WMH: Essential",
                              "Hippocampus Left: IDH",
                              "Hippocampus Left: ISH",
                              "Hippocampus Left: Essential",
                              "Hippocampus Right: IDH",
                              "Hippocampus Right: ISH",
                              "Hippocampus Right: Essential",
                              "Ventricular CSF: IDH",
                              "Ventricular CSF: ISH",
                              "Ventricular CSF: Essential",
                              "Total Grey Matter: IDH",
                               "Total Grey Matter: ISH",
                               "Total Grey Matter: Essential"
                              )

colnames(final_results2) <- c("Estimate", "Lower","Upper" ,"P value", "n")

final_results3 <- round(final_results2, 4)


kable(final_results3, caption = "Association between brain volumes with IDH, ISH and essential") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)


 write.csv(final_results3, paste(saving_directory,"Analysis_A_brain_volumes.csv", sep =""), row.names = TRUE)


## create a table with the results

library(forcats)



###### forest plot for paper #######

final_results4 <- as.data.frame(final_results3)


# create columes for quintile numbers and brain volumes
Group <- rep(c("IDH", "ISH", "Essential"), 6)

Brain_vol <- rep(c("Total Brain Volume","WMH", "Hippocampal Left", "Hippocampal Right", "Ventricular CSF", "Total Grey Matter"),each = 3)


# fucntion to calculate the number of stars for the p values
makeStars <- function(x){
  stars <- c("****", "***", "**", "*", "")
  vec <- c(0, 0.0001, 0.001, 0.01, 0.05, 1)
  i <- findInterval(x, vec)
  stars[i]
}


# create variable for pstars
pstar <- makeStars(final_results4[,4])




# add in the x and y for position of the p value stars

x <- c(2.9, 1.9, 0.9,
       2.9, 1.9, 0.9,
       2.9, 1.9, 0.9,
       2.9, 1.9, 0.9,
       2.9, 1.9, 0.9,
       2.9, 1.9, 0.9)

y <- c(0.02,0.03,-0.0022, # total brain volume DONE
       0.175,0.14,0.258, # wmh goes from green to red
       0.28,-0.008,0.28, #hippocampal left
       0.005,-0.01,0.11, # hippocampal right
       0.051,0.1173,0.09, # ventricular CSF green to red
       0.0012,-0.050,-0.002 # total grey matter green to red
       
       )


# add new columns onto results
final_results4 <- cbind(final_results4, Group, Brain_vol, pstar, x, y)

# 
# final_results4$Group <- factor(final_results4$Group, levels = c("Low BP + BP med", "High BP no BP med", "High BP + BP med"))


# change the order

final_results4 <- final_results4[c(3,2,1,
                                   6,5,4,
                                   9,8,7,
                                   12,11,10,
                                   15,14,13,
                                   18,17,16


                                   ),]

###### plot


p = ggplot(final_results4,
    aes(x = fct_inorder(Group),y = Estimate, ymin = Lower, ymax = Upper ))+
    geom_pointrange(aes(col=Group))+
    geom_hline(aes(fill=Group),yintercept =0, linetype=2, colour = "gray57")+
    xlab('Brain Volumes')+ ylab("Standardized Beta \n(95% Confidence Interval)")+
    geom_errorbar(aes(ymin=Lower, ymax=Upper,col=Group),width=0.25,cex=1)+ 
    facet_wrap(~Brain_vol,strip.position="left",nrow=18,scales = "free_y") +
       theme(plot.title=element_text(size=10,face="bold"),
              # axis.title.x = element_text(hjust = -0.3) ,
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x=element_text(face="bold"),
        axis.title=element_text(size=10,face="bold"),
           # panel.background=element_rect(fill="white"),
    panel.border=element_rect(colour="black",size=0.5, fill= NA),
    strip.text.y.left = element_text(angle=360, vjust = 0.5) ,
    legend.text=element_text(size=8),
    legend.title=element_text(size=10),
    axis.line.x.bottom = element_line(colour = "black"),
    axis.line.y.left = element_line(colour = "black"),
    panel.margin=unit(.05, "lines"),
        strip.background = element_rect(color = "black", size = 0.5) ,
    
    
    legend.position=c(0.85,-0.25),
        legend.direction="horizontal",
        legend.justification=c(1, 0), 
        legend.key.width=unit(1, "lines"), 
        legend.key.height=unit(1, "lines"), 
        plot.margin = unit(c(1, 1, 3, 0.5), "lines"),
  
       panel.background = element_blank(), 
       panel.grid = element_blank(), 
       panel.spacing.x = unit(0,"line") ,
        strip.text.y = element_text(hjust=0,vjust = 1,angle=180,face="bold"))+
  
  geom_text(data = final_results4, aes(label = pstar) ,  size=3.5, x = final_results4$x, y = final_results4$y , parse = F) +
  
  
    coord_flip()



filesavelocation <- saving_directory


ggsave("Figure_A.jpeg", path = filesavelocation , device = "jpeg", width = 7.5, height = 5, dpi=300)


```

# ISOLATED BP ANALYSIS

**Analysis 1 SYSTOLIC:** Relationship between blood pressure and medications. In this analysis we are testing the associations between brain volumes and those with low bp, low bp but taking bp meds, high bp but not taking meds and high bp and not taking meds. The cut off for high bp was set at >140 for sys bp. The reference level is those with low bp and not taking bp meds. For the low bp groups (with and without medications) we also removed those with high diastolic bp.

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

load(file = paste(saving_directory,"Full_dataset_02032021_v1.Rdata", sep =""))

Full_dataset_v1 <- subset(Full_dataset_v1, Full_dataset_v1$people2exlcude == 0)

Full_dataset_v1$isolated_sys_hpt_with_drugs_1 <- Full_dataset_v1$isolated_sys_hpt_with_drugs

#remove those with high diastolic from groups 1 and 2 why? need to think about this - to remove mitigating factors of high diastolic

Full_dataset_v1$isolated_sys_hpt_with_drugs_1[Full_dataset_v1$Diastolic_bp_2 >= 90 
                                              
                                              ] <- NA




# 1 low bp no meds
# 2 high bp no med
# 3 low bp + bp meds
# 4 high bp + bp meds

#create function


  

#total brain volume
model1 <- model_IH(
  outcome = Full_dataset_v1$`f.25010_Volbrain_grey+white matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Total Brain Volume",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

#total grey
model2 <- model_IH(
  outcome = Full_dataset_v1$`f.25006_Volgrey matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Total Grey Volume",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# WMH

model3 <- model_IH(
  outcome = Full_dataset_v1$f.25781_WMH_LOG ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "WMH",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#CSF
model4 <- model_IH(
  outcome = Full_dataset_v1$f.25004_vol_ventricular_CSF ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Ventricular CSF",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$thalamus ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$caudate ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Caudate",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$putamen ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Putamen",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$pallidum ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$hippocampus ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$amygdala ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$accumbens ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#gfa

model12 <- model_IH(
  outcome = Full_dataset_v1$gFA ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "gFA",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#gmd

model13 <- model_IH(
  outcome = Full_dataset_v1$gMD ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "gMD",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))




#stick all results together
final_results <- rbind(model1,
                       model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )


final_results2 <- final_results[c(1:25, 36:45, 51:65), ]

#final_results2 <- final_results

#split up : total brain volumes and latent factor variables
forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure1.png"),
          font_family = "Fira Sans",
          xlim = c(-0.2, 0.3),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          width_nudge = 1,
          nudge_y = -0.45
          
)


#putamen and caudate no area significant therefore not included

 write.csv(final_results, paste(saving_directory,"Analysis1_ISH_norm_brain_volumes.csv", sep =""), row.names = TRUE)
 
 
###### POSTER FIGURES #######
 
# final_results2b <- final_results2[c(
#   
#   6,7, 9,10,
#   11,12, 14,15,
#   16, 17, 19,20,
#   36, 37, 39,40,
#   41, 42, 44, 45,
#   46, 47, 49, 50,
#   51, 52, 54, 55), ]
#  
#  
# final_results2b$Description <-  c( "Total Grey Volume (n =26431)",
#                                   "   Normotensive"  ,
#                                   "   ISH - BP Meds"       ,
#   "   ISH + BP Meds"    ,   
#   "WMH (n =25221)"     ,    
#   "   Normotensive"   ,
#  "   ISH - BP Meds"      ,   
#  "   ISH + BP Meds"    ,        
#  "Ventricular CSF (n =26309)"  ,
#  "   Normotensive"  ,
#  "   ISH - BP Meds"     ,      
#  "   ISH + BP Meds"   ,         
#  "Amygdala (n =26416)"   ,    
#  "   Normotensive"  ,
#  "   ISH - BP Meds"     ,       
#  "   ISH + BP Meds"         , 
#  "Accumbens (n =26421)"   ,   
#  "   Normotensive"   ,
#  "   ISH - BP Meds"    ,        
#  "   ISH + BP Meds"    ,      
#  "gFA (n =24919)"     ,         
#  "   Normotensive" ,  
#  "   ISH - BP Meds"   ,      
#  "   ISH + BP Meds"  ,          
#  "gMD (n =24919)"     ,     
#  "   Normotensive"  , 
#  "   ISH - BP Meds"    ,        
#  "   ISH + BP Meds"  )
#  
#  
# forester2(left_side_data = final_results2b[,1],
#           estimate = final_results2b$Estimate,
#           ci_low = final_results2b$`2.5 %`,
#           ci_high = final_results2b$`97.5 %`,
#           right_side_data = NULL,
#           file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/ISH_figure1_AAIC.png"),
#           font_family = "Fira Sans",
#           xlim = c(-0.2, 0.3),
#           stripe_colour = "skyblue1",
#           dpi = 1000 ,
#           refgpused = final_results2b$ref,
#           estimate_precision = 4,
#           pval = final_results2b$`Pr(>|t|)`,
#           pvalsthres = 0.05,
#           estimate_col_name = "Standardized Beta",
#           width_nudge = 1
#           
# )
   
####################################################################
# per FA and MD microstructure

##############################################################
 
#UF_FA
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Uncinate Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#STR_FA
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_FA ,
   exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#SLF_FA
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

#tr_FA
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

#ILF_FA
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#IFOF_FA
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Fronto-occipital Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))



#FMin_FA
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


# FMaj_FA
model9 <- model_IH(
  outcome = Full_dataset_v1$FMaj_FA ,
      exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


# CT_FA
model10 <- model_IH(
  outcome = Full_dataset_v1$CT_FA ,
     exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1)  ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal Tract",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


# CG_FA
model11 <- model_IH(
  outcome = Full_dataset_v1$CG_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate Gyrus part of Cingulum",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))



# AR_FA
model12 <- model_IH(
  outcome = Full_dataset_v1$AR_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))          
               
# ATR_FA
model13 <- model_IH(
  outcome = Full_dataset_v1$ATR_FA ,
      exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Anterior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))



#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results

# when all the results are not significant all the dots are black
forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure1_FA.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.4),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2
          
)


################################################################################
### individual MD regions
################################################################################

 
#UF_MD
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Uncinate Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#STR_MD
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#SLF_MD
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#tr_MD
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))



#ILF_MD
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#IFOF_MD
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Fronto-occipital Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#FMin_MD
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


# FMaj_MD
model9 <- model_IH(
  outcome = Full_dataset_v1$FMaj_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


# CT_MD
model10 <- model_IH(
  outcome = Full_dataset_v1$CT_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal Tract",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


# CG_MD
model11 <- model_IH(
  outcome = Full_dataset_v1$CG_MD ,
   exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate Gyrus part of Cingulum",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))




# AR_MD
model12 <- model_IH(
  outcome = Full_dataset_v1$AR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))
               
               
# ATR_MD
model13 <- model_IH(
  outcome = Full_dataset_v1$ATR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Anterior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))



#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results3 <- final_results

forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure1_MD.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.45),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2
          
)



```

**Analysis 1a SYSTOLIC:** As above but looking at left and right sub cortical volumes

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}


#LEFT

# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$f.25011_vol_thalamus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$f.25013_vol_caudate_L ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$f.25015_vol_putamen_L ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$f.25017_vol_pallidum_L ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$f.25019_vol_hippocampus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$f.25021_vol_amygdala_L ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$f.25023_vol_accumbens_L ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))




#RIGHT


# Thalamus
model12 <- model_IH(
  outcome = Full_dataset_v1$f.25012_vol_thalamus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# Caudate
model13 <- model_IH(
  outcome = Full_dataset_v1$f.25014_vol_caudate_R ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# putamen
model14 <- model_IH(
  outcome = Full_dataset_v1$f.25016_vol_putamen_R ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# pallidum
model15 <- model_IH(
  outcome = Full_dataset_v1$f.25018_vol_pallidum_R ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# hippocampus
model16 <- model_IH(
  outcome = Full_dataset_v1$f.25020_vol_hippocampus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# amygdala
model17 <- model_IH(
  outcome = Full_dataset_v1$f.25022_vol_amygdala_R ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))

# accumbens
model18 <- model_IH(
  outcome = Full_dataset_v1$f.25024_vol_accumbens_R ,
  exposure = as.factor(Full_dataset_v1$isolated_sys_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("ISH - BP Meds",
                     "Normotensive + BP Meds",
                     "ISH + BP Meds"
    
  ))


#stick all results together
final_results <- rbind(model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13,
                       model14,
                       model15,
                       model16,
                       model17,
                       model18
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )


final_results2 <- final_results[c(1:35), ]

#final_results2 <- final_results

#split up : total brain volumes and latent factor variables
forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure1a_LEFT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.2, 0.3),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          width_nudge = 1
          
)


final_results3 <- final_results[c(36:70), ]


#split up : total brain volumes and latent factor variables
forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure1a_RIGHT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.2, 0.3),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          width_nudge = 1
          
)

#putamen and caudate no area significant therefore not included

 write.csv(final_results, paste(saving_directory,"Analysis1_ISH_norm_brain_volumes_LEFT_RIGHT.csv", sep =""), row.names = TRUE)

```


**Analysis 2 DIASTOLIC:** Relationship between blood pressure and medications. In this analysis we are testing the associations between brain volumes and those with low bp, low bp but taking bp meds, high bp but not taking meds and high bp and not taking meds. The cut off for high bp was set at > 90 for dia bp. The reference level is those with low bp and not taking bp meds. For those in low bp groups we removed the high systolic bp.

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}


#total brain volume
model1 <- model_IH(
  outcome = Full_dataset_v1$`f.25010_Volbrain_grey+white matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Total Brain Volume",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

#total grey
model2 <- model_IH(
  outcome = Full_dataset_v1$`f.25006_Volgrey matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Total Grey Volume",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# WMH

model3 <- model_IH(
  outcome = Full_dataset_v1$f.25781_WMH_LOG ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "WMH",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#CSF
model4 <- model_IH(
  outcome = Full_dataset_v1$f.25004_vol_ventricular_CSF ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Ventricular CSF",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$thalamus ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$caudate ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Caudate",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$putamen ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Putamen",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$pallidum ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$hippocampus ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$amygdala ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$accumbens ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
                     
  ))

# gfa
model12 <- model_IH(
  outcome = Full_dataset_v1$gFA ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "gFA",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# gMD
model13 <- model_IH(
  outcome = Full_dataset_v1$gMD ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "gMD",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#stick all results together
final_results <- rbind(model1,
                       model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results[c(1:25, 36:45, 51:65), ]

#split up and remove caudate and putamen and amydgala

forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure2.png"),
          font_family = "Fira Sans",
          xlim = c(-0.3, 0.5),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.45
          
)

#output all results

 write.csv(final_results, paste(saving_directory,"Analysis2_IDH_norm_brain_volumes.csv", sep =""), row.names = TRUE)
 
 
 
 ###### POSTER FIGURES #######
#  
# final_results2b <- final_results2[c(
#   1,2, 4, 5,
#   6,7, 9,10,
#   11,12, 14,15,
# 21, 22, 24, 25,
#   36, 37, 39,40,
#   46, 47, 49, 50), ]
#  
#  
# final_results2b$Description <-  c( "Total Brain Volume (n =17277)",
#                                    "   Normotensive"   ,
#                                    "   IDH - BP Meds"       ,
#   "   IDH + BP Meds"         ,  
#  "Total Grey Volume (n =17279)" , 
#  "   Normotensive - BP Meds"    ,
#  "   IDH - BP Meds"          ,   
#  "   IDH + BP Meds"          ,   
#  "WMH (n =16506)"     ,
#  "   Normotensive"  , 
# "   IDH - BP Meds"          ,   
# "   IDH + BP Meds"     ,        
#  "Thalamus (n =17249)"         , 
# "   Normotensive"  , 
# "   IDH - BP Meds"        ,     
#  "   IDH + BP Meds"             ,
# "Accumbens (n =17273)"      , 
# "   Normotensive"    ,
#  "   IDH - BP Meds"           , 
# "   IDH + BP Meds"          ,  
#  "gMD (n =16250)"           ,   
# "   Normotensive" , 
# "   IDH - BP Meds"    ,         
#  "   IDH + BP Meds"  )
#  
#  
# forester2(left_side_data = final_results2b[,1],
#           estimate = final_results2b$Estimate,
#           ci_low = final_results2b$`2.5 %`,
#           ci_high = final_results2b$`97.5 %`,
#           right_side_data = NULL,
#           file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/IDH_figure2_AAIC.png"),
#           font_family = "Fira Sans",
#           xlim = c(-0.3, 0.4),
#           stripe_colour = "skyblue1",
#           dpi = 1000 ,
#           refgpused = final_results2b$ref,
#           estimate_precision = 4,
#           pval = final_results2b$`Pr(>|t|)`,
#           pvalsthres = 0.05,
#           estimate_col_name = "Standardized Beta",
#           width_nudge = 1
#           
# )
 
 #gFA and gMD microstructure
 
  
####################################################################
# per FA and MD microstructure

##############################################################
 
#UF_FA
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Uncinate Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#STR_FA
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_FA ,
   exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#SLF_FA
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

#tr_FA
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

#ILF_FA
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#IFOF_FA
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Fronto-occipital Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))



#FMin_FA
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# FMaj_FA
model9 <- model_IH(
  outcome = Full_dataset_v1$FMaj_FA ,
      exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# CT_FA
model10 <- model_IH(
  outcome = Full_dataset_v1$CT_FA ,
     exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1)  ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal Tract",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# CG_FA
model11 <- model_IH(
  outcome = Full_dataset_v1$CG_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate Gyrus part of Cingulum",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))



# AR_FA
model12 <- model_IH(
  outcome = Full_dataset_v1$AR_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))          
               
# ATR_FA
model13 <- model_IH(
  outcome = Full_dataset_v1$ATR_FA ,
      exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Anterior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))



#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results
#final_results2 <- final_results[c(1:20,51:65),]

#split up and remove caudate and putamen

# when all the results are not significant all the dots are black
forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure2_FA.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.4),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2
          
)


################################################################################
### individual MD regions
################################################################################

 
#UF_MD
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Uncinate Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#STR_MD
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#SLF_MD
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Superior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#tr_MD
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))



#ILF_MD
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Longitudinal Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#IFOF_MD
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Fronto-occipital Fasciculus",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))



#FMin_MD
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# FMaj_MD
model9 <- model_IH(
  outcome = Full_dataset_v1$FMaj_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# CT_MD
model10 <- model_IH(
  outcome = Full_dataset_v1$CT_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal Tract",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


# CG_MD
model11 <- model_IH(
  outcome = Full_dataset_v1$CG_MD ,
   exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate Gyrus part of Cingulum",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))




# AR_MD
model12 <- model_IH(
  outcome = Full_dataset_v1$AR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))
               
               
# ATR_MD
model13 <- model_IH(
  outcome = Full_dataset_v1$ATR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Anterior Thalamic Radiation",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))



#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results3 <- final_results

forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure2_MD.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.5),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2
          
)


 
 

```


**Analysis 2a DIASTOLIC:** As above but looking at left and right sides of sub cortical volumes
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}


#LEFT

# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$f.25011_vol_thalamus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$f.25013_vol_caudate_L ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$f.25015_vol_putamen_L ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$f.25017_vol_pallidum_L ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$f.25019_vol_hippocampus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$f.25021_vol_amygdala_L ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$f.25023_vol_accumbens_L ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Left",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))




#RIGHT


# Thalamus
model12 <- model_IH(
  outcome = Full_dataset_v1$f.25012_vol_thalamus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# Caudate
model13 <- model_IH(
  outcome = Full_dataset_v1$f.25014_vol_caudate_R ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# putamen
model14 <- model_IH(
  outcome = Full_dataset_v1$f.25016_vol_putamen_R ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# pallidum
model15 <- model_IH(
  outcome = Full_dataset_v1$f.25018_vol_pallidum_R ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# hippocampus
model16 <- model_IH(
  outcome = Full_dataset_v1$f.25020_vol_hippocampus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# amygdala
model17 <- model_IH(
  outcome = Full_dataset_v1$f.25022_vol_amygdala_R ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))

# accumbens
model18 <- model_IH(
  outcome = Full_dataset_v1$f.25024_vol_accumbens_R ,
  exposure = as.factor(Full_dataset_v1$isolated_dia_hpt_with_drugs_1) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Right",
  ref = "Normotensive - BP Meds",
  exposurelevels = c("IDH - BP Meds",
                     "Normotensive + BP Meds",
                     "IDH + BP Meds"
    
  ))


#stick all results together
final_results <- rbind(model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13,
                       model14,
                       model15,
                       model16,
                       model17,
                       model18
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )


final_results2 <- final_results[c(1:35), ]

#final_results2 <- final_results

#split up : total brain volumes and latent factor variables
forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure2a_LEFT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.35, 0.25),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          width_nudge = 1
          
)


final_results3 <- final_results[c(36:70), ]


#split up : total brain volumes and latent factor variables
forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure2a_RIGHT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.35, 0.25),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          width_nudge = 1
          
)



 write.csv(final_results, paste(saving_directory,"Analysis2a_IDH_norm_brain_volumes_LEFT_RIGHT.csv", sep =""), row.names = TRUE)

```


**Analysis 3 SYSTOLIC:** Comparing isolated hypertension with non isolated hypertension. We have 4 groups

    1) High systolic AND diastolic bp NOT TAKING bp meds
    2) High systolic AND diastolic bp TAKING bp meds
    3) High isolated systolic bp NOT TAKING bp meds
    4) High isolated systolic bp TAKING bp meds (REF)


```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth <- Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth

Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth[
  Full_dataset_v1$Diastolic_bp_2 >= 90 & 
    Full_dataset_v1$Systolic_bp_2 < 140
] <- NA


Full_dataset_v1$isolated_v_non_isolated_SYS <-
Full_dataset_v1$isolated_SYS_hpt_with_drugs_incboth

Full_dataset_v1$isolated_v_non_isolated_SYS[
  
  Full_dataset_v1$isolated_v_non_isolated_SYS == 0 |
    Full_dataset_v1$isolated_v_non_isolated_SYS == 5
    
  
] <- NA

Full_dataset_v1$isolated_v_non_isolated_SYS <- as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS)

# set ISH taking meds as reference level

Full_dataset_v1$isolated_v_non_isolated_SYS <- relevel(Full_dataset_v1$isolated_v_non_isolated_SYS, 4)


# TOTAL BRAIN VOLUME
# removing undiagnosed hypertension from analysis


model1 <- model_IH(
  outcome = Full_dataset_v1$`f.25010_Volbrain_grey+white matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Total Brain Volume",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#total grey
model2 <- model_IH(
  outcome = Full_dataset_v1$`f.25006_Volgrey matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Total Grey Volume",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# WMH

model3 <- model_IH(
  outcome = Full_dataset_v1$f.25781_WMH_LOG ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "WMH",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#CSF
model4 <- model_IH(
  outcome = Full_dataset_v1$f.25004_vol_ventricular_CSF ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Ventricular CSF",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$thalamus ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$caudate ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Caudate",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$putamen ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Putamen",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$pallidum ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$hippocampus ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$amygdala ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$accumbens ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# gfa
model12 <- model_IH(
  outcome = Full_dataset_v1$gFA ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "gFA",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# gMD
model13 <- model_IH(
  outcome = Full_dataset_v1$gMD ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "gMD",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))






#stick all results together
final_results <- rbind(model1,
                       model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results[c(1:25, 36:45, 51:65), ]

#split up and remove caudate and putamen

forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure3.png"),
          font_family = "Fira Sans",
          xlim = c(-0.2, 0.3),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta"
        
          
)

 write.csv(final_results, paste(saving_directory,"Analysis3_ISH_SDH_brain_volumes.csv", sep =""), row.names = TRUE)
 
 
 forester2(left_side_data = final_results[,1],
          estimate = final_results$Estimate,
          ci_low = final_results$`2.5 %`,
          ci_high = final_results$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure3_all.png"),
          font_family = "Fira Sans",
          xlim = c(-0.2, 0.3),
          stripe_colour = "gray92",
          refgpused = final_results$ref,
          estimate_precision = 4,
          pval = final_results$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
         nudge_y = -0.5

)
 
 
 ###### POSTER FIGURES #######
 
# final_results2b <- final_results2[c(6:35),]
#  
#  
# final_results2b$Description <-  c( 
#      
#  "Total Grey Volume (n =13285)" ,
#   "   ISH + BP Meds"        ,  
#  "   NIH + BP Meds"      ,      
#  "   NIH - BP Meds"     ,        
#  "   ISH - BP Meds"       ,   
# "WMH (n =12607)"         ,    
# "   ISH + BP Meds"   ,          
#  "   NIH + BP Meds"        , 
# "   NIH - BP Meds"      ,      
# "   ISH - BP Meds"     ,        
#  "Ventricular CSF (n =13195)" ,  
# "   ISH + BP Meds"      ,     
# "   NIH + BP Meds"       ,      
# "   NIH - BP Meds"           , 
# "   ISH - BP Meds"      ,       
# "Accumbens (n =13280)"  ,       
#  "   ISH + BP Meds"       ,   
# "   NIH + BP Meds"       ,      
# "   NIH - BP Meds"   ,          
# "   ISH - BP Meds"        , 
# "gFA (n =12546)"        ,      
# "   ISH + BP Meds"   ,          
# "   NIH + BP Meds"       ,    
# "   NIH - BP Meds"      ,     
# "   ISH - BP Meds"    ,         
# "gMD (n =12546)"         ,   
# "   ISH + BP Meds"      ,      
# "   NIH + BP Meds"   ,          
# "   NIH - BP Meds"        ,    
# "   ISH - BP Meds" 
#   
#   )
#  
#  
# forester2(left_side_data = final_results2b[,1],
#           estimate = final_results2b$Estimate,
#           ci_low = final_results2b$`2.5 %`,
#           ci_high = final_results2b$`97.5 %`,
#           right_side_data = NULL,
#           file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/ISH_figure3_AAIC.png"),
#           font_family = "Fira Sans",
#           xlim = c(-0.2, 0.3),
#           stripe_colour = "skyblue1",
#           dpi = 1000 ,
#           refgpused = final_results2b$ref,
#           estimate_precision = 4,
#           pval = final_results2b$`Pr(>|t|)`,
#           pvalsthres = 0.05,
#           estimate_col_name = "Standardized Beta",
#           width_nudge = 1
#           
# )
#    
# 

 
#   forester3(left_side_data = final_results[,1],
#           estimate = final_results$Estimate,
#           ci_low = final_results$`2.5 %`,
#           ci_high = final_results$`97.5 %`,
#           right_side_data = NULL,
#           file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/ISH_figure3_allsds.png"),
#           font_family = "Fira Sans",
#           xlim = c(-0.2, 0.3),
#           stripe_colour = "gray92",
#           refgpused = final_results$ref,
#           estimate_precision = 4,
#           pval = final_results$`Pr(>|t|)`,
#           pvalsthres = 0.05,
#            colour_dots = c("red", "blue"), #ns first then s afterwards?
#           estimate_col_name = "Standardized Beta",
#          nudge_y = -0.5
# 
# )
#  

 
 
####################################################################
# per FA and MD microstructure

##############################################################
 
#UF_FA
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Uncinate Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#STR_FA
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_FA ,
   exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Superior Thalamic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#SLF_FA
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Superior Longitudinal Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

#tr_FA
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Thalamic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#ILF_FA
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Longitudinal Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#IFOF_FA
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Fronto-occipital Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))



#FMin_FA
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


# FMaj_FA
model9 <- model_IH(
  outcome = Full_dataset_v1$FMaj_FA ,
      exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


# CT_FA
model10 <- model_IH(
  outcome = Full_dataset_v1$CT_FA ,
     exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS)  ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal Tract",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


# CG_FA
model11 <- model_IH(
  outcome = Full_dataset_v1$CG_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate Gyrus part of Cingulum",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))



# AR_FA
model12 <- model_IH(
  outcome = Full_dataset_v1$AR_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))          
               
# ATR_FA
model13 <- model_IH(
  outcome = Full_dataset_v1$ATR_FA ,
      exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Anterior Thalamic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))



#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results
#final_results2 <- final_results[c(1:20,51:65),]

#split up and remove caudate and putamen

# when all the results are not significant all the dots are black
forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure3_FA.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.4),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2
          
)


################################################################################
### individual MD regions
################################################################################

 
#UF_MD
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Uncinate Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#STR_MD
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Superior Thalamic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#SLF_MD
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Superior Longitudinal Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#tr_MD
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Thalamic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))



#ILF_MD
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Longitudinal Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


#IFOF_MD
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Inferior Fronto-occipital Fasciculus",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))



#FMin_MD
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


# FMaj_MD
model9 <- model_IH(
  outcome = Full_dataset_v1$FMaj_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


# CT_MD
model10 <- model_IH(
  outcome = Full_dataset_v1$CT_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal Tract",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))


# CG_MD
model11 <- model_IH(
  outcome = Full_dataset_v1$CG_MD ,
   exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate Gyrus part of Cingulum",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))




# AR_MD
model12 <- model_IH(
  outcome = Full_dataset_v1$AR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))
               
               
# ATR_MD
model13 <- model_IH(
  outcome = Full_dataset_v1$ATR_MD ,
    exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Anterior Thalamic Radiation",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))



#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results3 <- final_results
#final_results2 <- final_results[c(1:20,51:65),]

#split up and remove caudate and putamen

forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure3_MD.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.4),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2
          
)


```

**Analysis 3a systolic:** As above but looking at left and right sub cortical volumes separately not averaged

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

#LEFT


# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$f.25011_vol_thalamus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Left",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$f.25013_vol_caudate_L ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Left",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$f.25015_vol_putamen_L ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Left",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$f.25017_vol_pallidum_L ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Left",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$f.25019_vol_hippocampus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Left",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$f.25021_vol_amygdala_L ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Left",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$f.25023_vol_accumbens_L ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Left",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))



# RIGHT


# Thalamus
model12 <- model_IH(
  outcome = Full_dataset_v1$f.25012_vol_thalamus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Right",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# Caudate
model13 <- model_IH(
  outcome = Full_dataset_v1$f.25014_vol_caudate_R ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Right",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# putamen
model14 <- model_IH(
  outcome = Full_dataset_v1$f.25016_vol_putamen_R ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Right",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# pallidum
model15 <- model_IH(
  outcome = Full_dataset_v1$f.25018_vol_pallidum_R ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Right",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# hippocampus
model16 <- model_IH(
  outcome = Full_dataset_v1$f.25020_vol_hippocampus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Right",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# amygdala
model17 <- model_IH(
  outcome = Full_dataset_v1$f.25022_vol_amygdala_R ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Right",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))

# accumbens
model18 <- model_IH(
  outcome = Full_dataset_v1$f.25024_vol_accumbens_R ,
  exposure = as.factor(Full_dataset_v1$isolated_v_non_isolated_SYS) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Right",
  ref = "ISH + BP Meds",
  exposurelevels = c("SDH - BP Meds",
                     "SDH + BP Meds",
                     "ISH - BP Meds"
    
  ))








#stick all results together
final_results <- rbind(model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13,
                       model14,
                       model15,
                       model16,
                       model17,
                       model18
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results[c(1:35),]

#split up and remove caudate and putamen

forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure3a_LEFT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.2, 0.3),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta"
        
          
)

 write.csv(final_results, paste(saving_directory,"Analysis3_ISH_NIH_LEFT_AND_RIGHT_brain_volumes.csv", sep =""), row.names = TRUE)
 
 
 
 final_results3 <- final_results[c(36:70),]
 
 
 forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/ISH_figure3b_RIGHT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.2, 0.3),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta"
          
)
 
 
 

```

**Analysis 4 DIASTOLIC:** Comparing isolated hypertension with non isolated hypertension. We have 4 groups

    1) High systolic AND diastolic bp NOT TAKING bp meds
    2) High systolic AND diastolic bp TAKING bp meds
    3) High isolated diastolic bp NOT TAKING bp meds
    4) High isolated diastolic bp TAKING bp meds (REF)

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

# 1 equal SDH not taking BP meds
Full_dataset_v1$isolated_DIA_SDH <- as.integer(Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Systolic_bp_2 >=140)

#SDH and taking BP meds group 2
Full_dataset_v1$isolated_DIA_SDH[Full_dataset_v1$isolated_DIA_SDH == 1 & Full_dataset_v1$BP_medications == 1] <- 2
  

#IDH not taking BP meds group 3
Full_dataset_v1$isolated_DIA_SDH[Full_dataset_v1$Diastolic_bp_2 >= 90 & Full_dataset_v1$Systolic_bp_2 <140] <- 3

#IDH taking BP meds group 4
Full_dataset_v1$isolated_DIA_SDH[Full_dataset_v1$isolated_DIA_SDH == 3 & Full_dataset_v1$BP_medications == 1] <- 4


#remove normotensive group
Full_dataset_v1$isolated_DIA_SDH[Full_dataset_v1$isolated_DIA_SDH == 0] <- NA



Full_dataset_v1$isolated_DIA_SDH <- as.factor(Full_dataset_v1$isolated_DIA_SDH)

# set ISH taking meds as reference level

Full_dataset_v1$isolated_DIA_SDH <- relevel(Full_dataset_v1$isolated_DIA_SDH, 4)




model1 <- model_IH(
  outcome = Full_dataset_v1$`f.25010_Volbrain_grey+white matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Total Brain Volume",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#total grey
model2 <- model_IH(
  outcome = Full_dataset_v1$`f.25006_Volgrey matter` ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Total Grey Volume",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# WMH

model3 <- model_IH(
  outcome = Full_dataset_v1$f.25781_WMH_LOG ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "WMH",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#CSF
model4 <- model_IH(
  outcome = Full_dataset_v1$f.25004_vol_ventricular_CSF ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Ventricular CSF",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$thalamus ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$caudate ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Caudate",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$putamen ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Putamen",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$pallidum ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$hippocampus ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$amygdala ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$accumbens ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


model12 <- model_IH(
  outcome = Full_dataset_v1$gFA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "gFA",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


model13 <- model_IH(
  outcome = Full_dataset_v1$gMD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "gMD",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#stick all results together
final_results <- rbind(model1,
                       model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

#split up and remove caudate and putamen and amydgala (as these were not sig in first step)

final_results2 <- final_results[c(1:25,36:45,51:65),]


forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure4.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.45),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          estimate_col_name = "Standardized Beta"
          
)




################################################################

###################################################################
# per FA and MD microstructure

##############################################################
 
#UF_FA
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "uncinate fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#STR_FA
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "superior thalamic radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#SLF_FA
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Superior longitudinal fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#tr_FA
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "thalamic radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))



#ILF_FA
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "inferior longitudinal fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#IFOF_FA
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "inferior fronto-occipital fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))



#FMin_FA
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


# FMaj_FA
model8 <- model_IH(
  outcome = Full_dataset_v1$FMaj_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


# CT_FA
model9 <- model_IH(
  outcome = Full_dataset_v1$CT_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal tract",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


# CG_FA
model10 <- model_IH(
  outcome = Full_dataset_v1$CG_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate gyrus part of cingulum",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))




# AR_FA
model11 <- model_IH(
  outcome = Full_dataset_v1$AR_FA ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))
               
               
# ATR_FA
model12 <- model_IH(
  outcome = Full_dataset_v1$ATR_FA ,
    exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Anterior thalamic radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))




#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results
#final_results2 <- final_results[c(1:20,51:65),]

#split up and remove caudate and putamen

# when all the results are not significant all the dots are black
forester3(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure3_FA.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.4),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2,
          colour_dots = c("grey", "grey"), #ns first then s afterwards?
          
)


################################################################################
### individual MD regions
################################################################################

 
#UF_MD
model2 <- model_IH(
  outcome = Full_dataset_v1$UF_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "uncinate fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#STR_MD
model3 <- model_IH(
  outcome = Full_dataset_v1$STR_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "superior thalamic radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#SLF_MD
model4 <- model_IH(
  outcome = Full_dataset_v1$SLF_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Superior longitudinal fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#tr_MD
model5 <- model_IH(
  outcome = Full_dataset_v1$TR_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "thalamic radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))



#ILF_MD
model6 <- model_IH(
  outcome = Full_dataset_v1$ILF_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "inferior longitudinal fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


#IFOF_MD
model7 <- model_IH(
  outcome = Full_dataset_v1$IFOF_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "inferior fronto-occipital fasciculus",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))



#FMin_MD
model8 <- model_IH(
  outcome = Full_dataset_v1$FMin_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Minor",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


# FMaj_MD
model8 <- model_IH(
  outcome = Full_dataset_v1$FMaj_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Forceps Major",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


# CT_MD
model9 <- model_IH(
  outcome = Full_dataset_v1$CT_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Corticospinal tract",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))


# CG_MD
model10 <- model_IH(
  outcome = Full_dataset_v1$CG_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Cingulate gyrus part of cingulum",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))




# AR_MD
model11 <- model_IH(
  outcome = Full_dataset_v1$AR_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Acoustic Radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))
               
               
# ATR_MD
model12 <- model_IH(
  outcome = Full_dataset_v1$ATR_MD ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Anterior thalamic radiation",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))



#stick all results together
final_results <- rbind(model2,
                       model3,
                       model4,
                       model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results3 <- final_results
#final_results2 <- final_results[c(1:20,51:65),]

#split up and remove caudate and putamen

forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure3_MD.png"),
          font_family = "Fira Sans",
          xlim = c(-0.45, 0.45),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta",
          nudge_y = -0.2
          
)

```


**Analysis 4 DIASTOLIC:** as above but left and right sides only
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

#LEFT


# Thalamus
model5 <- model_IH(
  outcome = Full_dataset_v1$f.25011_vol_thalamus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Left",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# Caudate
model6 <- model_IH(
  outcome = Full_dataset_v1$f.25013_vol_caudate_L ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Left",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# putamen
model7 <- model_IH(
  outcome = Full_dataset_v1$f.25015_vol_putamen_L ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Left",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# pallidum
model8 <- model_IH(
  outcome = Full_dataset_v1$f.25017_vol_pallidum_L,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Left",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# hippocampus
model9 <- model_IH(
  outcome = Full_dataset_v1$f.25019_vol_hippocampus_L ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Left",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# amygdala
model10 <- model_IH(
  outcome = Full_dataset_v1$f.25021_vol_amygdala_L ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Left",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# accumbens
model11 <- model_IH(
  outcome = Full_dataset_v1$f.25023_vol_accumbens_L ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Left",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))



#RIGHT

# Thalamus
model12 <- model_IH(
  outcome = Full_dataset_v1$f.25012_vol_thalamus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Thalamus Right",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# Caudate
model13 <- model_IH(
  outcome = Full_dataset_v1$f.25014_vol_caudate_R ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Caudate Right",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# putamen
model14 <- model_IH(
  outcome = Full_dataset_v1$f.25016_vol_putamen_R ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Putamen Right",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# pallidum
model15 <- model_IH(
  outcome = Full_dataset_v1$f.25018_vol_pallidum_R,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Pallidum Right",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# hippocampus
model16 <- model_IH(
  outcome = Full_dataset_v1$f.25020_vol_hippocampus_R ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Hippocampus Right",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# amygdala
model17 <- model_IH(
  outcome = Full_dataset_v1$f.25022_vol_amygdala_R ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Amygdala Right",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))

# accumbens
model18 <- model_IH(
  outcome = Full_dataset_v1$f.25024_vol_accumbens_R ,
  exposure = as.factor(Full_dataset_v1$isolated_DIA_SDH) ,
  data = Full_dataset_v1,
  brainvol = "Accumbens Right",
  ref = "IDH + BP Med",
  exposurelevels = c("SDH - BP Med",
                     "SDH + BP Med",
                     "IDH - BP Med"
    
  ))



#stick all results together
final_results <- rbind(model5,
                       model6,
                       model7,
                       model8,
                       model9,
                       model10,
                       model11,
                       model12,
                       model13,
                       model14,
                       model15,
                       model16,
                       model17,
                       model18
                       
                       
                       )



final_results$Estimate <- round(final_results$Estimate, 4)
final_results$`2.5 %` <- round(final_results$`2.5 %`, 4)
final_results$`97.5 %` <- round(final_results$`97.5 %`, 4)
final_results$`Pr(>|t|)` <- round(final_results$`Pr(>|t|)`, 4)

final_results$Description <- ifelse(is.na(final_results$Estimate), 
                         final_results$Description,
                         paste0("   ", final_results$Description))

final_results <- tibble::as.tibble(final_results )

final_results2 <- final_results[c(1:35),]

#split up and remove caudate and putamen

forester2(left_side_data = final_results2[,1],
          estimate = final_results2$Estimate,
          ci_low = final_results2$`2.5 %`,
          ci_high = final_results2$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure4a_LEFT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.4, 0.4),
          stripe_colour = "gray92",
          refgpused = final_results2$ref,
          estimate_precision = 4,
          pval = final_results2$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta"
        
          
)

 write.csv(final_results, paste(saving_directory,"Analysis4_ISH_NIH_LEFT_AND_RIGHT_brain_volumes.csv", sep =""), row.names = TRUE)
 
 
 
 final_results3 <- final_results[c(36:70),]
 
 
 forester2(left_side_data = final_results3[,1],
          estimate = final_results3$Estimate,
          ci_low = final_results3$`2.5 %`,
          ci_high = final_results3$`97.5 %`,
          right_side_data = NULL,
          file_path = ("C:/Users/dnewby/Desktop/UKBB/Analysis/Isolated_bp/Updated_Analysis/IDH_figure4b_RIGHT.png"),
          font_family = "Fira Sans",
          xlim = c(-0.4, 0.4),
          stripe_colour = "gray92",
          refgpused = final_results3$ref,
          estimate_precision = 4,
          pval = final_results3$`Pr(>|t|)`,
          pvalsthres = 0.05,
          estimate_col_name = "Standardized Beta"
          
)


```





**Analysis 5a systolic** with BP medication interactions ** (reviewer comment)
One reviewer suggested looking at isolated hypertension with the interaction of BP medication however not sure this correct as medication use is a proxy for disease
```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

load(file = paste(saving_directory,"Full_dataset_02032021_v1.Rdata", sep =""))

Full_dataset_v1 <- subset(Full_dataset_v1, Full_dataset_v1$people2exlcude == 0)

Full_dataset_v1$isolated_sys_hpt_with_drugs_1 <- Full_dataset_v1$isolated_sys_hpt_with_drugs

#remove those with high diastolic from groups 1 and 2 why? need to think about this - to remove mitigating factors of high diastolic

Full_dataset_v1$isolated_sys_hpt_with_drugs_1[Full_dataset_v1$Diastolic_bp_2 >= 90 
                                              
                                              ] <- NA


Full_dataset_v1$isolated_sys_hpt_new <- Full_dataset_v1$isolated_sys_hpt_with_drugs_1

Full_dataset_v1$isolated_sys_hpt_new <- as.numeric(Full_dataset_v1$isolated_sys_hpt_new)

Full_dataset_v1$isolated_sys_hpt_new[Full_dataset_v1$isolated_sys_hpt_new == 3 ] <- 1

Full_dataset_v1$isolated_sys_hpt_new[Full_dataset_v1$isolated_sys_hpt_new == 4 ] <- 2

Full_dataset_v1$isolated_sys_hpt_new[Full_dataset_v1$isolated_sys_hpt_new == 1 ] <- 0
Full_dataset_v1$isolated_sys_hpt_new[Full_dataset_v1$isolated_sys_hpt_new == 2 ] <- 1

Full_dataset_v1$isolated_sys_hpt_new <- as.factor(Full_dataset_v1$isolated_sys_hpt_new)



# 1 low bp no meds
# 2 high bp no med
# 3 low bp + bp meds
# 4 high bp + bp meds
#create function

# Full_dataset_v1$`f.25010_Volbrain_grey+white matter`

# Full_dataset_v1$`f.25006_Volgrey matter` ,

#Full_dataset_v1$f.25781_WMH_LOG 

#Full_dataset_v1$f.25004_vol_ventricular_CSF

#Full_dataset_v1$thalamus

#Full_dataset_v1$caudate 

#Full_dataset_v1$putamen 

#Full_dataset_v1$pallidum 

#Full_dataset_v1$hippocampus 

#Full_dataset_v1$amygdala 

#Full_dataset_v1$accumbens

#Full_dataset_v1$gFA

#Full_dataset_v1$gMD

Full_dataset_v1$Education <- as.factor(Full_dataset_v1$Education)
Full_dataset_v1$smoking_status <- as.factor(Full_dataset_v1$smoking_status)
Full_dataset_v1$Gender <- as.factor(Full_dataset_v1$Gender)
Full_dataset_v1$UKBB_centre <- as.factor(Full_dataset_v1$UKBB_centre)
Full_dataset_v1$Ethnicity <- as.factor(Full_dataset_v1$Ethnicity)
Full_dataset_v1$diabetes <- as.factor(Full_dataset_v1$diabetes)
Full_dataset_v1$high_chol <- as.factor(Full_dataset_v1$high_chol)

Full_dataset_v1$xpos <- Full_dataset_v1$`25756-2_ScannerXposition`
Full_dataset_v1$ypos <- Full_dataset_v1$`25757-2.ScannerYposition` 
Full_dataset_v1$zpos <- Full_dataset_v1$`25758-2_ScannerZposition`
Full_dataset_v1$scanpos <- Full_dataset_v1$`25759-2_Scannerposition`


 model <- glm(Full_dataset_v1$hippocampus  ~  
                isolated_sys_hpt_new *BP_medications +
               Age_at_assessment +
               Education +
               smoking_status +
               Gender*Age_at_assessment +
               Gender*poly(Age_at_assessment, 2) +
               UKBB_centre +
               BMI +
               Ethnicity +
               diabetes +
               high_chol +
               f.25000_Volumetric_scaling_T1_head_space +
                Townsend_deciles +
scanpos +
  xpos +
ypos +
zpos
              ,
  
  data = Full_dataset_v1 , family = gaussian
)

model1 <- summary(model)$coefficients
model1_confint <- na.omit(confint(model))
model1 <- cbind(model1, model1_confint)
model1 <- as.data.frame(model1)

## add in FDR correction
model1$`Pr(>|t|)` <- p.adjust(model1$`Pr(>|t|)`, method = "fdr", n = nrow(model1) )
model1$n <- rep(nobs(model), nrow(model1))
model1$`t value` <- NULL
model1$`Std. Error` <- NULL

library(effects)
Inter.GPA.3 <- effect('isolated_sys_hpt_new*BP_medications ', model,
                        se=TRUE)
#Data Frame
Inter.GPA.3.DF<-as.data.frame(Inter.GPA.3)

# Relable them to put them back in order
Inter.GPA.3.DF$isolated_sys_hpt_new <- as.factor(c("No Isolated", "Isolated",
                                                   "No Isolated", "Isolated"
                                                   ) )
  
 Inter.GPA.3.DF$BP_medications <- as.factor(c("No BP Meds", "No BP Meds",
                                                   "BP Meds", "BP Meds"
                                                   ) )

#Create plot
Plot.GPA.3<-ggplot(data=Inter.GPA.3.DF, aes(x=isolated_sys_hpt_new, y=fit, group=BP_medications))+
    geom_line(size=2, aes(color=BP_medications))+
    geom_ribbon(aes(ymin=fit-se, ymax=fit+se,fill=BP_medications),alpha=.2)+
    ylab("Total Grey Volume")+
    xlab("Isolated BP Status")+
    ggtitle("Isolated BP and BP Meds as Total Grey Matter Predictors")+
    theme_bw()+
    theme(text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.direction = "horizontal",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position="top")
Plot.GPA.3


```

```{r sessioninfor}

sessionInfo()

```

